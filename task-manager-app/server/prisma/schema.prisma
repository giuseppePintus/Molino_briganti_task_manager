// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  username  String    @unique
  passwordHash String
  role      String    // 'master' or 'slave'
  image     String?   // URL or base64 encoded image for operators carousel
  createdAt DateTime  @default(now())
  
  createdTasks Task[] @relation("CreatedBy")
  assignedTasks Task[] @relation("AssignedTo")
  acceptedTasks Task[] @relation("AcceptedTasks")
  completedTasks Task[] @relation("CompletedBy")
  notes TaskNote[]
}

model Task {
  id                Int     @id @default(autoincrement())
  title             String
  description       String?
  scheduledAt       DateTime?
  originalScheduledAt DateTime?  // Data originale del task (mantiene la data iniziale anche se spostata)
  assignedOperator  User?   @relation("AssignedTo", fields: [assignedOperatorId], references: [id])
  assignedOperatorId Int?
  estimatedMinutes  Int?
  priority          String  @default("MEDIUM")  // LOW, MEDIUM, HIGH, URGENT
  color             String  @default("#FCD34D") // hex color
  
  // Ricorrenza
  recurring         Boolean @default(false)
  recurrenceType    String? // DAILY, WEEKLY, BIWEEKLY, MONTHLY, QUARTERLY, YEARLY, CUSTOM
  recurrenceEnd     DateTime?  // Data di fine ricorrenza
  parentTaskId      Int?  // ID del task ricorrente parent
  
  createdBy         User    @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdById       Int
  createdAt         DateTime @default(now())
  
  acceptedAt        DateTime?  // Quando l'operatore accetta il task
  acceptedBy        User?   @relation("AcceptedTasks", fields: [acceptedById], references: [id], onDelete: SetNull)
  acceptedById      Int?
  
  paused            Boolean @default(false)
  pausedAt          DateTime?
  
  completed         Boolean @default(false)
  completedBy       User?   @relation("CompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  completedById     Int?
  completedAt       DateTime?  // Ora di chiusura automatica
  actualMinutes     Int?
  
  notes             TaskNote[]
}

model TaskNote {
  id        Int     @id @default(autoincrement())
  task      Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    Int
  user      User    @relation(fields: [userId], references: [id])
  userId    Int
  note      String
  createdAt DateTime @default(now())
}