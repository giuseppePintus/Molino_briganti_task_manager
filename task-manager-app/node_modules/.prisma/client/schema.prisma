// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  passwordHash String
  role         String // 'master' or 'slave'
  image        String? // URL or base64 encoded image for operators carousel
  createdAt    DateTime @default(now())

  createdTasks   Task[]     @relation("CreatedBy")
  assignedTasks  Task[]     @relation("AssignedTo")
  acceptedTasks  Task[]     @relation("AcceptedTasks")
  completedTasks Task[]     @relation("CompletedBy")
  notes          TaskNote[]
}

model Task {
  id                 Int       @id @default(autoincrement())
  title              String
  description        String?
  scheduledAt        DateTime?
  assignedOperator   User?     @relation("AssignedTo", fields: [assignedOperatorId], references: [id])
  assignedOperatorId Int?
  estimatedMinutes   Int?
  priority           String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  color              String    @default("#FCD34D") // hex color

  // Ricorrenza
  recurring      Boolean   @default(false)
  recurrenceType String? // DAILY, WEEKLY, BIWEEKLY, MONTHLY, QUARTERLY, YEARLY, CUSTOM
  recurrenceEnd  DateTime? // Data di fine ricorrenza
  parentTaskId   Int? // ID del task ricorrente parent

  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdById Int
  createdAt   DateTime @default(now())

  acceptedAt   DateTime? // Quando l'operatore accetta il task
  acceptedBy   User?     @relation("AcceptedTasks", fields: [acceptedById], references: [id], onDelete: SetNull)
  acceptedById Int?

  paused   Boolean   @default(false)
  pausedAt DateTime?

  completed     Boolean   @default(false)
  completedBy   User?     @relation("CompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  completedById Int?
  completedAt   DateTime? // Ora di chiusura automatica
  actualMinutes Int?

  notes TaskNote[]
}

model TaskNote {
  id        Int      @id @default(autoincrement())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    Int
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  note      String
  createdAt DateTime @default(now())
}

// Modelli per gestione magazzino
model Article {
  id          Int      @id @default(autoincrement())
  code        String   @unique // es. F-0-SP35-5
  name        String // es. FARINA 0 SP35 da 5 kg
  description String?
  category    String? // Categoria (es. FARINE, SEMOLE, MANGIMI, ecc.)
  unit        String   @default("kg") // Unità di misura
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  inventory   Inventory?
  stockAlerts StockAlert[]
  orderItems  OrderItem[]
}

model Inventory {
  id            Int      @id @default(autoincrement())
  article       Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId     Int      @unique
  currentStock  Int      @default(0) // Quantità attuale in magazzino
  minimumStock  Int      @default(0) // Soglia minima per avviso
  reserved      Int      @default(0) // Quantità prenotata (assegnata a ordini non completati)
  shelfPosition String? // Posizione scaffale (es. A1.1)
  batch         String? // Lotto/Batch
  expiry        String? // Scadenza
  lastUpdated   DateTime @updatedAt
  notes         String?

  movements StockMovement[]
  alerts    StockAlert[]
}

model StockMovement {
  id          Int       @id @default(autoincrement())
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  inventoryId Int
  type        String // IN, OUT, ADJUSTMENT
  quantity    Int
  reason      String? // Motivo del movimento (es. ordine, reso, inventario)
  orderId     Int? // Collegamento a ordine se applicabile
  notes       String?
  createdAt   DateTime  @default(now())
  createdBy   Int // ID utente che ha fatto il movimento
}

model StockAlert {
  id           Int       @id @default(autoincrement())
  article      Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId    Int
  inventory    Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  inventoryId  Int
  alertType    String // LOW_STOCK, CRITICAL
  currentStock Int // Quantità al momento dell'avviso
  minimumStock Int // Soglia impostata
  isResolved   Boolean   @default(false)
  resolvedAt   DateTime?
  createdAt    DateTime  @default(now())

  @@index([isResolved])
  @@index([createdAt])
}

model OrderItem {
  id                Int      @id @default(autoincrement())
  orderId           Int // ID dell'ordine (nella tabella ordini)
  article           Article  @relation(fields: [articleId], references: [id], onDelete: Restrict)
  articleId         Int
  quantityOrdered   Int
  quantityDelivered Int      @default(0)
  unitPrice         Float?
  createdAt         DateTime @default(now())
}
