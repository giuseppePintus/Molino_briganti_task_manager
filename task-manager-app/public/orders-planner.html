<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Ordini - Molino Briganti</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ea580c;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header styles unified via css/common.css */

        /* Base button styles moved to css/common.css. Page keeps only contextual overrides. */

        .card {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .card {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 12px;
                border-radius: 6px;
            }
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        @media (max-width: 768px) {
            .card h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }
        }

        @media (max-width: 480px) {
            .card h2 {
                font-size: 14px;
                margin-bottom: 10px;
            }
        }

        .orders-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .order-card {
            background: #3d3d3d;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #4d4d4d;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.5);
            border-color: #5d5d5d;
        }

        @media (max-width: 768px) {
            .order-card {
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .order-card {
                padding: 10px;
            }
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .order-title {
            font-weight: 600;
            color: #e0e0e0;
              font-size: 20px;
        }

        @media (max-width: 768px) {
            .order-title {
                 font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .order-title {
                 font-size: 16px;
            }
        }

        .order-status {
            font-size: 15px;
            padding: 6px 10px;
            border-radius: 4px;
            background: #1e3a4d;
            color: #7dd3fc;
        }

        .order-status.pending {
            background: #4a3a1e;
            color: #fcd34d;
        }

        .order-status.completed {
            background: #1e3a2a;
            color: #86efac;
        }

        .order-details {
            font-size: 16px;
            color: #a0a0a0;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .order-details {
                 font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            .order-details {
                 font-size: 15px;
            }
        }

        .order-details p {
            margin: 5px 0;
        }

        .order-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .order-actions {
                gap: 6px;
            }

            .order-actions .btn {
                padding: 5px 8px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .order-actions {
                flex-direction: column;
                gap: 6px;
            }

            .order-actions .btn {
                padding: 6px 8px;
                font-size: 11px;
                width: 100%;
                justify-content: center;
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
            color: #e0e0e0;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #4d4d4d;
            border-radius: 6px;
            font-size: 14px;
            background: #3d3d3d;
            color: #e0e0e0;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 50px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            padding: 6px 10px;
            min-height: 16px;
            font-size: 11px;
            flex: 0 1 auto;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2d2d2d;
            padding: 3px 4px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-left: 4px solid var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 20px;
        }

        .stat-number {
            font-size: 12px;
            font-weight: bold;
            color: #e0e0e0;
            margin-bottom: 0px;
        }

        .stat-label {
            font-size: 8px;
            color: #a0a0a0;
        }

        /* Planner Actions (below stats) */
        .planner-actions {
            display: flex;
            gap: 10px;
            margin: 10px 0 20px 0;
            flex-wrap: wrap;
        }
        @media (max-width: 768px) {
            .planner-actions .btn { padding: 8px 12px; font-size: 13px; }
        }
        @media (max-width: 480px) {
            .planner-actions { gap: 8px; }
            .planner-actions .btn { flex: 1; justify-content: center; }
        }
        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 12px;
            }

            .stat-card {
                min-height: 18px;
                padding: 2px 3px;
            }

            .stat-number {
                font-size: 11px;
            }

            .stat-label {
                font-size: 7px;
            }
        }

        @media (max-width: 480px) {
            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
                gap: 10px;
            }

            .stat-card {
                min-height: 16px;
                padding: 2px 3px;
            }

            .stat-number {
                font-size: 10px;
            }

            .stat-label {
                font-size: 6px;
            }
        }

        .calendar-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 10px 0;
        }

        .calendar-header-day {
            font-weight: 700;
            text-align: center;
            padding: 6px;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            border-radius: 4px;
            font-size: 12px; /* match admin dashboard */
            color: #b0b0b0;
        }

        .calendar-day {
            border: 1px solid #4d4d4d;
            padding: 6px;
            min-height: 50px;
            border-radius: 4px;
            background: #3d3d3d;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            color: #b0b0b0;
            position: relative;
            overflow: hidden;
        }

        .calendar-day:hover {
            background: #4d4d4d;
        }

        .calendar-day.has-orders {
            background: #1e2a4d;
            border-color: var(--primary);
            position: relative;
        }

        .calendar-day.has-unassigned-orders {
            position: relative;
        }

        .calendar-day.has-unassigned-orders::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 18px 0 0 18px;
            border-color: transparent transparent transparent #ff9800;
            border-radius: 0 0 0 4px;
        }

        .calendar-day.has-orders::before {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 18px 18px;
            border-color: transparent transparent var(--primary) transparent;
            border-radius: 0 0 4px 0;
        }

        

        @media (max-width: 768px) {
            .calendar-day {
                min-height: 40px;
                padding: 6px;
                font-size: 16px;
            }
            
        }

        @media (max-width: 480px) {
            .calendar-day {
                min-height: 35px;
                padding: 3px;
                font-size: 9px;
            }
            
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #808080;
            font-size: 12px;
        }

        /* Desktop calendar header */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .calendar-btn-prev, .calendar-btn-next {
            padding: 8px 12px;
            font-size: 16px;
            min-width: 40px;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-title {
            margin: 0;
            color: #e0e0e0;
            font-size: 16px;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        @media (max-width: 480px) {
            /* Mobile: mantieni le frecce in riga come admin */
            .calendar-header {
                display: grid !important;
                grid-template-columns: 40px 1fr 40px;
                grid-template-rows: auto;
                align-items: center;
                gap: 8px;
                margin-bottom: 15px;
            }

            .calendar-btn-prev {
                grid-column: 1;
                grid-row: 1;
                width: 40px !important;
                height: 40px;
                padding: 0 !important;
                font-size: 18px !important;
                min-width: 40px !important;
                max-width: 40px !important;
                justify-self: start;
            }

            .calendar-title {
                grid-column: 2;
                grid-row: 1;
                font-size: 14px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 0;
                margin: 0 4px;
            }

            .calendar-btn-next {
                grid-column: 3;
                grid-row: 1;
                width: 40px !important;
                height: 40px;
                padding: 0 !important;
                font-size: 18px !important;
                min-width: 40px !important;
                max-width: 40px !important;
                justify-self: end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="images/logo INSEGNA.png" alt="Molino Briganti Logo">
                </div>
                <div class="header-title">
                    <h1>üì¶ Planner Ordini</h1>
                    <div class="user-info" id="userInfo"></div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="goBack()">‚Üê Indietro</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">0</div>
                <div class="stat-label">Ordini Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingOrders">0</div>
                <div class="stat-label">In Sospeso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedOrders">0</div>
                <div class="stat-label">Completati</div>
            </div>
        </div>

        <!-- Planner Actions moved below stats -->
        <div class="planner-actions">
            <button class="btn btn-primary" onclick="openOrderModal()">‚ûï Nuovo Ordine</button>
            <button class="btn btn-success" onclick="openTripsManager()">üöö Gestisci Viaggi</button>
            <button class="btn btn-warning" onclick="generateSampleOrders()">üîÑ Genera Dati</button>
        </div>

        <!-- Calendar -->
        <div class="card" style="padding: 12px;">
            <div class="calendar-header">
                <button class="btn btn-primary calendar-btn-prev" onclick="previousMonth()">‚óÄ</button>
                <h4 id="calendarMonthYear" class="calendar-title"></h4>
                <button class="btn btn-primary calendar-btn-next" onclick="nextMonth()">‚ñ∂</button>
            </div>
            <div id="calendarContainer" class="calendar-container">
                <!-- Calendar will be generated here -->
            </div>
        </div>

        <!-- Day Orders Card -->
        <div class="card" id="dayOrdersCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="dayOrdersTitle" style="margin: 0;">üìã Ordini del Giorno</h2>
                <button class="btn btn-secondary" onclick="closeDayOrdersCard()" style="padding: 6px 10px; min-height: auto;">‚úï Chiudi</button>
            </div>
            <div id="dayOrdersList" class="orders-grid">
                <!-- Orders for the selected day will be populated here -->
            </div>
        </div>

        <!-- Viaggi Section -->
        <div class="card" id="tripsSection" style="display: none;">
            <h2 style="display:flex;align-items:center;gap:6px;margin:0 0 15px 0;">üöö Viaggi <span id="tripsCount" style="font-size:11px;color:#a0a0a0;font-weight:400;"></span></h2>
            <div id="tripsGrid" class="orders-grid">
                <!-- Trips will appear here -->
            </div>
        </div>

        <!-- Unified Orders + Tasks -->
        <div class="card">
            <h2 style="display:flex;align-items:center;gap:6px;margin:0 0 15px 0;">üìã Ordini e Task <span id="tasksCount" style="font-size:11px;color:#a0a0a0;font-weight:400;"></span></h2>
            <div class="orders-grid" id="orderTasksGrid">
                <!-- Order generated tasks will appear here -->
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <h2>üìù Nuovo Ordine</h2>
            <form id="orderForm" onsubmit="saveOrder(event)">
                <div class="form-group">
                    <label for="orderClient">Cliente:</label>
                    <select id="orderClient" required onchange="updateClientInfo()">
                        <option value="">-- Seleziona Cliente --</option>
                    </select>
                    <div id="clientHoursInfo" style="margin-top: 8px; font-size: 12px; color: #86efac; display: none;">
                        <!-- Client hours will be displayed here -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="orderProduct">Articolo:</label>
                    <select id="orderProduct" required onchange="updateArticleInfo()">
                        <option value="">-- Seleziona Articolo --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderLotto">Lotto:</label>
                    <input type="text" id="orderLotto" readonly placeholder="Auto-compilato">
                </div>
                <div class="form-group">
                    <label for="orderRitiroConsegna">Ritiro/Consegna:</label>
                    <input type="text" id="orderRitiroConsegna" readonly placeholder="Auto-compilato">
                </div>
                <div class="form-group">
                    <label for="orderPosizione">Posizione Scaffale:</label>
                    <input type="text" id="orderPosizione" readonly placeholder="Auto-compilato">
                </div>
                <div class="form-group">
                    <label for="orderQuantity">Quantit√† (kg):</label>
                    <input type="number" id="orderQuantity" required min="0.1" step="0.1" placeholder="Quantit√† in kg">
                </div>
                <div class="form-group">
                    <label for="orderType">Tipo Ordine:</label>
                    <select id="orderType" required>
                        <option value="consegnato">üì¶ Consegnato</option>
                        <option value="ritira">üè™ Ritira Cliente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderDateTime">Data e Orario Consegna:</label>
                    <input type="datetime-local" id="orderDateTime" required>
                </div>
                <div class="form-group">
                    <label for="orderStatus">Stato:</label>
                    <select id="orderStatus" required>
                        <option value="pending">In Sospeso</option>
                        <option value="in_progress">In Lavorazione</option>
                        <option value="completed">Completato</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderNotes">Note:</label>
                    <textarea id="orderNotes" rows="3" placeholder="Note aggiuntive..."></textarea>
                </div>
                <div class="form-group">
                    <label>üîß Assegna Operatori (opzionale):</label>
                    <div id="orderOperatorsChecklist" style="display: flex; flex-direction: column; gap: 6px; padding: 8px; background: #3d3d3d; border-radius: 4px; border: 1px solid #4d4d4d;">
                        <!-- Checkboxes operatori generati dinamicamente -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let orders = [];
        let clienti = [];
        let articoli = [];
        let calendarDisplayMonth = new Date().getMonth();
        let calendarDisplayYear = new Date().getFullYear();
        // Tasks generati dagli ordini
        let orderTasks = [];
        // Operatori / Admin disponibili - caricati dall'API (come in admin-dashboard)
        let allOperators = [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let token = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        const API_URL = 'http://localhost:5000/api';
        
        // Sistema viaggi
        let trips = []; // Array di viaggi: {id, name, date, orderIds: [], sequence: []}
        
        // Log currentUser al caricamento
        console.log('üìã currentUser caricato:', currentUser);
        console.log('üîë Token:', token ? 'presente' : 'assente');

        // Carica operatori e admin dall'API (esattamente come in operators.html)
        async function loadOperators() {
            try {
                // Prova prima con localStorage se disponibile
                const cachedOperators = localStorage.getItem('cachedOperators');
                if (cachedOperators) {
                    try {
                        const cached = JSON.parse(cachedOperators);
                        // Se hanno il campo "role" (nuova cache con admin), usa la cache
                        if (cached.length > 0 && cached[0].role) {
                            // Riordina comunque: admin prima, operatori dopo
                            const admins = cached.filter(op => op.role === 'master').sort((a, b) => a.username.localeCompare(b.username));
                            const operators = cached.filter(op => op.role === 'slave').sort((a, b) => a.username.localeCompare(b.username));
                            allOperators = [...admins, ...operators];
                            console.log('‚úÖ Operatori caricati da cache locale (riordinati):', allOperators);
                            return;
                        } else {
                            // Cache vecchia, elimina e ricarica
                            localStorage.removeItem('cachedOperators');
                            console.log('‚ö†Ô∏è Cache vecchia eliminata, ricarica dall\'API');
                        }
                    } catch (e) {
                        console.warn('Cache corrotta, ricarica dall\'API');
                        localStorage.removeItem('cachedOperators');
                    }
                }
                
                console.log('üîÑ Caricamento operatori e admin dall\'API pubblica...');
                
                // Usa gli endpoint pubblici che NON richiedono autenticazione
                const operatorsResponse = await fetch(`${API_URL}/auth/operators/public`);
                const adminsResponse = await fetch(`${API_URL}/auth/admins/public`);

                console.log('Risposta API - Operators:', operatorsResponse.status, 'Admins:', adminsResponse.status);

                if (operatorsResponse.ok && adminsResponse.ok) {
                    const operators = await operatorsResponse.json();
                    const admins = await adminsResponse.json();
                    console.log('üìã Operatori ricevuti:', operators);
                    console.log('üìã Admin ricevuti:', admins);
                    // Ordina admin alfabeticamente
                    const sortedAdmins = admins.sort((a, b) => a.username.localeCompare(b.username));
                    // Ordina operatori alfabeticamente
                    const sortedOperators = operators.sort((a, b) => a.username.localeCompare(b.username));
                    // Combina: admin prima, poi operatori
                    allOperators = [...sortedAdmins, ...sortedOperators];
                    // Salva in cache
                    localStorage.setItem('cachedOperators', JSON.stringify(allOperators));
                    console.log('‚úÖ Operatori e Admin caricati dall\'API pubblica:', allOperators);
                } else {
                    console.warn('‚ö†Ô∏è Errore API (' + operatorsResponse.status + ', ' + adminsResponse.status + ') - usa default');
                    allOperators = [
                        { id: 1, username: 'Admin Mario', role: 'master' },
                        { id: 2, username: 'Admin Lucia', role: 'master' },
                        { id: 3, username: 'Operatore Paolo', role: 'operator' },
                        { id: 4, username: 'Operatore Sara', role: 'operator' }
                    ];
                }
            } catch (error) {
                console.error('‚ùå Errore caricamento operatori:', error);
                console.warn('Usa operatori di default');
                allOperators = [
                    { id: 1, username: 'Admin Mario', role: 'master' },
                    { id: 2, username: 'Admin Lucia', role: 'master' },
                    { id: 3, username: 'Operatore Paolo', role: 'operator' },
                    { id: 4, username: 'Operatore Sara', role: 'operator' }
                ];
            }
        }

        // Helper per ottenere array di nomi operatori
        function getOperatorNames() {
            return allOperators.map(op => op.username);
        }

        function getOperatorWithIcon(username) {
            const op = allOperators.find(o => o.username === username);
            if (!op) return username;
            const icon = op.role === 'master' ? 'üë®‚Äçüíº' : 'üë∑';
            const suffix = (currentUser.id === op.id) ? ' (per me)' : '';
            return icon + ' ' + username + suffix;
        }

        // Salvataggio / caricamento tasks
        function loadOrderTasks() {
            const stored = localStorage.getItem('orderTasks');
            orderTasks = stored ? JSON.parse(stored) : [];

            // Migrazioni: titoli e struttura ID DB
            try {
                let changed = false;
                // 1) Normalizza titoli a "consegna/ritiro - cliente"
                orderTasks.forEach(t => {
                    const relatedOrder = Array.isArray(orders) ? orders.find(o => o.id === t.orderId) : null;
                    let typeWord = 'consegna';
                    if (relatedOrder && relatedOrder.type) {
                        typeWord = relatedOrder.type === 'consegnato' ? 'consegna' : 'ritiro';
                    } else if (t.title && /ritiro/i.test(t.title)) {
                        typeWord = 'ritiro';
                    }
                    const clientLower = String((relatedOrder && relatedOrder.client) || t.client || '').toLowerCase();
                    const normalized = `${typeWord} - ${clientLower}`;
                    if (t.title !== normalized) {
                        t.title = normalized;
                        changed = true;
                    }
                });
                // 2) Normalizza tracking ID DB (evita duplicati)
                orderTasks.forEach(t => {
                    if (!t.dbIdsByOperator || typeof t.dbIdsByOperator !== 'object') {
                        t.dbIdsByOperator = {};
                        changed = true;
                    }
                    if (t.dbId && Array.isArray(t.assignedTo)) {
                        if (t.assignedTo.length === 0) {
                            if (!t.dbIdUnassigned) {
                                t.dbIdUnassigned = t.dbId;
                            }
                            delete t.dbId;
                            changed = true;
                        } else {
                            const first = t.assignedTo[0];
                            if (!t.dbIdsByOperator[first]) {
                                t.dbIdsByOperator[first] = t.dbId;
                            }
                            delete t.dbId;
                            changed = true;
                        }
                    }
                });
                if (changed) {
                    saveOrderTasks();
                }
            } catch (e) {
                console.warn('Migrazione task fallita:', e);
            }
        }
        function saveOrderTasks() {
            localStorage.setItem('orderTasks', JSON.stringify(orderTasks));
        }

        function generateTaskForOrder(order, assignedOperators = []) {
            // Evita duplicati se gi√† presente
            if (orderTasks.some(t => t.orderId === order.id)) return;
            const cliente = clienti.find(c => c.nome === order.client);
            const title = `${order.type === 'consegnato' ? 'consegna' : 'ritiro'} - ${String(order.client || '').toLowerCase()}`;
            
            // Crea task in memoria
            const newTask = {
                id: 'task-' + order.id,
                orderId: order.id,
                title,
                client: order.client,
                product: order.product,
                quantity: order.quantity,
                dateTime: order.dateTime,
                status: assignedOperators.length > 0 ? 'assigned' : 'unassigned',
                assignedTo: assignedOperators,
                autogenerated: true,
                notes: order.notes || '',
                clienteOrari: cliente ? {
                    apertura: cliente.orario_apertura,
                    chiusura: cliente.orario_chiusura,
                    consegna_inizio: cliente.orario_consegna_inizio,
                    consegna_fine: cliente.orario_consegna_fine
                } : null,
                createdAt: new Date().toISOString(),
                dbIdsByOperator: {},
                dbIdUnassigned: null
            };
            
            orderTasks.push(newTask);
            saveOrderTasks();
            
            // Strategia DB:
            // - "consegnato": crea subito un task non assegnato per visibilit√† admin
            // - "ritira": non creare qui; ci pensa l'upsert a evitare duplicati
            if (currentUser?.id && currentUser?.role === 'master') {
                if (order.type === 'consegnato') {
                    saveTaskToDatabase(newTask, []);
                }
            } else {
                console.warn('‚ö†Ô∏è Non loggato come admin - task solo locale');
            }
        }

        async function saveTaskToDatabase(task, assignedOperators) {
            try {
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                console.log('üîê Token in saveTaskToDatabase:', currentToken ? 'presente (' + currentToken.substring(0, 20) + '...)' : 'NULLO');
                if (!currentToken) {
                    console.warn('‚ö†Ô∏è Non loggato - task salvato solo localmente');
                    return;
                }
                
                // NON assegnare subito - lascialo come "da assegnare" per l'admin
                // Gli operatori suggeriti vanno nella descrizione
                const suggestedOps = assignedOperators.length > 0 ? `\nOperatori suggeriti: ${assignedOperators.join(', ')}` : '';
                
                const response = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        title: task.title,
                        description: `Cliente: ${task.client}\nProdotto: ${task.product}\nQuantit√†: ${task.quantity} kg\nNote: ${task.notes}${suggestedOps}`,
                        scheduledAt: task.dateTime,
                        assignedOperatorId: null,  // SEMPRE null - l'admin assegner√† dopo
                        estimatedMinutes: 60,
                        priority: 'MEDIUM'
                    })
                });
                
                if (response.ok) {
                    const savedTask = await response.json();
                    console.log('‚úÖ Task salvato nel database:', savedTask);
                    // Aggiorna l'id locale con quello del database
                    task.dbId = savedTask.id;
                } else {
                    console.warn('‚ö†Ô∏è Errore salvataggio task nel DB:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Errore:', error);
            }
        }

        // Helpers to sync 'ritiro' tasks to operators in backend so they appear in operator dashboards
        function getOperatorIdByUsername(username) {
            const op = allOperators.find(o => o.username === username);
            return op ? op.id : null;
        }

        async function updateDbTaskAssignedOperator(taskDbId, operatorId) {
            try {
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken || !taskDbId || !operatorId) return;
                await fetch(`${API_URL}/tasks/${taskDbId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ assignedOperatorId: operatorId })
                });
            } catch (e) {
                console.warn('Errore aggiornamento assegnazione task DB:', e);
            }
        }

        async function createDbTaskForOperator(task, operatorId) {
            try {
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken) return null;
                const resp = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        title: task.title,
                        description: `Cliente: ${task.client}\nProdotto: ${task.product}\nQuantit√†: ${task.quantity} kg\nNote: ${task.notes || ''}`,
                        scheduledAt: task.dateTime,
                        assignedOperatorId: operatorId || null,
                        estimatedMinutes: 60,
                        priority: 'MEDIUM'
                    })
                });
                if (resp.ok) {
                    const saved = await resp.json();
                    return saved;
                }
            } catch (e) {
                console.warn('Errore creazione task DB per operatore:', e);
            }
            return null;
        }

        async function deleteDbTask(taskDbId) {
            try {
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken || !taskDbId) return;
                await fetch(`${API_URL}/tasks/${taskDbId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
            } catch (e) {
                console.warn('Errore cancellazione task DB:', e);
            }
        }

        async function deleteBackendEntriesForTask(task) {
            try {
                // Elimina placeholder non assegnato
                if (task.dbIdUnassigned) {
                    await deleteDbTask(task.dbIdUnassigned);
                    task.dbIdUnassigned = null;
                }
                // Elimina mappature per operatore
                if (task.dbIdsByOperator && typeof task.dbIdsByOperator === 'object') {
                    for (const [username, id] of Object.entries(task.dbIdsByOperator)) {
                        if (id) await deleteDbTask(id);
                    }
                    task.dbIdsByOperator = {};
                }
                // Compat: elimina vecchio dbId singolo se presente
                if (task.dbId) {
                    await deleteDbTask(task.dbId);
                    delete task.dbId;
                }
            } catch (e) {
                console.warn('Errore cleanup backend task per ordine:', e);
            }
        }

        async function upsertRitiroTasksForOperators(task, selectedUsernames) {
            try {
                const relatedOrder = orders.find(o => o.id === task.orderId);
                if (!relatedOrder || relatedOrder.type !== 'ritira') return; // solo per ritiro
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken) return; // serve login admin per scrivere nel DB

                // Normalizza struttura di tracking
                if (!task.dbIdsByOperator || typeof task.dbIdsByOperator !== 'object') {
                    task.dbIdsByOperator = {};
                }
                const selected = Array.isArray(selectedUsernames) ? Array.from(new Set(selectedUsernames)) : [];
                const existingUsernames = Object.keys(task.dbIdsByOperator);

                const toId = (username) => getOperatorIdByUsername(username);

                if (selected.length === 0) {
                    // Nessun operatore selezionato: elimina task per-operator e crea/garantisci placeholder non assegnato
                    for (const u of existingUsernames) {
                        const id = task.dbIdsByOperator[u];
                        if (id) await deleteDbTask(id);
                    }
                    task.dbIdsByOperator = {};

                    // migra eventuale vecchio dbId
                    if (task.dbId && !task.dbIdUnassigned) {
                        task.dbIdUnassigned = task.dbId;
                        delete task.dbId;
                    }

                    if (!task.dbIdUnassigned) {
                        const created = await createDbTaskForOperator(task, null);
                        if (created?.id) task.dbIdUnassigned = created.id;
                    }
                    saveOrderTasks();
                    return;
                }

                // Almeno un operatore selezionato
                const firstUsername = selected[0];
                const firstOpId = toId(firstUsername);

                if (!task.dbIdsByOperator[firstUsername]) {
                    if (task.dbIdUnassigned) {
                        await updateDbTaskAssignedOperator(task.dbIdUnassigned, firstOpId);
                        task.dbIdsByOperator[firstUsername] = task.dbIdUnassigned;
                        task.dbIdUnassigned = null;
                    } else if (task.dbId) {
                        await updateDbTaskAssignedOperator(task.dbId, firstOpId);
                        task.dbIdsByOperator[firstUsername] = task.dbId;
                        delete task.dbId;
                    } else {
                        const created = await createDbTaskForOperator(task, firstOpId);
                        if (created?.id) task.dbIdsByOperator[firstUsername] = created.id;
                    }
                }

                // Garantisci task per gli altri operatori
                for (let i = 1; i < selected.length; i++) {
                    const u = selected[i];
                    if (task.dbIdsByOperator[u]) continue;
                    const opId = toId(u);
                    if (!opId) continue;
                    const created = await createDbTaskForOperator(task, opId);
                    if (created?.id) task.dbIdsByOperator[u] = created.id;
                }

                // Rimuovi task per operatori deselezionati
                for (const u of existingUsernames) {
                    if (!selected.includes(u)) {
                        const id = task.dbIdsByOperator[u];
                        if (id) await deleteDbTask(id);
                        delete task.dbIdsByOperator[u];
                    }
                }

                // Elimina eventuale placeholder residuo
                if (task.dbIdUnassigned) {
                    await deleteDbTask(task.dbIdUnassigned);
                    task.dbIdUnassigned = null;
                }

                saveOrderTasks();
            } catch (e) {
                console.warn('Errore upsert ritiro tasks per operatori:', e);
            }
        }

        // Admin-only background sync to ensure 'ritira' orders are visible to admins in backend
        async function syncRitiroOrdersToDb() {
            try {
                if (!currentUser?.id || currentUser?.role !== 'master') return;
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken) return;

                // Assicura task locali per tutti gli ordini "ritira"
                orders.filter(o => o.type === 'ritira').forEach(o => {
                    const existing = orderTasks.find(t => t.orderId === o.id);
                    if (!existing) {
                        generateTaskForOrder(o, []);
                    }
                });

                // Allinea ogni task "ritira" nel backend in base all'assegnazione corrente
                for (const t of orderTasks) {
                    const ord = orders.find(o => o.id === t.orderId);
                    if (!ord) continue;
                    if (ord.type === 'ritira') {
                        await upsertRitiroTasksForOperators(t, Array.isArray(t.assignedTo) ? t.assignedTo : []);
                    }
                }
            } catch (e) {
                console.warn('Errore syncRitiroOrdersToDb:', e);
            }
        }

        function renderOrderTasks() {
            const grid = document.getElementById('orderTasksGrid');
            const countSpan = document.getElementById('tasksCount');
            if (!grid) return;
            if (orderTasks.length === 0) {
                grid.innerHTML = '<p style="color:#808080;grid-column:1/-1;text-align:center;padding:20px;">Nessun task generato. Creando ordini compariranno qui.</p>';
                countSpan.textContent = '(0)';
                return;
            }
            countSpan.textContent = `(${orderTasks.length})`;
            grid.innerHTML = orderTasks.map(task => {
                const assigned = task.assignedTo.length > 0;
                const statusBadge = assigned ? '<span style="background:#1e3a2a;color:#86efac;padding:2px 6px;border-radius:4px;font-size:10px;">Assegnato</span>' : '<span style="background:#4a3a1e;color:#fcd34d;padding:2px 6px;border-radius:4px;font-size:10px;">Da assegnare</span>';
                const operatorsHtml = assigned ? `<p style=\"margin:4px 0;\"><strong>Assegnato a:</strong> ${task.assignedTo.join(', ')}</p>` : '';
                const timeOnly = task.dateTime ? new Date(task.dateTime).toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}) : 'N/D';
                const relatedOrder = orders.find(o => o.id === task.orderId);
                const displayTitle = (task.title && typeof task.title === 'string' && task.title.length > 0)
                    ? task.title
                    : `${(relatedOrder && relatedOrder.type === 'consegnato') ? 'consegna' : 'ritiro'} - ${String((relatedOrder && relatedOrder.client) || task.client || '').toLowerCase()}`;
                return `<div class=\"order-card\" style=\"border-left:4px solid ${assigned ? '#16a34a' : '#f59e0b'};background:${assigned ? '#1e2a4d' : '#1e2a4d'};border:2px solid ${assigned ? '#16a34a' : '#f59e0b'};\">\n  <div class=\"order-header\">\n    <div class=\"order-title\" style=\"font-size:20px;color:#7dd3fc;font-weight:700;margin-bottom:4px;\">${displayTitle}</div>\n    ${statusBadge}\n  </div>\n  <div class=\"order-details\" style=\"font-size:18px;line-height:1.8;margin-top:12px;\">\n    <p style=\"margin:8px 0;\"><strong style=\"color:#93c5fd;font-size:20px;\">üì¶ Prodotto:</strong> <span style=\"color:#e0e0e0;font-size:20px;font-weight:600;\">${task.product}</span></p>\n    <p style=\"margin:8px 0;\"><strong style=\"color:#93c5fd;font-size:20px;\">üìä Quantit√†:</strong> <span style=\"color:#fcd34d;font-size:22px;font-weight:700;\">${task.quantity} kg</span></p>\n    <p style=\"margin:8px 0;\"><strong style=\"color:#93c5fd;font-size:20px;\">‚è∞ Orario Programmato:</strong> <span style=\"color:#86efac;font-size:22px;font-weight:700;\">${timeOnly}</span></p>\n    ${operatorsHtml}\n  </div>\n  <div class=\"order-actions\" style=\"display:flex;gap:6px;justify-content:flex-end;margin-top:15px;flex-wrap:wrap;\">\n    <button class=\"btn btn-warning\" onclick=\"openAssignTaskModal('${task.id}')\" style=\"padding:6px 10px;font-size:12px;\">üîß Assegna</button>\n    <button class=\"btn btn-primary\" onclick=\"markTaskCompleted('${task.id}')\" style=\"padding:6px 10px;font-size:12px;\">‚úì Completa</button>\n    <button class=\"btn btn-secondary\" onclick=\"openEditOrderModal(${task.orderId})\" style=\"padding:6px 10px;font-size:12px;\">‚úèÔ∏è Modifica</button>\n    <button class=\"btn btn-danger\" onclick=\"deleteOrderTask('${task.id}')\" style=\"padding:6px 10px;font-size:12px;\">üóëÔ∏è Elimina</button>\n  </div>\n</div>`;
            }).join('');
        }

        function openAssignTaskModal(taskId) {
            const modal = document.getElementById('assignTaskModal');
            const list = document.getElementById('operatorsChecklist');
            document.getElementById('assignTaskId').value = taskId;
            list.innerHTML = allOperators.map(op => {
                const task = orderTasks.find(t => t.id === taskId);
                const checked = task && task.assignedTo.includes(op.username) ? 'checked' : '';
                const icon = op.role === 'master' ? 'üë®‚Äçüíº' : 'üë∑';
                const suffix = (currentUser.id === op.id) ? ' (per me)' : '';
                return `<label style=\"display:flex;align-items:center;gap:6px;font-size:12px;margin:4px 0;\"><input type=\"checkbox\" value=\"${op.username}\" ${checked}> <span>${icon} ${op.username}${suffix}</span></label>`;
            }).join('');
            modal.classList.add('active');
        }
        function closeAssignTaskModal() {
            document.getElementById('assignTaskModal').classList.remove('active');
        }
        function assignTaskToOperators(e) {
            e.preventDefault();
            const taskId = document.getElementById('assignTaskId').value;
            const checkboxes = Array.from(document.querySelectorAll('#operatorsChecklist input[type=checkbox]'));
            const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
            const task = orderTasks.find(t => t.id === taskId);
            if (task) {
                task.assignedTo = selected;
                task.status = selected.length > 0 ? 'assigned' : 'unassigned';
                saveOrderTasks();
                renderOrderTasks();
                // Se ritiro, sincronizza nel DB i task assegnati agli operatori
                upsertRitiroTasksForOperators(task, selected);
            }
            closeAssignTaskModal();
        }
        function markTaskCompleted(taskId) {
            const task = orderTasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'completed';
                saveOrderTasks();
                // Sync also the related order status
                const order = orders.find(o => ('task-' + o.id) === taskId || o.id === task.orderId);
                if (order) {
                    order.status = 'completed';
                    saveOrders();
                }
                renderOrderTasks();
                updateStats();
                renderCalendar();
            }
        }

        async function deleteOrderTask(taskId) {
            const task = orderTasks.find(t => t.id === taskId);
            if (task) {
                await deleteBackendEntriesForTask(task);
            }
            orderTasks = orderTasks.filter(t => t.id !== taskId);
            saveOrderTasks();
            // Also delete underlying order if present
            if (task && task.orderId) {
                orders = orders.filter(o => o.id !== task.orderId);
                saveOrders();
            }
            renderOrderTasks();
            updateStats();
            renderCalendar();
        }

        // Analizza CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index]?.trim() || '';
                });
                return obj;
            });
        }

        // Carica file CSV
        async function loadCSVData() {
            try {
                // Carica clienti
                const clientiResponse = await fetch('data/clienti.csv');
                const clientiText = await clientiResponse.text();
                clienti = parseCSV(clientiText);

                // Carica articoli
                const articoliResponse = await fetch('data/articoli.csv');
                const articoliText = await articoliResponse.text();
                articoli = parseCSV(articoliText);

                console.log('Clienti caricati:', clienti.length);
                console.log('Articoli caricati:', articoli.length);
            } catch (error) {
                console.error('Errore caricamento CSV:', error);
            }
        }

        // Carica ordini da localStorage
        function loadOrders() {
            const stored = localStorage.getItem('orders');
            orders = stored ? JSON.parse(stored) : [];
            renderOrders();
            updateStats();
            renderCalendar();
        }

        // Salva ordini in localStorage
        function saveOrders() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        // === GESTIONE VIAGGI ===
        function loadTrips() {
            const stored = localStorage.getItem('trips');
            trips = stored ? JSON.parse(stored) : [];
        }

        function saveTrips() {
            localStorage.setItem('trips', JSON.stringify(trips));
        }

        function createTrip(name, date) {
            const trip = {
                id: Date.now(),
                name: name,
                date: date,
                orderIds: [],
                sequence: [],
                createdAt: new Date().toISOString(),
                assignedOperatorId: null,
                tripTaskId: null
            };
            trips.push(trip);
            saveTrips();
            return trip;
        }

        function addOrderToTrip(tripId, orderId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip && !trip.orderIds.includes(orderId)) {
                trip.orderIds.push(orderId);
                trip.sequence.push(orderId);
                saveTrips();
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    order.tripId = tripId;
                    saveOrders();
                }
                // Sync trip task with backend
                syncTripTask(tripId);
            }
        }

        function removeOrderFromTrip(tripId, orderId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                trip.orderIds = trip.orderIds.filter(id => id !== orderId);
                trip.sequence = trip.sequence.filter(id => id !== orderId);
                saveTrips();
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    delete order.tripId;
                    saveOrders();
                }
                // If no more orders, delete trip task, else update it
                const remaining = trip.orderIds.length;
                if (remaining === 0) {
                    deleteTripTask(tripId);
                } else {
                    syncTripTask(tripId);
                }
            }
        }

        function deleteTrip(tripId) {
            trips = trips.filter(t => t.id !== tripId);
            saveTrips();
            orders.forEach(o => {
                if (o.tripId === tripId) {
                    delete o.tripId;
                }
            });
            saveOrders();
            // Remove backend task too
            deleteTripTask(tripId);
        }

        function reorderTripSequence(tripId, newSequence) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                trip.sequence = newSequence;
                saveTrips();
                // Re-sequencing changes description; update backend task if exists
                syncTripTask(tripId);
            }
        }

        function getTripOrders(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip) return [];
            return trip.sequence.map(orderId => orders.find(o => o.id === orderId)).filter(Boolean);
        }

        function calculateTripTotals(tripId) {
            const tripOrders = getTripOrders(tripId);
            const totals = {};
            tripOrders.forEach(order => {
                if (!totals[order.product]) {
                    totals[order.product] = 0;
                }
                totals[order.product] += parseFloat(order.quantity || 0);
            });
            return totals;
        }

        // === Task Viaggio (un task per viaggio) ===
        function buildTripTaskTitle(trip) {
            const d = trip.date ? new Date(trip.date) : null;
            const dateStr = d ? d.toLocaleDateString('it-IT') : '';
            return `üöö Viaggio: ${trip.name}${dateStr ? ' ‚Ä¢ ' + dateStr : ''}`;
        }

        function buildTripTaskDescription(trip) {
            const tripOrders = getTripOrders(trip.id);
            const totals = calculateTripTotals(trip.id);
            const ordersList = tripOrders.map((o, idx) => `#${idx + 1} ${o.client} ‚Ä¢ ${o.product} ${o.quantity}kg`).join('\n');
            const totalsList = Object.entries(totals).map(([p, q]) => `${p}: ${q.toFixed(1)}kg`).join(', ');
            return `Ordini nel viaggio: ${tripOrders.length}\n\nSequenza:\n${ordersList || '-'}\n\nTotali prodotti: ${totalsList || '-'}`;
        }

        async function syncTripTask(tripId) {
            try {
                const trip = trips.find(t => t.id === tripId);
                if (!trip) return;
                if (!currentUser?.id || currentUser?.role !== 'master') return; // solo admin crea/aggiorna
                const auth = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!auth) return;
                // Crea/aggiorna solo se ci sono ordini
                if (!trip.orderIds || trip.orderIds.length === 0) return;

                const payload = {
                    title: buildTripTaskTitle(trip),
                    description: buildTripTaskDescription(trip),
                    scheduledAt: trip.date || null,
                    assignedOperatorId: trip.assignedOperatorId || null,
                    estimatedMinutes: Math.max(60, getTripOrders(trip.id).length * 15),
                    priority: 'HIGH'
                };

                if (trip.tripTaskId) {
                    const resp = await fetch(`${API_URL}/tasks/${trip.tripTaskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${auth}` },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) console.warn('Aggiornamento task viaggio fallito', resp.status);
                } else {
                    const resp = await fetch(`${API_URL}/tasks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${auth}` },
                        body: JSON.stringify(payload)
                    });
                    if (resp.ok) {
                        const saved = await resp.json();
                        trip.tripTaskId = saved.id;
                        saveTrips();
                    } else {
                        console.warn('Creazione task viaggio fallita', resp.status);
                    }
                }
            } catch (e) {
                console.error('Errore syncTripTask:', e);
            }
        }

        async function deleteTripTask(tripId) {
            try {
                const trip = trips.find(t => t.id === tripId);
                if (!trip || !trip.tripTaskId) return;
                if (!currentUser?.id || currentUser?.role !== 'master') return;
                const auth = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!auth) return;
                const resp = await fetch(`${API_URL}/tasks/${trip.tripTaskId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${auth}` }
                });
                if (resp.status === 204 || resp.ok) {
                    trip.tripTaskId = null;
                    saveTrips();
                }
            } catch (e) {
                console.error('Errore deleteTripTask:', e);
            }
        }

        // Apri modal ordine
        function openOrderModal() {
            document.querySelector('#orderModal h2').textContent = 'üìù Nuovo Ordine';
            document.getElementById('orderForm').dataset.editingId = '';
            
            // Popola dropdown clienti
            const clientSelect = document.getElementById('orderClient');
            clientSelect.innerHTML = '<option value="">-- Seleziona Cliente --</option>' +
                clienti.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');

            // Popola dropdown articoli
            const productSelect = document.getElementById('orderProduct');
            productSelect.innerHTML = '<option value="">-- Seleziona Articolo --</option>' +
                articoli.map(a => `<option value="${a.nome}">${a.codice} - ${a.nome}</option>`).join('');

            // Popola checklist operatori - verifica che siano gi√† caricati
            const checklistDiv = document.getElementById('orderOperatorsChecklist');
            if (allOperators.length > 0) {
                checklistDiv.innerHTML = allOperators.map(op => {
                    const icon = op.role === 'master' ? 'üë®‚Äçüíº' : 'üë∑';
                    const suffix = (currentUser.id === op.id) ? ' (per me)' : '';
                    return `
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" class="orderOperatorCheckbox" value="${op.username}" style="cursor: pointer;">
                        <span>${icon} ${op.username}${suffix}</span>
                    </label>
                `;
                }).join('');
            } else {
                checklistDiv.innerHTML = '<p style="color: #a0a0a0; font-size: 11px;">Caricamento operatori...</p>';
            }

            document.getElementById('orderModal').classList.add('active');
            document.getElementById('orderForm').reset();
        }

        // Apri modal per modificare ordine esistente
        function openEditOrderModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            document.querySelector('#orderModal h2').textContent = '‚úèÔ∏è Modifica Ordine';
            document.getElementById('orderForm').dataset.editingId = orderId;
            
            // Popola dropdown clienti
            const clientSelect = document.getElementById('orderClient');
            clientSelect.innerHTML = '<option value="">-- Seleziona Cliente --</option>' +
                clienti.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
            clientSelect.value = order.client;

            // Popola dropdown articoli
            const productSelect = document.getElementById('orderProduct');
            productSelect.innerHTML = '<option value="">-- Seleziona Articolo --</option>' +
                articoli.map(a => `<option value="${a.nome}">${a.codice} - ${a.nome}</option>`).join('');
            productSelect.value = order.product;

            // Riempi i campi
            document.getElementById('orderLotto').value = order.lotto || '';
            document.getElementById('orderRitiroConsegna').value = order.ritiro_consegna || '';
            document.getElementById('orderPosizione').value = order.posizione || '';
            document.getElementById('orderQuantity').value = order.quantity;
            document.getElementById('orderType').value = order.type;
            document.getElementById('orderDateTime').value = order.dateTime;
            document.getElementById('orderStatus').value = order.status;
            document.getElementById('orderNotes').value = order.notes || '';

            // Popola checklist operatori con selezione esistente
            const task = orderTasks.find(t => t.orderId === orderId);
            const checklistDiv = document.getElementById('orderOperatorsChecklist');
            if (allOperators.length > 0) {
                checklistDiv.innerHTML = allOperators.map(op => {
                    const icon = op.role === 'master' ? 'üë®‚Äçüíº' : 'üë∑';
                    const suffix = (currentUser.id === op.id) ? ' (per me)' : '';
                    const checked = task && task.assignedTo.includes(op.username) ? 'checked' : '';
                    return `
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" class="orderOperatorCheckbox" value="${op.username}" ${checked} style="cursor: pointer;">
                        <span>${icon} ${op.username}${suffix}</span>
                    </label>
                `;
                }).join('');
            }

            updateClientInfo();
            document.getElementById('orderModal').classList.add('active');
        }

        // Chiudi modal ordine
        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        // Aggiorna informazioni cliente (orari)
        function updateClientInfo() {
            const selectedClient = document.getElementById('orderClient').value;
            const cliente = clienti.find(c => c.nome === selectedClient);
            const infoDiv = document.getElementById('clientHoursInfo');
            
            if (cliente && cliente.orario_apertura) {
                infoDiv.innerHTML = `
                    <strong>‚è∞ Orari Cliente:</strong><br>
                    Apertura: ${cliente.orario_apertura} - ${cliente.orario_chiusura}<br>
                    Finestra Consegne: ${cliente.orario_consegna_inizio} - ${cliente.orario_consegna_fine}
                `;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Aggiorna informazioni articolo (lotto, ritiro/consegna, posizione)
        function updateArticleInfo() {
            const selectedProduct = document.getElementById('orderProduct').value;
            const article = articoli.find(a => a.nome === selectedProduct);
            
            if (article) {
                document.getElementById('orderLotto').value = article.lotto || '';
                document.getElementById('orderRitiroConsegna').value = article.ritiro_consegna || '';
                document.getElementById('orderPosizione').value = article.posizione_scaffale || '';
            } else {
                document.getElementById('orderLotto').value = '';
                document.getElementById('orderRitiroConsegna').value = '';
                document.getElementById('orderPosizione').value = '';
            }
        }

        // Salva nuovo ordine o modifica esistente
        function saveOrder(event) {
            event.preventDefault();
            
            const editingId = document.getElementById('orderForm').dataset.editingId;
            const selectedOperators = Array.from(document.querySelectorAll('.orderOperatorCheckbox:checked')).map(cb => cb.value);
            
            const orderData = {
                client: document.getElementById('orderClient').value,
                product: document.getElementById('orderProduct').value,
                quantity: parseFloat(document.getElementById('orderQuantity').value),
                type: document.getElementById('orderType').value,
                dateTime: document.getElementById('orderDateTime').value,
                status: document.getElementById('orderStatus').value,
                lotto: document.getElementById('orderLotto').value,
                ritiro_consegna: document.getElementById('orderRitiroConsegna').value,
                posizione: document.getElementById('orderPosizione').value,
                notes: document.getElementById('orderNotes').value
            };

            if (editingId) {
                // Modifica ordine esistente
                const order = orders.find(o => o.id == editingId);
                if (order) {
                    Object.assign(order, orderData);
                    
                    // Aggiorna anche il task associato
                    const task = orderTasks.find(t => t.orderId == editingId);
                    if (task) {
                        // Aggiorna titolo con nuovo formato semplificato
                        task.title = `${orderData.type === 'consegnato' ? 'consegna' : 'ritiro'} - ${String(orderData.client || '').toLowerCase()}`;
                        task.client = orderData.client;
                        task.product = orderData.product;
                        task.quantity = orderData.quantity;
                        task.dateTime = orderData.dateTime;
                        task.notes = orderData.notes;
                        task.assignedTo = selectedOperators;
                        task.status = selectedOperators.length > 0 ? 'assigned' : 'unassigned';
                        const cliente = clienti.find(c => c.nome === orderData.client);
                        if (cliente) {
                            task.clienteOrari = {
                                apertura: cliente.orario_apertura,
                                chiusura: cliente.orario_chiusura,
                                consegna_inizio: cliente.orario_consegna_inizio,
                                consegna_fine: cliente.orario_consegna_fine
                            };
                        }
                        saveOrderTasks();
                        // Se ritiro, sincronizza nel DB i task assegnati agli operatori
                        upsertRitiroTasksForOperators(task, selectedOperators);
                    }
                    console.log('‚úèÔ∏è Ordine modificato:', order.client);
                }
            } else {
                // Nuovo ordine
                const order = {
                    id: Date.now(),
                    ...orderData,
                    createdAt: new Date().toISOString()
                };
                orders.push(order);
                generateTaskForOrder(order, selectedOperators);
                // Sync DB per ritiro dopo generazione
                const generatedTask = orderTasks.find(t => t.orderId === order.id);
                if (generatedTask) {
                    upsertRitiroTasksForOperators(generatedTask, selectedOperators);
                }
                console.log('üìù Nuovo ordine creato:', order.client, 'selectedOperators:', selectedOperators);
            }

            renderOrderTasks();
            saveOrders();
            renderOrders();
            updateStats();
            renderCalendar();
            closeOrderModal();
        }

        // Elimina ordine
        async function deleteOrder(id) {
            // Elimina eventuale task collegato anche nel backend
            const task = orderTasks.find(t => t.orderId === id);
            if (task) {
                await deleteBackendEntriesForTask(task);
            }
            orders = orders.filter(o => o.id !== id);
            saveOrders();
            // Also remove generated task for this order, if any
            const prevLen = orderTasks.length;
            orderTasks = orderTasks.filter(t => t.orderId !== id);
            if (orderTasks.length !== prevLen) {
                saveOrderTasks();
                renderOrderTasks();
            }
            renderOrders();
            updateStats();
            renderCalendar();
        }

        // Aggiorna stato ordine
        function updateOrderStatus(id, newStatus) {
            const order = orders.find(o => o.id === id);
            if (order) {
                order.status = newStatus;
                saveOrders();
                renderOrders();
                // If marking completed, sync related task status too
                if (newStatus === 'completed') {
                    const task = orderTasks.find(t => t.orderId === id);
                    if (task) {
                        task.status = 'completed';
                        saveOrderTasks();
                        renderOrderTasks();
                    }
                }
                updateStats();
                renderCalendar();
            }
        }

        // Renderizza ordini
        function renderOrders() {
            const grid = document.getElementById('ordersGrid');
            if (!grid) return;
            
            if (orders.length === 0) {
                grid.innerHTML = '<p style="color: #808080; grid-column: 1/-1; text-align: center; padding: 20px;">Nessun ordine presente. Crea il primo ordine!</p>';
                return;
            }

            grid.innerHTML = orders.map(order => {
                const cliente = clienti.find(c => c.nome === order.client);
                const orariInfo = cliente ? `
                    <p><strong>Apertura:</strong> ${cliente.orario_apertura} - ${cliente.orario_chiusura}</p>
                    <p><strong>Finestra Consegne:</strong> ${cliente.orario_consegna_inizio} - ${cliente.orario_consegna_fine}</p>
                ` : '';
                
                return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-title">${order.client}</div>
                        <div class="order-status ${order.status}">${getStatusLabel(order.status)}</div>
                    </div>
                    <div class="order-details">
                        <p><strong>Prodotto:</strong> ${order.product}</p>
                        <p><strong>Quantit√†:</strong> ${order.quantity} kg</p>
                        <p><strong>Tipo:</strong> ${order.type === 'consegnato' ? 'üì¶ Consegnato' : 'üè™ Ritira Cliente'}</p>
                        <p><strong>Data e Orario:</strong> ${order.dateTime ? new Date(order.dateTime).toLocaleString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'N/D'}</p>
                        ${orariInfo}
                        ${order.lotto ? `<p><strong>Lotto:</strong> ${order.lotto}</p>` : ''}
                        ${order.ritiro_consegna ? `<p><strong>Ritiro/Consegna:</strong> ${order.ritiro_consegna}</p>` : ''}
                        ${order.posizione ? `<p><strong>Scaffale:</strong> ${order.posizione}</p>` : ''}
                        ${order.notes ? `<p><strong>Note:</strong> ${order.notes}</p>` : ''}
                    </div>
                    <div class="order-actions">
                        <button class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'completed')">‚úì Completa</button>
                        <button class="btn btn-danger" onclick="deleteOrder(${order.id})">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `}).join('');
        }

        // Ottieni etichetta stato
        function getStatusLabel(status) {
            const labels = {
                'pending': '‚è≥ Sospeso',
                'in_progress': '‚öôÔ∏è In Lavorazione',
                'completed': '‚úì Completato'
            };
            return labels[status] || status;
        }

        // Aggiorna statistiche
        function updateStats() {
            const total = orders.length;
            const pending = orders.filter(o => o.status !== 'completed').length;
            const completed = orders.filter(o => o.status === 'completed').length;

            document.getElementById('totalOrders').textContent = total;
            document.getElementById('pendingOrders').textContent = pending;
            document.getElementById('completedOrders').textContent = completed;
        }

        // Genera 15 ordini casuali per i prossimi 10 giorni
        function generateSampleOrders() {
            if (orders.length > 0) {
                const confirm = window.confirm('Ordini gi√† presenti. Vuoi aggiungere 15 nuovi ordini?');
                if (!confirm) return;
            }

            const statuses = ['pending', 'in_progress', 'completed'];
            const types = ['consegnato', 'ritira'];
            
            // Genera ordini raggruppati per giorno per calcolare carico e tempi
            const ordersByDay = {};
            const tempOrders = [];
            
            for (let i = 0; i < 15; i++) {
                const randomClient = clienti[Math.floor(Math.random() * clienti.length)];
                const randomProduct = articoli[Math.floor(Math.random() * articoli.length)];
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                const randomType = types[Math.floor(Math.random() * types.length)];
                const randomQuantity = (Math.random() * 49 + 1).toFixed(1);
                const randomDays = Math.floor(Math.random() * 11);
                
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + randomDays);
                const dateStr = String(dueDate.getFullYear()).padStart(4, '0') + '-' + 
                               String(dueDate.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(dueDate.getDate()).padStart(2, '0');

                if (!ordersByDay[dateStr]) {
                    ordersByDay[dateStr] = { deliveries: [], pickups: [] };
                }

                const orderData = {
                    client: randomClient.nome,
                    product: randomProduct.nome,
                    quantity: parseFloat(randomQuantity),
                    status: randomStatus,
                    lotto: randomProduct.lotto,
                    ritiro_consegna: randomProduct.ritiro_consegna,
                    posizione: randomProduct.posizione_scaffale
                };

                if (randomType === 'consegnato') {
                    ordersByDay[dateStr].deliveries.push(orderData);
                } else {
                    ordersByDay[dateStr].pickups.push(orderData);
                }
            }

            // Calcola orari con tempo variabile in base al carico giornaliero
            let orderId = Date.now();
            for (const [date, dayData] of Object.entries(ordersByDay)) {
                // Calcola carico totale del giorno (solo consegne)
                const totalLoad = dayData.deliveries.reduce((sum, o) => sum + o.quantity, 0);
                
                // Calcola tempo per consegna: 15-45 min in base al carico
                // Formula: minuti = 15 + (carico / 1200kg * 30)
                const loadFactor = Math.min(totalLoad / 1200, 1); // Normalizza a 0-1
                const minutesPerDelivery = Math.round(15 + (loadFactor * 30)); // 15-45 minuti
                
                let currentTime = 8 * 60; // Inizia alle 8:00 (in minuti)
                
                // Processa consegne con tempi progressivi
                dayData.deliveries.forEach((orderData) => {
                    const hours = Math.floor(currentTime / 60);
                    const minutes = currentTime % 60;
                    const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    
                    orders.push({
                        id: orderId++,
                        ...orderData,
                        type: 'consegnato',
                        dateTime: date + 'T' + timeStr,
                        notes: '',
                        createdAt: new Date().toISOString()
                    });
                    generateTaskForOrder(orders[orders.length - 1]);
                    
                    // Incrementa il tempo per la prossima consegna
                    currentTime += minutesPerDelivery;
                });
                
                // Processa ritiri con orari casuali
                dayData.pickups.forEach((orderData) => {
                    const randomHour = Math.floor(Math.random() * 11) + 8; // 8-18
                    const randomMin = Math.floor(Math.random() * 60);
                    const timeStr = `${String(randomHour).padStart(2, '0')}:${String(randomMin).padStart(2, '0')}`;
                    
                    orders.push({
                        id: orderId++,
                        ...orderData,
                        type: 'ritira',
                        dateTime: date + 'T' + timeStr,
                        notes: '',
                        createdAt: new Date().toISOString()
                    });
                    generateTaskForOrder(orders[orders.length - 1]);
                });
            }
            
            saveOrders();
            renderOrderTasks();
            renderOrders();
            updateStats();
            renderCalendar();
            alert('‚úÖ 15 ordini generati con successo!');
        }

        // Torna indietro
        function goBack() {
            window.history.back();
        }

        // Renderizza calendario
        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            
            const year = calendarDisplayYear;
            const month = calendarDisplayMonth;
            
            // Festivi italiani fissi
            const italianHolidays = [
                '01-01', '01-06', '04-25', '05-01', '06-02',
                '08-15', '11-01', '12-08', '12-25', '12-26'
            ];
            
            // Aggiorna il titolo del mese
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                               'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const dayNames = ['Do', 'Lu', 'Ma', 'Me', 'Gi', 'Ve', 'Sa'];
            let html = dayNames.map(day => `<div style="font-weight: bold; text-align: center; padding: 6px; background: #3d3d3d; border: 1px solid #4d4d4d; border-radius: 4px; font-size: 12px; color: #b0b0b0;">${day}</div>`).join('');
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = String(year).padStart(4, '0') + '-' + 
                               String(month + 1).padStart(2, '0') + '-' + 
                               String(day).padStart(2, '0');
                const dayOfWeek = date.getDay();
                const monthDay = String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                const isHoliday = dayOfWeek === 0 || italianHolidays.includes(monthDay);
                
                // Conta ordini con data schedulata
                const dayOrders = orders.filter(order => {
                    if (!order.dateTime) return false;
                    return order.dateTime.startsWith(dateStr);
                });

                // Conta ordini assegnati e da assegnare
                const assignedOrders = dayOrders.filter(order => {
                    const task = orderTasks.find(t => t.orderId === order.id);
                    return task && task.assignedTo.length > 0;
                }).length;
                
                const unassignedOrders = dayOrders.filter(order => {
                    const task = orderTasks.find(t => t.orderId === order.id);
                    return !task || task.assignedTo.length === 0;
                }).length;

                const totalOrders = dayOrders.length;
                const hasOrdersClass = assignedOrders > 0 ? 'has-orders' : '';
                const hasUnassignedClass = unassignedOrders > 0 ? 'has-unassigned-orders' : '';
                const dayColor = isHoliday ? 'color: #ef4444;' : '';

                let assignedCountHtml = '';
                let unassignedCountHtml = '';
                if (assignedOrders > 0) {
                    assignedCountHtml = `<div style="position: absolute; bottom: 2px; right: 2px; font-size: 14px; color: #ffffff; font-weight: bold; z-index: 10;">${assignedOrders}</div>`;
                }
                if (unassignedOrders > 0) {
                    unassignedCountHtml = `<div style="position: absolute; bottom: 2px; left: 2px; font-size: 14px; color: #ffffff; font-weight: bold; z-index: 10;">${unassignedOrders}</div>`;
                }

                html += `<div class="calendar-day ${hasOrdersClass} ${hasUnassignedClass}" style="${dayColor}" onclick="showDayOrdersModal('${dateStr}')"><strong>${day}</strong>${assignedCountHtml}${unassignedCountHtml}</div>`;
            }
            
            container.innerHTML = html;
        }
        
        function previousMonth() {
            calendarDisplayMonth--;
            if (calendarDisplayMonth < 0) {
                calendarDisplayMonth = 11;
                calendarDisplayYear--;
            }
            renderCalendar();
        }
        
        function nextMonth() {
            calendarDisplayMonth++;
            if (calendarDisplayMonth > 11) {
                calendarDisplayMonth = 0;
                calendarDisplayYear++;
            }
            renderCalendar();
        }

        // Mostra ordini del giorno in modal
        function showDayOrdersModal(dateStr) {
            const dayOrdersList = document.getElementById('dayOrdersList');
            const dayOrdersCard = document.getElementById('dayOrdersCard');
            const dayOrdersTitle = document.getElementById('dayOrdersTitle');

            // Filtra gli ordini per il giorno selezionato
            const dayOrders = orders.filter(order => {
                if (!order.dateTime) return false;
                return order.dateTime.startsWith(dateStr);
            });

            // Formatta la data per il display
            const date = new Date(dateStr + 'T00:00:00');
            const dayNames = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const dayName = dayNames[date.getDay()];
            const formatted = date.toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' });
            dayOrdersTitle.textContent = `üìã Ordini di ${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formatted}`;

            if (dayOrders.length === 0) {
                dayOrdersList.innerHTML = '<div class="empty-state">Nessun ordine per questo giorno</div>';
                dayOrdersCard.style.display = 'block';
                return;
            }

            // Crea le card degli ordini
            dayOrdersList.innerHTML = dayOrders.map(order => {
                const timeOnly = order.dateTime ? new Date(order.dateTime).toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}) : 'N/D';
                const headerTitle = `${order.type === 'consegnato' ? 'consegna' : 'ritiro'} - ${String(order.client || '').toLowerCase()}`;
                return `
                <div class="order-card" style="background: #1e2a4d; border-left: 4px solid var(--primary); border: 2px solid #2563eb;">
                    <div class="order-header">
                        <div class="order-title" style="font-size: 20px; color: #7dd3fc; font-weight: 700;">${headerTitle}</div>
                        <div class="order-status ${order.status}" style="font-size: 14px;">${getStatusLabel(order.status)}</div>
                    </div>
                    <div class="order-details" style="font-size: 18px; line-height: 1.8; margin-top: 12px;">
                        <p style="margin: 8px 0;"><strong style="color: #93c5fd; font-size: 20px;">üì¶ Prodotto:</strong> <span style="color: #e0e0e0; font-size: 20px; font-weight: 600;">${order.product}</span></p>
                        <p style="margin: 8px 0;"><strong style="color: #93c5fd; font-size: 20px;">üìä Quantit√†:</strong> <span style="color: #fcd34d; font-size: 22px; font-weight: 700;">${order.quantity} kg</span></p>
                        <p style="margin: 8px 0;"><strong style="color: #93c5fd; font-size: 20px;">‚è∞ Orario Programmato:</strong> <span style="color: #86efac; font-size: 22px; font-weight: 700;">${timeOnly}</span></p>
                    </div>
                    <div class="order-actions" style="margin-top: 15px;">
                        <button class="btn btn-warning" onclick="updateOrderStatus(${order.id}, 'in_progress')" style="font-size: 14px;">‚öôÔ∏è In Lavorazione</button>
                        <button class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'completed')" style="font-size: 14px;">‚úì Completa</button>
                        <button class="btn btn-danger" onclick="deleteOrder(${order.id})" style="font-size: 14px;">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `}).join('');

            dayOrdersCard.style.display = 'block';

            // Scroll automatico verso la card
            setTimeout(() => {
                dayOrdersCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Chiudi la card degli ordini del giorno
        function closeDayOrdersCard() {
            document.getElementById('dayOrdersCard').style.display = 'none';
        }

        // === UI VIAGGI ===
        let currentTripId = null;

        function openTripsManager() {
            renderTripsManager();
            document.getElementById('tripsManagerModal').classList.add('active');
        }

        function closeTripsManager() {
            document.getElementById('tripsManagerModal').classList.remove('active');
        }

        function renderTripsManager() {
            const container = document.getElementById('tripsManagerList');
            if (trips.length === 0) {
                container.innerHTML = '<p style="color:#808080;text-align:center;padding:20px;">Nessun viaggio creato</p>';
                return;
            }

            container.innerHTML = trips.map(trip => {
                const tripOrders = getTripOrders(trip.id);
                const totals = calculateTripTotals(trip.id);
                const totalsHtml = Object.entries(totals).map(([product, qty]) => 
                    `<span style="background:#1e3a2a;color:#86efac;padding:4px 8px;border-radius:4px;font-size:12px;margin-right:6px;">${product}: ${qty.toFixed(1)}kg</span>`
                ).join('');

                return `
                    <div class="order-card" style="border-left:4px solid #16a34a;margin-bottom:15px;">
                        <div class="order-header">
                            <div class="order-title">${trip.name}</div>
                            <span class="order-status" style="background:#1e3a2a;color:#86efac;">${tripOrders.length} ordini</span>
                        </div>
                        <div class="order-details">
                            <p><strong>üìÖ Data:</strong> ${new Date(trip.date).toLocaleDateString('it-IT')}</p>
                            ${totalsHtml ? `<p><strong>üìä Totali:</strong><br>${totalsHtml}</p>` : ''}
                        </div>
                        <div class="order-actions" style="justify-content:flex-end;gap:8px;margin-top:10px;">
                            <button class="btn btn-primary" onclick="openTripOrders(${trip.id})" style="padding:6px 10px;font-size:12px;">üì¶ Gestisci Ordini</button>
                            <button class="btn btn-danger" onclick="confirmDeleteTrip(${trip.id})" style="padding:6px 10px;font-size:12px;">üóëÔ∏è Elimina</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openCreateTripModal() {
            document.getElementById('createTripForm').reset();
            document.getElementById('tripDate').valueAsDate = new Date();
            document.getElementById('createTripModal').classList.add('active');
        }

        function closeCreateTripModal() {
            document.getElementById('createTripModal').classList.remove('active');
        }

        function saveNewTrip(event) {
            event.preventDefault();
            const name = document.getElementById('tripName').value;
            const date = document.getElementById('tripDate').value;
            createTrip(name, date);
            closeCreateTripModal();
            renderTripsManager();
            alert('‚úÖ Viaggio creato con successo!');
        }

        function confirmDeleteTrip(tripId) {
            if (confirm('Eliminare questo viaggio? Gli ordini non verranno eliminati.')) {
                deleteTrip(tripId);
                renderTripsManager();
                renderOrderTasks();
            }
        }

        function openTripOrders(tripId) {
            currentTripId = tripId;
            const trip = trips.find(t => t.id === tripId);
            if (!trip) return;

            document.getElementById('tripOrdersTitle').textContent = `üì¶ ${trip.name} - Gestione Ordini`;
            renderTripOperatorAssign(tripId);
            renderAvailableOrders(tripId);
            renderTripOrdersList(tripId);
            renderTripTotals(tripId);
            document.getElementById('tripOrdersModal').classList.add('active');
        }

        function closeTripOrdersModal() {
            document.getElementById('tripOrdersModal').classList.remove('active');
            currentTripId = null;
            renderTripsManager();
        }

        function renderAvailableOrders(tripId) {
            const trip = trips.find(t => t.id === tripId);
            const tripDate = trip.date.split('T')[0];
            const available = orders.filter(o => {
                const orderDate = o.dateTime ? o.dateTime.split('T')[0] : null;
                return o.type === 'consegnato' && 
                       orderDate === tripDate && 
                       !o.tripId;
            });

            const container = document.getElementById('availableOrdersList');
            if (available.length === 0) {
                container.innerHTML = '<p style="color:#808080;font-size:12px;">Nessun ordine disponibile per questa data</p>';
                return;
            }

            container.innerHTML = available.map(order => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#2d2d2d;margin-bottom:6px;border-radius:4px;">
                    <div style="font-size:12px;">
                        <strong>${order.client}</strong> - ${order.product} (${order.quantity}kg)
                        <span style="color:#a0a0a0;margin-left:8px;">${new Date(order.dateTime).toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'})}</span>
                    </div>
                    <button class="btn btn-primary" onclick="addOrderToCurrentTrip(${order.id})" style="padding:4px 8px;font-size:11px;">‚ûï Aggiungi</button>
                </div>
            `).join('');
        }

        function renderTripOrdersList(tripId) {
            const tripOrders = getTripOrders(tripId);
            const container = document.getElementById('tripOrdersList');
            
            if (tripOrders.length === 0) {
                container.innerHTML = '<p style="color:#808080;font-size:12px;padding:10px;text-align:center;">Nessun ordine nel viaggio</p>';
                return;
            }

            container.innerHTML = tripOrders.map((order, index) => `
                <div style="display:flex;align-items:center;padding:10px;background:#3d3d3d;margin-bottom:8px;border-radius:4px;border-left:4px solid #16a34a;">
                    <div style="display:flex;flex-direction:column;gap:6px;margin-right:10px;">
                        <button class="btn btn-secondary" onclick="moveOrderUp(${tripId}, ${index})" ${index === 0 ? 'disabled' : ''} style="padding:2px 6px;font-size:10px;">‚ñ≤</button>
                        <button class="btn btn-secondary" onclick="moveOrderDown(${tripId}, ${index})" ${index === tripOrders.length - 1 ? 'disabled' : ''} style="padding:2px 6px;font-size:10px;">‚ñº</button>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:14px;margin-bottom:4px;color:#16a34a;">#${index + 1} - ${order.client}</div>
                        <div style="font-size:12px;color:#a0a0a0;">
                            ${order.product} - ${order.quantity}kg
                            <span style="margin-left:10px;">‚è∞ ${new Date(order.dateTime).toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'})}</span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeOrderFromCurrentTrip(${order.id})" style="padding:4px 8px;font-size:11px;">‚úñ</button>
                </div>
            `).join('');
        }

        function renderTripTotals(tripId) {
            const totals = calculateTripTotals(tripId);
            const container = document.getElementById('tripTotals');
            
            if (Object.keys(totals).length === 0) {
                container.innerHTML = '<p style="color:#808080;font-size:12px;">Nessun prodotto</p>';
                return;
            }

            container.innerHTML = Object.entries(totals).map(([product, qty]) => `
                <div style="display:flex;justify-content:space-between;padding:8px;background:#3d3d3d;margin-bottom:6px;border-radius:4px;">
                    <span style="font-weight:600;color:#e0e0e0;">${product}</span>
                    <span style="color:#86efac;font-weight:700;">${qty.toFixed(1)} kg</span>
                </div>
            `).join('');
        }

        function addOrderToCurrentTrip(orderId) {
            if (!currentTripId) return;
            addOrderToTrip(currentTripId, orderId);
            renderAvailableOrders(currentTripId);
            renderTripOrdersList(currentTripId);
            renderTripTotals(currentTripId);
            renderOrderTasks();
        }

        function removeOrderFromCurrentTrip(orderId) {
            if (!currentTripId) return;
            removeOrderFromTrip(currentTripId, orderId);
            renderAvailableOrders(currentTripId);
            renderTripOrdersList(currentTripId);
            renderTripTotals(currentTripId);
            renderOrderTasks();
        }

        function moveOrderUp(tripId, index) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip || index === 0) return;
            
            const newSequence = [...trip.sequence];
            [newSequence[index], newSequence[index - 1]] = [newSequence[index - 1], newSequence[index]];
            reorderTripSequence(tripId, newSequence);
            renderTripOrdersList(tripId);
        }

        function moveOrderDown(tripId, index) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip || index === trip.sequence.length - 1) return;
            
            const newSequence = [...trip.sequence];
            [newSequence[index], newSequence[index + 1]] = [newSequence[index + 1], newSequence[index]];
            reorderTripSequence(tripId, newSequence);
            renderTripOrdersList(tripId);
        }

        function renderTripOperatorAssign(tripId) {
            const container = document.getElementById('tripOperatorAssign');
            const select = document.getElementById('tripOperatorSelect');
            const trip = trips.find(t => t.id === tripId);
            if (!trip || !select) return;
            // Populate operators select (prefer operators/slave)
            const ops = allOperators || [];
            select.innerHTML = '<option value="">-- Non assegnato --</option>' +
                ops.map(op => `<option value="${op.id}">${op.username}</option>`).join('');
            if (trip.assignedOperatorId) {
                select.value = String(trip.assignedOperatorId);
            }
        }

        function saveTripOperator() {
            if (!currentTripId) return;
            const trip = trips.find(t => t.id === currentTripId);
            if (!trip) return;
            const select = document.getElementById('tripOperatorSelect');
            const val = select && select.value ? parseInt(select.value) : null;
            trip.assignedOperatorId = val || null;
            saveTrips();
            // Update or create the backend task with new assignment
            syncTripTask(trip.id);
            alert('‚úÖ Operatore viaggio salvato');
        }

        // Inizializza
        window.addEventListener('load', async () => {
                // Display user info
                const token = localStorage.getItem('token');
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const userInfo = document.getElementById('userInfo');
                        if (userInfo && payload.username) {
                            userInfo.textContent = `üë§ ${payload.username}`;
                        }
                    } catch (e) {
                        console.error('Error parsing token:', e);
                    }
                }
            
            await loadOperators();
            await loadCSVData();
            loadOrders();
            loadOrderTasks();
            loadTrips();
            renderOrderTasks();
            renderCalendar();
            // Admin: assicura che gli ordini 'ritira' siano sincronizzati nel DB e visibili
            await syncRitiroOrdersToDb();
        });
    </script>

    <!-- Modal Assegna Task -->
    <div id="assignTaskModal" class="modal">
        <div class="modal-content" style="max-width:420px;">
            <h2 style="margin-top:0;font-size:16px;">üîß Assegna Task Ordine</h2>
            <form onsubmit="assignTaskToOperators(event)">
                <input type="hidden" id="assignTaskId">
                <div id="operatorsChecklist" style="display:flex;flex-direction:column;margin-bottom:12px;"></div>
                <div class="modal-actions" style="margin-top:10px;">
                    <button type="submit" class="btn btn-primary">üíæ Salva Assegnazione</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAssignTaskModal()">‚ùå Chiudi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestione Viaggi -->
    <div id="tripsManagerModal" class="modal">
        <div class="modal-content" style="max-width:900px;max-height:80vh;overflow-y:auto;">
            <h2>üöö Gestione Viaggi</h2>
            <button class="btn btn-primary" onclick="openCreateTripModal()" style="margin-bottom:15px;">‚ûï Nuovo Viaggio</button>
            <div id="tripsManagerList"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeTripsManager()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal Crea Viaggio -->
    <div id="createTripModal" class="modal">
        <div class="modal-content">
            <h2>‚ûï Nuovo Viaggio</h2>
            <form id="createTripForm" onsubmit="saveNewTrip(event)">
                <div class="form-group">
                    <label for="tripName">Nome Viaggio:</label>
                    <input type="text" id="tripName" required placeholder="Es: Giro Mattina">
                </div>
                <div class="form-group">
                    <label for="tripDate">Data:</label>
                    <input type="date" id="tripDate" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">üíæ Crea</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateTripModal()">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestione Ordini Viaggio -->
    <div id="tripOrdersModal" class="modal">
        <div class="modal-content" style="max-width:800px;max-height:80vh;overflow-y:auto;">
            <h2 id="tripOrdersTitle">üì¶ Gestione Ordini Viaggio</h2>
            <div id="tripOperatorAssign" style="margin:10px 0 18px 0;padding:10px;background:#2d2d2d;border-radius:6px;border:1px solid #4d4d4d;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <label for="tripOperatorSelect" style="font-weight:600;color:#e0e0e0;">üë∑ Operatore del Viaggio:</label>
                <select id="tripOperatorSelect" style="flex:1;min-width:220px;padding:8px;background:#3d3d3d;border:1px solid #4d4d4d;border-radius:6px;color:#e0e0e0;"></select>
                <button class="btn btn-primary" onclick="saveTripOperator()">üíæ Salva</button>
            </div>
            <div style="margin-bottom:15px;">
                <h3 style="font-size:16px;margin-bottom:10px;">Ordini Disponibili (consegnati):</h3>
                <div id="availableOrdersList" style="max-height:200px;overflow-y:auto;background:#3d3d3d;padding:10px;border-radius:6px;"></div>
            </div>
            <div style="margin-bottom:15px;">
                <h3 style="font-size:16px;margin-bottom:10px;">Ordini nel Viaggio:</h3>
                <div id="tripOrdersList"></div>
            </div>
            <div style="margin-top:15px;padding:15px;background:#2d2d2d;border-radius:6px;border:2px solid #16a34a;">
                <h3 style="font-size:16px;margin-bottom:10px;color:#16a34a;">üìä Totali Prodotti:</h3>
                <div id="tripTotals"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeTripOrdersModal()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>
</body>
</html>
