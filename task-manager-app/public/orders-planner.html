<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Ordini - Molino Briganti</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ea580c;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #2d2d2d;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .header {
                padding: 8px 12px;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 6px 10px;
                gap: 8px;
                flex-direction: column;
            }
        }

        .header-left {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex: 1;
        }

        .header h1 {
            font-size: 14px;
            color: #e0e0e0;
            margin: 0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 11px;
            }
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .header-actions {
                gap: 6px;
            }

            .header-actions .btn {
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .header-actions {
                width: 100%;
                gap: 6px;
                justify-content: flex-start;
            }

            .header-actions .btn {
                padding: 5px 8px;
                font-size: 10px;
                flex: 1;
                min-width: 80px;
                justify-content: center;
            }
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #3d3d3d;
            color: #e0e0e0;
            border: 1px solid #4d4d4d;
        }

        .btn-secondary:hover {
            background: #4d4d4d;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .card {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .card {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 12px;
                border-radius: 6px;
            }
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        @media (max-width: 768px) {
            .card h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }
        }

        @media (max-width: 480px) {
            .card h2 {
                font-size: 14px;
                margin-bottom: 10px;
            }
        }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .orders-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 12px;
            }
        }

        @media (max-width: 480px) {
            .orders-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .order-card {
            background: #3d3d3d;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #4d4d4d;
        }

        @media (max-width: 768px) {
            .order-card {
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .order-card {
                padding: 10px;
            }
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .order-title {
            font-weight: 600;
            color: #e0e0e0;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .order-title {
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            .order-title {
                font-size: 14px;
            }
        }

        .order-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #1e3a4d;
            color: #7dd3fc;
        }

        .order-status.pending {
            background: #4a3a1e;
            color: #fcd34d;
        }

        .order-status.completed {
            background: #1e3a2a;
            color: #86efac;
        }

        .order-details {
            font-size: 13px;
            color: #a0a0a0;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .order-details {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .order-details {
                font-size: 11px;
            }
        }

        .order-details p {
            margin: 5px 0;
        }

        .order-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .order-actions {
                gap: 6px;
            }

            .order-actions .btn {
                padding: 5px 8px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .order-actions {
                flex-direction: column;
                gap: 6px;
            }

            .order-actions .btn {
                padding: 6px 8px;
                font-size: 11px;
                width: 100%;
                justify-content: center;
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
            color: #e0e0e0;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #4d4d4d;
            border-radius: 6px;
            font-size: 14px;
            background: #3d3d3d;
            color: #e0e0e0;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 50px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            padding: 6px 10px;
            min-height: 16px;
            font-size: 11px;
            flex: 0 1 auto;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2d2d2d;
            padding: 3px 4px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-left: 4px solid var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 20px;
        }

        .stat-number {
            font-size: 12px;
            font-weight: bold;
            color: #e0e0e0;
            margin-bottom: 0px;
        }

        .stat-label {
            font-size: 8px;
            color: #a0a0a0;
        }

        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 12px;
            }

            .stat-card {
                min-height: 18px;
                padding: 2px 3px;
            }

            .stat-number {
                font-size: 11px;
            }

            .stat-label {
                font-size: 7px;
            }
        }

        @media (max-width: 480px) {
            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
                gap: 10px;
            }

            .stat-card {
                min-height: 16px;
                padding: 2px 3px;
            }

            .stat-number {
                font-size: 10px;
            }

            .stat-label {
                font-size: 6px;
            }
        }

        .calendar-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 10px 0;
        }

        .calendar-day {
            border: 1px solid #4d4d4d;
            padding: 6px;
            min-height: 50px;
            border-radius: 4px;
            background: #3d3d3d;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            color: #b0b0b0;
        }

        .calendar-day:hover {
            background: #4d4d4d;
        }

        .calendar-day.has-orders {
            background: #1e3a2a;
            border-color: #4caf50;
        }

        @media (max-width: 768px) {
            .calendar-day {
                min-height: 40px;
                padding: 4px;
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .calendar-day {
                min-height: 35px;
                padding: 3px;
                font-size: 9px;
            }
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #808080;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div>
                    <h1>üì¶ Planner Ordini</h1>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openOrderModal()">‚ûï Nuovo Ordine</button>
                <button class="btn btn-warning" onclick="generateSampleOrders()">üîÑ Genera Dati</button>
                <button class="btn btn-secondary" onclick="goBack()">‚Üê Indietro</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">0</div>
                <div class="stat-label">Ordini Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingOrders">0</div>
                <div class="stat-label">In Sospeso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedOrders">0</div>
                <div class="stat-label">Completati</div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">üìÖ Calendario Ordini</h2>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="previousMonth()" style="padding: 6px 10px; min-height: auto;">‚Üê Mese Prec.</button>
                    <button class="btn btn-secondary" onclick="nextMonth()" style="padding: 6px 10px; min-height: auto;">Mese Succ. ‚Üí</button>
                </div>
            </div>
            <h4 id="calendarMonthYear" style="margin: 0 0 10px 0; color: #e0e0e0; font-size: 14px;"></h4>
            <div id="calendarContainer" class="calendar-container">
                <!-- Calendar will be generated here -->
            </div>
        </div>

        <!-- Day Orders Card -->
        <div class="card" id="dayOrdersCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="dayOrdersTitle" style="margin: 0;">üìã Ordini del Giorno</h2>
                <button class="btn btn-secondary" onclick="closeDayOrdersCard()" style="padding: 6px 10px; min-height: auto;">‚úï Chiudi</button>
            </div>
            <div id="dayOrdersList" class="orders-grid">
                <!-- Orders for the selected day will be populated here -->
            </div>
        </div>

        <!-- Order Tasks (Generati dagli ordini) -->
        <div class="card">
            <h2 style="display:flex;align-items:center;gap:6px;margin:0 0 15px 0;">üõ†Ô∏è Task da Assegnare <span id="tasksCount" style="font-size:11px;color:#a0a0a0;font-weight:400;"></span></h2>
            <div class="orders-grid" id="orderTasksGrid">
                <!-- Order generated tasks will appear here -->
            </div>
        </div>

        <!-- Orders List -->
        <div class="card">
            <h2>üìã Ordini Programmati</h2>
            <div class="orders-grid" id="ordersGrid">
                <!-- Orders will be populated here -->
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <h2>üìù Nuovo Ordine</h2>
            <form id="orderForm" onsubmit="saveOrder(event)">
                <div class="form-group">
                    <label for="orderClient">Cliente:</label>
                    <select id="orderClient" required onchange="updateClientInfo()">
                        <option value="">-- Seleziona Cliente --</option>
                    </select>
                    <div id="clientHoursInfo" style="margin-top: 8px; font-size: 12px; color: #86efac; display: none;">
                        <!-- Client hours will be displayed here -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="orderProduct">Articolo:</label>
                    <select id="orderProduct" required onchange="updateArticleInfo()">
                        <option value="">-- Seleziona Articolo --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderLotto">Lotto:</label>
                    <input type="text" id="orderLotto" readonly placeholder="Auto-compilato">
                </div>
                <div class="form-group">
                    <label for="orderRitiroConsegna">Ritiro/Consegna:</label>
                    <input type="text" id="orderRitiroConsegna" readonly placeholder="Auto-compilato">
                </div>
                <div class="form-group">
                    <label for="orderPosizione">Posizione Scaffale:</label>
                    <input type="text" id="orderPosizione" readonly placeholder="Auto-compilato">
                </div>
                <div class="form-group">
                    <label for="orderQuantity">Quantit√† (kg):</label>
                    <input type="number" id="orderQuantity" required min="0.1" step="0.1" placeholder="Quantit√† in kg">
                </div>
                <div class="form-group">
                    <label for="orderType">Tipo Ordine:</label>
                    <select id="orderType" required>
                        <option value="consegnato">üì¶ Consegnato</option>
                        <option value="ritira">üè™ Ritira Cliente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderDateTime">Data e Orario Consegna:</label>
                    <input type="datetime-local" id="orderDateTime" required>
                </div>
                <div class="form-group">
                    <label for="orderStatus">Stato:</label>
                    <select id="orderStatus" required>
                        <option value="pending">In Sospeso</option>
                        <option value="in_progress">In Lavorazione</option>
                        <option value="completed">Completato</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderNotes">Note:</label>
                    <textarea id="orderNotes" rows="3" placeholder="Note aggiuntive..."></textarea>
                </div>
                <div class="form-group">
                    <label>üîß Assegna Operatori (opzionale):</label>
                    <div id="orderOperatorsChecklist" style="display: flex; flex-direction: column; gap: 6px; padding: 8px; background: #3d3d3d; border-radius: 4px; border: 1px solid #4d4d4d;">
                        <!-- Checkboxes operatori generati dinamicamente -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let orders = [];
        let clienti = [];
        let articoli = [];
        let calendarDisplayMonth = new Date().getMonth();
        let calendarDisplayYear = new Date().getFullYear();
        // Tasks generati dagli ordini
        let orderTasks = [];
        // Operatori / Admin disponibili - caricati dall'API (come in admin-dashboard)
        let allOperators = [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let token = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        const API_URL = 'http://localhost:5000/api';
        
        // Log currentUser al caricamento
        console.log('üìã currentUser caricato:', currentUser);
        console.log('üîë Token:', token ? 'presente' : 'assente');

        // Carica operatori e admin dall'API (esattamente come in operators.html)
        async function loadOperators() {
            try {
                // Prova prima con localStorage se disponibile
                const cachedOperators = localStorage.getItem('cachedOperators');
                if (cachedOperators) {
                    try {
                        const cached = JSON.parse(cachedOperators);
                        // Se hanno il campo "role" (nuova cache con admin), usa la cache
                        if (cached.length > 0 && cached[0].role) {
                            // Riordina comunque: admin prima, operatori dopo
                            const admins = cached.filter(op => op.role === 'master').sort((a, b) => a.username.localeCompare(b.username));
                            const operators = cached.filter(op => op.role === 'slave').sort((a, b) => a.username.localeCompare(b.username));
                            allOperators = [...admins, ...operators];
                            console.log('‚úÖ Operatori caricati da cache locale (riordinati):', allOperators);
                            return;
                        } else {
                            // Cache vecchia, elimina e ricarica
                            localStorage.removeItem('cachedOperators');
                            console.log('‚ö†Ô∏è Cache vecchia eliminata, ricarica dall\'API');
                        }
                    } catch (e) {
                        console.warn('Cache corrotta, ricarica dall\'API');
                        localStorage.removeItem('cachedOperators');
                    }
                }
                
                console.log('üîÑ Caricamento operatori e admin dall\'API pubblica...');
                
                // Usa gli endpoint pubblici che NON richiedono autenticazione
                const operatorsResponse = await fetch(`${API_URL}/auth/operators/public`);
                const adminsResponse = await fetch(`${API_URL}/auth/admins/public`);

                console.log('Risposta API - Operators:', operatorsResponse.status, 'Admins:', adminsResponse.status);

                if (operatorsResponse.ok && adminsResponse.ok) {
                    const operators = await operatorsResponse.json();
                    const admins = await adminsResponse.json();
                    console.log('üìã Operatori ricevuti:', operators);
                    console.log('üìã Admin ricevuti:', admins);
                    // Ordina admin alfabeticamente
                    const sortedAdmins = admins.sort((a, b) => a.username.localeCompare(b.username));
                    // Ordina operatori alfabeticamente
                    const sortedOperators = operators.sort((a, b) => a.username.localeCompare(b.username));
                    // Combina: admin prima, poi operatori
                    allOperators = [...sortedAdmins, ...sortedOperators];
                    // Salva in cache
                    localStorage.setItem('cachedOperators', JSON.stringify(allOperators));
                    console.log('‚úÖ Operatori e Admin caricati dall\'API pubblica:', allOperators);
                } else {
                    console.warn('‚ö†Ô∏è Errore API (' + operatorsResponse.status + ', ' + adminsResponse.status + ') - usa default');
                    allOperators = [
                        { id: 1, username: 'Admin Mario', role: 'master' },
                        { id: 2, username: 'Admin Lucia', role: 'master' },
                        { id: 3, username: 'Operatore Paolo', role: 'operator' },
                        { id: 4, username: 'Operatore Sara', role: 'operator' }
                    ];
                }
            } catch (error) {
                console.error('‚ùå Errore caricamento operatori:', error);
                console.warn('Usa operatori di default');
                allOperators = [
                    { id: 1, username: 'Admin Mario', role: 'master' },
                    { id: 2, username: 'Admin Lucia', role: 'master' },
                    { id: 3, username: 'Operatore Paolo', role: 'operator' },
                    { id: 4, username: 'Operatore Sara', role: 'operator' }
                ];
            }
        }

        // Helper per ottenere array di nomi operatori
        function getOperatorNames() {
            return allOperators.map(op => op.username);
        }

        function getOperatorWithIcon(username) {
            const op = allOperators.find(o => o.username === username);
            if (!op) return username;
            const icon = op.role === 'master' ? 'üë®‚Äçüíº' : 'üë∑';
            const suffix = (currentUser.id === op.id) ? ' (per me)' : '';
            return icon + ' ' + username + suffix;
        }

        // Salvataggio / caricamento tasks
        function loadOrderTasks() {
            const stored = localStorage.getItem('orderTasks');
            orderTasks = stored ? JSON.parse(stored) : [];
        }
        function saveOrderTasks() {
            localStorage.setItem('orderTasks', JSON.stringify(orderTasks));
        }

        function generateTaskForOrder(order, assignedOperators = []) {
            // Evita duplicati se gi√† presente
            if (orderTasks.some(t => t.orderId === order.id)) return;
            const cliente = clienti.find(c => c.nome === order.client);
            const title = `${order.type === 'consegnato' ? 'Consegna' : 'Ritiro'} ${order.product} - ${order.client}`;
            
            // Crea task in memoria
            const newTask = {
                id: 'task-' + order.id,
                orderId: order.id,
                title,
                client: order.client,
                product: order.product,
                quantity: order.quantity,
                dateTime: order.dateTime,
                status: assignedOperators.length > 0 ? 'assigned' : 'unassigned',
                assignedTo: assignedOperators,
                autogenerated: true,
                notes: order.notes || '',
                clienteOrari: cliente ? {
                    apertura: cliente.orario_apertura,
                    chiusura: cliente.orario_chiusura,
                    consegna_inizio: cliente.orario_consegna_inizio,
                    consegna_fine: cliente.orario_consegna_fine
                } : null,
                createdAt: new Date().toISOString()
            };
            
            orderTasks.push(newTask);
            saveOrderTasks();
            
            // Salva nel database se loggato
            console.log('üîÑ generateTaskForOrder: currentUser=', currentUser, 'role=', currentUser?.role);
            if (currentUser?.id && currentUser?.role === 'master') {
                console.log('üíæ Salvo nel DB...');
                saveTaskToDatabase(newTask, assignedOperators);
            } else {
                console.warn('‚ö†Ô∏è Non loggato come admin - task solo locale');
            }
        }

        async function saveTaskToDatabase(task, assignedOperators) {
            try {
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                console.log('üîê Token in saveTaskToDatabase:', currentToken ? 'presente (' + currentToken.substring(0, 20) + '...)' : 'NULLO');
                if (!currentToken) {
                    console.warn('‚ö†Ô∏è Non loggato - task salvato solo localmente');
                    return;
                }
                
                // NON assegnare subito - lascialo come "da assegnare" per l'admin
                // Gli operatori suggeriti vanno nella descrizione
                const suggestedOps = assignedOperators.length > 0 ? `\nOperatori suggeriti: ${assignedOperators.join(', ')}` : '';
                
                const response = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        title: task.title,
                        description: `Cliente: ${task.client}\nProdotto: ${task.product}\nQuantit√†: ${task.quantity} kg\nNote: ${task.notes}${suggestedOps}`,
                        scheduledAt: task.dateTime,
                        assignedOperatorId: null,  // SEMPRE null - l'admin assegner√† dopo
                        estimatedMinutes: 60,
                        priority: 'MEDIUM'
                    })
                });
                
                if (response.ok) {
                    const savedTask = await response.json();
                    console.log('‚úÖ Task salvato nel database:', savedTask);
                    // Aggiorna l'id locale con quello del database
                    task.dbId = savedTask.id;
                } else {
                    console.warn('‚ö†Ô∏è Errore salvataggio task nel DB:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Errore:', error);
            }
        }

        function renderOrderTasks() {
            const grid = document.getElementById('orderTasksGrid');
            const countSpan = document.getElementById('tasksCount');
            if (!grid) return;
            if (orderTasks.length === 0) {
                grid.innerHTML = '<p style="color:#808080;grid-column:1/-1;text-align:center;padding:20px;">Nessun task generato. Creando ordini compariranno qui.</p>';
                countSpan.textContent = '(0)';
                return;
            }
            countSpan.textContent = `(${orderTasks.length})`;
            grid.innerHTML = orderTasks.map(task => {
                const assigned = task.assignedTo.length > 0;
                const statusBadge = assigned ? '<span style="background:#1e3a2a;color:#86efac;padding:2px 6px;border-radius:4px;font-size:10px;">Assegnato</span>' : '<span style="background:#4a3a1e;color:#fcd34d;padding:2px 6px;border-radius:4px;font-size:10px;">Da assegnare</span>';
                const operatorsHtml = assigned ? `<p style=\"margin:4px 0;\"><strong>Assegnato a:</strong> ${task.assignedTo.join(', ')}</p>` : '';
                const orariHtml = task.clienteOrari ? `<p style=\"margin:4px 0;\"><strong>Orari Cliente:</strong> ${task.clienteOrari.apertura}-${task.clienteOrari.chiusura} / Consegne ${task.clienteOrari.consegna_inizio}-${task.clienteOrari.consegna_fine}</p>` : '';
                return `<div class=\"order-card\" style=\"border-left:4px solid ${assigned ? '#16a34a' : '#f59e0b'};background:${assigned ? '#253524' : '#3d2f1e'};\">\n  <div class=\"order-header\">\n    <div class=\"order-title\" style=\"font-size:15px;\">üõ†Ô∏è ${task.title}</div>\n    ${statusBadge}\n  </div>\n  <div class=\"order-details\" style=\"font-size:12px;\">\n    <p style=\"margin:4px 0;\"><strong>Cliente:</strong> ${task.client}</p>\n    <p style=\"margin:4px 0;\"><strong>Prodotto:</strong> ${task.product}</p>\n    <p style=\"margin:4px 0;\"><strong>Quantit√†:</strong> ${task.quantity} kg</p>\n    <p style=\"margin:4px 0;\"><strong>Programmazione:</strong> ${task.dateTime ? new Date(task.dateTime).toLocaleString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'N/D'}</p>\n    ${orariHtml}\n    ${operatorsHtml}\n    ${task.notes ? `<p style=\\"margin:4px 0;\\"><strong>Note:</strong> ${task.notes}</p>` : ''}\n  </div>\n  <div class=\"order-actions\">\n    <button class=\"btn btn-warning\" onclick=\"openAssignTaskModal('${task.id}')\">üîß Assegna</button>\n    <button class=\"btn btn-primary\" onclick=\"markTaskCompleted('${task.id}')\">‚úì Completa</button>\n    <button class=\"btn btn-danger\" onclick=\"deleteOrderTask('${task.id}')\">üóëÔ∏è Elimina</button>\n  </div>\n</div>`;
            }).join('');
        }

        function openAssignTaskModal(taskId) {
            const modal = document.getElementById('assignTaskModal');
            const list = document.getElementById('operatorsChecklist');
            document.getElementById('assignTaskId').value = taskId;
            list.innerHTML = allOperators.map(op => {
                const task = orderTasks.find(t => t.id === taskId);
                const checked = task && task.assignedTo.includes(op.username) ? 'checked' : '';
                const icon = op.role === 'master' ? 'üë®‚Äçüíº' : 'üë∑';
                const suffix = (currentUser.id === op.id) ? ' (per me)' : '';
                return `<label style=\"display:flex;align-items:center;gap:6px;font-size:12px;margin:4px 0;\"><input type=\"checkbox\" value=\"${op.username}\" ${checked}> <span>${icon} ${op.username}${suffix}</span></label>`;
            }).join('');
            modal.classList.add('active');
        }
        function closeAssignTaskModal() {
            document.getElementById('assignTaskModal').classList.remove('active');
        }
        function assignTaskToOperators(e) {
            e.preventDefault();
            const taskId = document.getElementById('assignTaskId').value;
            const checkboxes = Array.from(document.querySelectorAll('#operatorsChecklist input[type=checkbox]'));
            const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
            const task = orderTasks.find(t => t.id === taskId);
            if (task) {
                task.assignedTo = selected;
                task.status = selected.length > 0 ? 'assigned' : 'unassigned';
                saveOrderTasks();
                renderOrderTasks();
            }
            closeAssignTaskModal();
        }
        function markTaskCompleted(taskId) {
            const task = orderTasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'completed';
                saveOrderTasks();
                renderOrderTasks();
            }
        }

        function deleteOrderTask(taskId) {
            orderTasks = orderTasks.filter(t => t.id !== taskId);
            saveOrderTasks();
            renderOrderTasks();
        }

        // Analizza CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index]?.trim() || '';
                });
                return obj;
            });
        }

        // Carica file CSV
        async function loadCSVData() {
            try {
                // Carica clienti
                const clientiResponse = await fetch('data/clienti.csv');
                const clientiText = await clientiResponse.text();
                clienti = parseCSV(clientiText);

                // Carica articoli
                const articoliResponse = await fetch('data/articoli.csv');
                const articoliText = await articoliResponse.text();
                articoli = parseCSV(articoliText);

                console.log('Clienti caricati:', clienti.length);
                console.log('Articoli caricati:', articoli.length);
            } catch (error) {
                console.error('Errore caricamento CSV:', error);
            }
        }

        // Carica ordini da localStorage
        function loadOrders() {
            const stored = localStorage.getItem('orders');
            orders = stored ? JSON.parse(stored) : [];
            renderOrders();
            updateStats();
            renderCalendar();
        }

        // Salva ordini in localStorage
        function saveOrders() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        // Apri modal ordine
        function openOrderModal() {
            // Popola dropdown clienti
            const clientSelect = document.getElementById('orderClient');
            clientSelect.innerHTML = '<option value="">-- Seleziona Cliente --</option>' +
                clienti.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');

            // Popola dropdown articoli
            const productSelect = document.getElementById('orderProduct');
            productSelect.innerHTML = '<option value="">-- Seleziona Articolo --</option>' +
                articoli.map(a => `<option value="${a.nome}">${a.codice} - ${a.nome}</option>`).join('');

            // Popola checklist operatori - verifica che siano gi√† caricati
            const checklistDiv = document.getElementById('orderOperatorsChecklist');
            if (allOperators.length > 0) {
                checklistDiv.innerHTML = allOperators.map(op => {
                    const icon = op.role === 'master' ? 'üë®‚Äçüíº' : 'üë∑';
                    const suffix = (currentUser.id === op.id) ? ' (per me)' : '';
                    return `
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" class="orderOperatorCheckbox" value="${op.username}" style="cursor: pointer;">
                        <span>${icon} ${op.username}${suffix}</span>
                    </label>
                `;
                }).join('');
            } else {
                checklistDiv.innerHTML = '<p style="color: #a0a0a0; font-size: 11px;">Caricamento operatori...</p>';
            }

            document.getElementById('orderModal').classList.add('active');
            document.getElementById('orderForm').reset();
        }

        // Chiudi modal ordine
        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        // Aggiorna informazioni cliente (orari)
        function updateClientInfo() {
            const selectedClient = document.getElementById('orderClient').value;
            const cliente = clienti.find(c => c.nome === selectedClient);
            const infoDiv = document.getElementById('clientHoursInfo');
            
            if (cliente && cliente.orario_apertura) {
                infoDiv.innerHTML = `
                    <strong>‚è∞ Orari Cliente:</strong><br>
                    Apertura: ${cliente.orario_apertura} - ${cliente.orario_chiusura}<br>
                    Finestra Consegne: ${cliente.orario_consegna_inizio} - ${cliente.orario_consegna_fine}
                `;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Aggiorna informazioni articolo (lotto, ritiro/consegna, posizione)
        function updateArticleInfo() {
            const selectedProduct = document.getElementById('orderProduct').value;
            const article = articoli.find(a => a.nome === selectedProduct);
            
            if (article) {
                document.getElementById('orderLotto').value = article.lotto || '';
                document.getElementById('orderRitiroConsegna').value = article.ritiro_consegna || '';
                document.getElementById('orderPosizione').value = article.posizione_scaffale || '';
            } else {
                document.getElementById('orderLotto').value = '';
                document.getElementById('orderRitiroConsegna').value = '';
                document.getElementById('orderPosizione').value = '';
            }
        }

        // Salva nuovo ordine
        function saveOrder(event) {
            event.preventDefault();
            
            // Raccogli operatori selezionati
            const selectedOperators = Array.from(document.querySelectorAll('.orderOperatorCheckbox:checked')).map(cb => cb.value);
            
            const order = {
                id: Date.now(),
                client: document.getElementById('orderClient').value,
                product: document.getElementById('orderProduct').value,
                quantity: parseFloat(document.getElementById('orderQuantity').value),
                type: document.getElementById('orderType').value,
                dateTime: document.getElementById('orderDateTime').value,
                status: document.getElementById('orderStatus').value,
                lotto: document.getElementById('orderLotto').value,
                ritiro_consegna: document.getElementById('orderRitiroConsegna').value,
                posizione: document.getElementById('orderPosizione').value,
                notes: document.getElementById('orderNotes').value,
                createdAt: new Date().toISOString()
            };

            orders.push(order);
            // Genera task associato all'ordine con operatori pre-assegnati
            console.log('üìù Nuovo ordine creato:', order.client, 'selectedOperators:', selectedOperators);
            generateTaskForOrder(order, selectedOperators);
            renderOrderTasks();
            saveOrders();
            renderOrders();
            updateStats();
            renderCalendar();
            closeOrderModal();
        }

        // Elimina ordine
        function deleteOrder(id) {
            orders = orders.filter(o => o.id !== id);
            saveOrders();
            renderOrders();
            updateStats();
            renderCalendar();
        }

        // Aggiorna stato ordine
        function updateOrderStatus(id, newStatus) {
            const order = orders.find(o => o.id === id);
            if (order) {
                order.status = newStatus;
                saveOrders();
                renderOrders();
                updateStats();
                renderCalendar();
            }
        }

        // Renderizza ordini
        function renderOrders() {
            const grid = document.getElementById('ordersGrid');
            
            if (orders.length === 0) {
                grid.innerHTML = '<p style="color: #808080; grid-column: 1/-1; text-align: center; padding: 20px;">Nessun ordine presente. Crea il primo ordine!</p>';
                return;
            }

            grid.innerHTML = orders.map(order => {
                const cliente = clienti.find(c => c.nome === order.client);
                const orariInfo = cliente ? `
                    <p><strong>Apertura:</strong> ${cliente.orario_apertura} - ${cliente.orario_chiusura}</p>
                    <p><strong>Finestra Consegne:</strong> ${cliente.orario_consegna_inizio} - ${cliente.orario_consegna_fine}</p>
                ` : '';
                
                return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-title">${order.client}</div>
                        <div class="order-status ${order.status}">${getStatusLabel(order.status)}</div>
                    </div>
                    <div class="order-details">
                        <p><strong>Prodotto:</strong> ${order.product}</p>
                        <p><strong>Quantit√†:</strong> ${order.quantity} kg</p>
                        <p><strong>Tipo:</strong> ${order.type === 'consegnato' ? 'üì¶ Consegnato' : 'üè™ Ritira Cliente'}</p>
                        <p><strong>Data e Orario:</strong> ${order.dateTime ? new Date(order.dateTime).toLocaleString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'N/D'}</p>
                        ${orariInfo}
                        ${order.lotto ? `<p><strong>Lotto:</strong> ${order.lotto}</p>` : ''}
                        ${order.ritiro_consegna ? `<p><strong>Ritiro/Consegna:</strong> ${order.ritiro_consegna}</p>` : ''}
                        ${order.posizione ? `<p><strong>Scaffale:</strong> ${order.posizione}</p>` : ''}
                        ${order.notes ? `<p><strong>Note:</strong> ${order.notes}</p>` : ''}
                    </div>
                    <div class="order-actions">
                        <button class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'completed')">‚úì Completa</button>
                        <button class="btn btn-danger" onclick="deleteOrder(${order.id})">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `}).join('');
        }

        // Ottieni etichetta stato
        function getStatusLabel(status) {
            const labels = {
                'pending': '‚è≥ Sospeso',
                'in_progress': '‚öôÔ∏è In Lavorazione',
                'completed': '‚úì Completato'
            };
            return labels[status] || status;
        }

        // Aggiorna statistiche
        function updateStats() {
            const total = orders.length;
            const pending = orders.filter(o => o.status !== 'completed').length;
            const completed = orders.filter(o => o.status === 'completed').length;

            document.getElementById('totalOrders').textContent = total;
            document.getElementById('pendingOrders').textContent = pending;
            document.getElementById('completedOrders').textContent = completed;
        }

        // Genera 15 ordini casuali per i prossimi 10 giorni
        function generateSampleOrders() {
            if (orders.length > 0) {
                const confirm = window.confirm('Ordini gi√† presenti. Vuoi aggiungere 15 nuovi ordini?');
                if (!confirm) return;
            }

            const statuses = ['pending', 'in_progress', 'completed'];
            const types = ['consegnato', 'ritira'];
            
            // Genera ordini raggruppati per giorno per calcolare carico e tempi
            const ordersByDay = {};
            const tempOrders = [];
            
            for (let i = 0; i < 15; i++) {
                const randomClient = clienti[Math.floor(Math.random() * clienti.length)];
                const randomProduct = articoli[Math.floor(Math.random() * articoli.length)];
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                const randomType = types[Math.floor(Math.random() * types.length)];
                const randomQuantity = (Math.random() * 49 + 1).toFixed(1);
                const randomDays = Math.floor(Math.random() * 11);
                
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + randomDays);
                const dateStr = String(dueDate.getFullYear()).padStart(4, '0') + '-' + 
                               String(dueDate.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(dueDate.getDate()).padStart(2, '0');

                if (!ordersByDay[dateStr]) {
                    ordersByDay[dateStr] = { deliveries: [], pickups: [] };
                }

                const orderData = {
                    client: randomClient.nome,
                    product: randomProduct.nome,
                    quantity: parseFloat(randomQuantity),
                    status: randomStatus,
                    lotto: randomProduct.lotto,
                    ritiro_consegna: randomProduct.ritiro_consegna,
                    posizione: randomProduct.posizione_scaffale
                };

                if (randomType === 'consegnato') {
                    ordersByDay[dateStr].deliveries.push(orderData);
                } else {
                    ordersByDay[dateStr].pickups.push(orderData);
                }
            }

            // Calcola orari con tempo variabile in base al carico giornaliero
            let orderId = Date.now();
            for (const [date, dayData] of Object.entries(ordersByDay)) {
                // Calcola carico totale del giorno (solo consegne)
                const totalLoad = dayData.deliveries.reduce((sum, o) => sum + o.quantity, 0);
                
                // Calcola tempo per consegna: 15-45 min in base al carico
                // Formula: minuti = 15 + (carico / 1200kg * 30)
                const loadFactor = Math.min(totalLoad / 1200, 1); // Normalizza a 0-1
                const minutesPerDelivery = Math.round(15 + (loadFactor * 30)); // 15-45 minuti
                
                let currentTime = 8 * 60; // Inizia alle 8:00 (in minuti)
                
                // Processa consegne con tempi progressivi
                dayData.deliveries.forEach((orderData) => {
                    const hours = Math.floor(currentTime / 60);
                    const minutes = currentTime % 60;
                    const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    
                    orders.push({
                        id: orderId++,
                        ...orderData,
                        type: 'consegnato',
                        dateTime: date + 'T' + timeStr,
                        notes: '',
                        createdAt: new Date().toISOString()
                    });
                    generateTaskForOrder(orders[orders.length - 1]);
                    
                    // Incrementa il tempo per la prossima consegna
                    currentTime += minutesPerDelivery;
                });
                
                // Processa ritiri con orari casuali
                dayData.pickups.forEach((orderData) => {
                    const randomHour = Math.floor(Math.random() * 11) + 8; // 8-18
                    const randomMin = Math.floor(Math.random() * 60);
                    const timeStr = `${String(randomHour).padStart(2, '0')}:${String(randomMin).padStart(2, '0')}`;
                    
                    orders.push({
                        id: orderId++,
                        ...orderData,
                        type: 'ritira',
                        dateTime: date + 'T' + timeStr,
                        notes: '',
                        createdAt: new Date().toISOString()
                    });
                    generateTaskForOrder(orders[orders.length - 1]);
                });
            }
            
            saveOrders();
            renderOrderTasks();
            renderOrders();
            updateStats();
            renderCalendar();
            alert('‚úÖ 15 ordini generati con successo!');
        }

        // Torna indietro
        function goBack() {
            window.history.back();
        }

        // Renderizza calendario
        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            
            const year = calendarDisplayYear;
            const month = calendarDisplayMonth;
            
            // Aggiorna il titolo del mese
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                               'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const dayNames = ['Do', 'Lu', 'Ma', 'Me', 'Gi', 'Ve', 'Sa'];
            let html = dayNames.map(day => `<div style="font-weight: bold; text-align: center; padding: 6px; background: #3d3d3d; border: 1px solid #4d4d4d; border-radius: 4px; font-size: 11px; color: #b0b0b0;">${day}</div>`).join('');
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                // Crea una stringa di data in formato YYYY-MM-DD
                const dateStr = String(year).padStart(4, '0') + '-' + 
                               String(month + 1).padStart(2, '0') + '-' + 
                               String(day).padStart(2, '0');
                
                // Conta ordini con data schedulata
                const dayOrders = orders.filter(order => {
                    if (!order.dateTime) return false;
                    return order.dateTime.startsWith(dateStr);
                });

                // Estrai orari di consegna (senza duplicati)
                const deliveryTimes = [...new Set(
                    dayOrders
                        .filter(o => o.type === 'consegnato')
                        .map(o => o.dateTime.slice(11, 16))
                )].sort();
                
                const totalOrders = dayOrders.length;
                const hasOrdersClass = totalOrders > 0 ? 'has-orders' : '';
                
                // Mostra orari di consegna compatti
                const timesDisplay = deliveryTimes.length > 0 ? 
                    `<div style="font-size: 8px; margin-top: 2px; color: #86efac; font-weight: bold;">${deliveryTimes.join(', ')}</div>` : 
                    '';
                
                html += `<div class="calendar-day ${hasOrdersClass}" style="cursor: pointer;" onclick="showDayOrdersModal('${dateStr}')"><strong>${day}</strong><div style="font-size: 9px; margin-top: 2px;">${totalOrders} ordini</div>${timesDisplay}</div>`;
            }
            
            container.innerHTML = html;
        }
        
        function previousMonth() {
            calendarDisplayMonth--;
            if (calendarDisplayMonth < 0) {
                calendarDisplayMonth = 11;
                calendarDisplayYear--;
            }
            renderCalendar();
        }
        
        function nextMonth() {
            calendarDisplayMonth++;
            if (calendarDisplayMonth > 11) {
                calendarDisplayMonth = 0;
                calendarDisplayYear++;
            }
            renderCalendar();
        }

        // Mostra ordini del giorno in modal
        function showDayOrdersModal(dateStr) {
            const dayOrdersList = document.getElementById('dayOrdersList');
            const dayOrdersCard = document.getElementById('dayOrdersCard');
            const dayOrdersTitle = document.getElementById('dayOrdersTitle');

            // Filtra gli ordini per il giorno selezionato
            const dayOrders = orders.filter(order => {
                if (!order.dateTime) return false;
                return order.dateTime.startsWith(dateStr);
            });

            // Formatta la data per il display
            const date = new Date(dateStr + 'T00:00:00');
            const dayNames = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const dayName = dayNames[date.getDay()];
            const formatted = date.toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' });
            dayOrdersTitle.textContent = `üìã Ordini di ${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formatted}`;

            if (dayOrders.length === 0) {
                dayOrdersList.innerHTML = '<div class="empty-state">Nessun ordine per questo giorno</div>';
                dayOrdersCard.style.display = 'block';
                return;
            }

            // Crea le card degli ordini
            dayOrdersList.innerHTML = dayOrders.map(order => {
                const cliente = clienti.find(c => c.nome === order.client);
                const orariInfo = cliente ? `
                    <p><strong>Apertura:</strong> ${cliente.orario_apertura} - ${cliente.orario_chiusura}</p>
                    <p><strong>Finestra Consegne:</strong> ${cliente.orario_consegna_inizio} - ${cliente.orario_consegna_fine}</p>
                ` : '';
                
                return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-title">${order.client}</div>
                        <div class="order-status ${order.status}">${getStatusLabel(order.status)}</div>
                    </div>
                    <div class="order-details">
                        <p><strong>Prodotto:</strong> ${order.product}</p>
                        <p><strong>Quantit√†:</strong> ${order.quantity} kg</p>
                        <p><strong>Tipo:</strong> ${order.type === 'consegnato' ? 'üì¶ Consegnato' : 'üè™ Ritira Cliente'}</p>
                        <p><strong>Data e Orario:</strong> ${order.dateTime ? new Date(order.dateTime).toLocaleString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'N/D'}</p>
                        ${orariInfo}
                        ${order.lotto ? `<p><strong>Lotto:</strong> ${order.lotto}</p>` : ''}
                        ${order.ritiro_consegna ? `<p><strong>Ritiro/Consegna:</strong> ${order.ritiro_consegna}</p>` : ''}
                        ${order.posizione ? `<p><strong>Scaffale:</strong> ${order.posizione}</p>` : ''}
                        ${order.notes ? `<p><strong>Note:</strong> ${order.notes}</p>` : ''}
                    </div>
                    <div class="order-actions">
                        <button class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'completed')">‚úì Completa</button>
                        <button class="btn btn-danger" onclick="deleteOrder(${order.id})">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `}).join('');

            dayOrdersCard.style.display = 'block';

            // Scroll automatico verso la card
            setTimeout(() => {
                dayOrdersCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Chiudi la card degli ordini del giorno
        function closeDayOrdersCard() {
            document.getElementById('dayOrdersCard').style.display = 'none';
        }

        // Inizializza
        window.addEventListener('load', async () => {
            await loadOperators();
            await loadCSVData();
            loadOrders();
            loadOrderTasks();
            renderOrderTasks();
            renderCalendar();
        });
    </script>

    <!-- Modal Assegna Task -->
    <div id="assignTaskModal" class="modal">
        <div class="modal-content" style="max-width:420px;">
            <h2 style="margin-top:0;font-size:16px;">üîß Assegna Task Ordine</h2>
            <form onsubmit="assignTaskToOperators(event)">
                <input type="hidden" id="assignTaskId">
                <div id="operatorsChecklist" style="display:flex;flex-direction:column;margin-bottom:12px;"></div>
                <div class="modal-actions" style="margin-top:10px;">
                    <button type="submit" class="btn btn-primary">üíæ Salva Assegnazione</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAssignTaskModal()">‚ùå Chiudi</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
