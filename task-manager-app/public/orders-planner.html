<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Ordini - Molino Briganti</title>
    <link rel="stylesheet" href="css/common.css">
    <script src="js/settings-utils.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ea580c;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header styles unified via css/common.css */

        /* Base button styles moved to css/common.css. Page keeps only contextual overrides. */

        .card {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .card {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 12px;
                border-radius: 6px;
            }
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        @media (max-width: 768px) {
            .card h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }
        }

        @media (max-width: 480px) {
            .card h2 {
                font-size: 14px;
                margin-bottom: 10px;
            }
        }

        .orders-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .order-card {
            background: #3d3d3d;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #4d4d4d;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.5);
            border-color: #5d5d5d;
        }

        @media (max-width: 768px) {
            .order-card {
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .order-card {
                padding: 10px;
            }
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .order-title {
            font-weight: 600;
            color: #e0e0e0;
              font-size: 20px;
        }

        @media (max-width: 768px) {
            .order-title {
                 font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .order-title {
                 font-size: 16px;
            }
        }

        .order-status {
            font-size: 15px;
            padding: 6px 10px;
            border-radius: 4px;
            background: #1e3a4d;
            color: #7dd3fc;
        }

        .order-status.pending {
            background: #4a3a1e;
            color: #fcd34d;
        }

        .order-status.completed {
            background: #1e3a2a;
            color: #86efac;
        }

        .order-details {
            font-size: 16px;
            color: #a0a0a0;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .order-details {
                 font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            .order-details {
                 font-size: 15px;
            }
        }

        .order-details p {
            margin: 5px 0;
        }

        .order-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .order-actions {
                gap: 6px;
            }

            .order-actions .btn {
                padding: 5px 8px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .order-actions {
                flex-direction: column;
                gap: 6px;
            }

            .order-actions .btn {
                padding: 6px 8px;
                font-size: 11px;
                width: 100%;
                justify-content: center;
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
            color: #e0e0e0;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #4d4d4d;
            border-radius: 6px;
            font-size: 14px;
            background: #3d3d3d;
            color: #e0e0e0;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 50px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            padding: 6px 10px;
            min-height: 16px;
            font-size: 11px;
            flex: 0 1 auto;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2d2d2d;
            padding: 3px 4px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-left: 4px solid var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 20px;
        }

        .stat-number {
            font-size: 12px;
            font-weight: bold;
            color: #e0e0e0;
            margin-bottom: 0px;
        }

        .stat-label {
            font-size: 8px;
            color: #a0a0a0;
        }

        /* Planner Actions (below stats) - aligned to Trips Management */
        .planner-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .planner-actions .btn {
            padding: 10px 12px;
            min-height: 40px;
            font-size: 13px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .planner-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            .planner-actions .btn {
                padding: 10px 12px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .planner-actions {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 12px;
            }

            .stat-card {
                min-height: 18px;
                padding: 2px 3px;
            }

            .stat-number {
                font-size: 11px;
            }

            .stat-label {
                font-size: 7px;
            }
        }

        @media (max-width: 480px) {
            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
                gap: 10px;
            }

            .stat-card {
                min-height: 16px;
                padding: 2px 3px;
            }

            .stat-number {
                font-size: 10px;
            }

            .stat-label {
                font-size: 6px;
            }
        }

        .calendar-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 10px 0;
        }

        .calendar-header-day {
            font-weight: 700;
            text-align: center;
            padding: 6px;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            border-radius: 4px;
            font-size: 12px; /* match admin dashboard */
            color: #b0b0b0;
        }

        .calendar-day {
            border: 1px solid #4d4d4d;
            padding: 6px;
            min-height: 50px;
            border-radius: 4px;
            background: #3d3d3d;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            color: #b0b0b0;
            position: relative;
            overflow: hidden;
        }

        .calendar-day:hover {
            background: #4d4d4d;
        }

        .calendar-day.has-orders {
            background: #1e2a4d;
            border-color: var(--primary);
            position: relative;
        }

        .calendar-day.has-unassigned-orders {
            position: relative;
        }

        .calendar-day.has-unassigned-orders::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 18px 0 0 18px;
            border-color: transparent transparent transparent #ff9800;
            border-radius: 0 0 0 4px;
        }

        .calendar-day.has-orders::before {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 18px 18px;
            border-color: transparent transparent var(--primary) transparent;
            border-radius: 0 0 4px 0;
        }

        

        @media (max-width: 768px) {
            .calendar-day {
                min-height: 40px;
                padding: 6px;
                font-size: 16px;
            }
            
        }

        @media (max-width: 480px) {
            .calendar-day {
                min-height: 35px;
                padding: 3px;
                font-size: 9px;
            }
            
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #808080;
            font-size: 12px;
        }

        /* Desktop calendar header */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .calendar-btn-dummy, .calendar-btn-toggle {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Tablet and up: equalize header button widths */
        @media (min-width: 768px) {
            .calendar-btn-dummy, .calendar-btn-toggle {
                width: 160px;
                text-align: center;
            }
        }

        .calendar-btn-prev, .calendar-btn-next {
            padding: 8px 12px;
            font-size: 16px;
            min-width: 40px;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-title {
            margin: 0;
            color: #e0e0e0;
            font-size: 16px;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        @media (max-width: 768px) {
            /* Tablet: stack toggle button below */
            .calendar-header {
                display: grid !important;
                grid-template-columns: 40px 1fr 40px;
                grid-template-rows: auto auto;
                gap: 8px;
                margin-bottom: 15px;
            }

            .calendar-btn-prev {
                grid-column: 1;
                grid-row: 1;
            }

            .calendar-title {
                grid-column: 2;
                grid-row: 1;
            }

            .calendar-btn-next {
                grid-column: 3;
                grid-row: 1;
            }

            .calendar-btn-toggle {
                grid-column: 1 / -1;
                grid-row: 2;
                width: 100%;
                font-size: 13px;
                padding: 8px 12px;
            }
        }

        @media (max-width: 480px) {
            /* Mobile: 2 buttons on row 1, navigation on row 2 */
            .calendar-header {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                gap: 8px;
                margin-bottom: 15px;
            }

            /* First row: 2 buttons */
            .calendar-btn-dummy {
                grid-column: 1;
                grid-row: 1;
                padding: 10px 12px;
                font-size: 13px;
            }

            .calendar-btn-toggle {
                grid-column: 2;
                grid-row: 1;
                padding: 10px 12px;
                font-size: 13px;
            }

            /* Second row: navigation controls */
            .calendar-btn-prev {
                grid-column: 1 / -1;
                grid-row: 2;
                width: 40px !important;
                height: 40px;
                padding: 0 !important;
                font-size: 18px !important;
                min-width: 40px !important;
                max-width: 40px !important;
                justify-self: start;
            }

            .calendar-title {
                grid-column: 1 / -1;
                grid-row: 2;
                font-size: 13px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 0;
                margin: 0 50px;
            }

            .calendar-btn-next {
                grid-column: 1 / -1;
                grid-row: 2;
                width: 40px !important;
                height: 40px;
                padding: 0 !important;
                font-size: 18px !important;
                min-width: 40px !important;
                max-width: 40px !important;
                justify-self: end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="images/logo INSEGNA.png" alt="Molino Briganti Logo">
                </div>
                <div class="header-title">
                    <h1>üì¶ Planner Ordini</h1>
                    <div class="user-info" id="userInfo"></div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="goBack()">‚Üê Indietro</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">0</div>
                <div class="stat-label">Ordini Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingOrders">0</div>
                <div class="stat-label">In Sospeso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedOrders">0</div>
                <div class="stat-label">Completati</div>
            </div>
        </div>

        <!-- Planner Actions moved below stats -->
        <div class="planner-actions">
            <button class="btn btn-primary" onclick="openOrderModal()">‚ûï Nuovo Ordine</button>
            <button class="btn btn-success" onclick="window.location.href='trips-management.html'">üöö Gestione Viaggi</button>
            <button class="btn btn-warning" onclick="generateSampleOrders()">üîÑ Genera Dati</button>
        </div>

        <!-- Calendar -->
        <div class="card" style="padding: 12px;">
            <div class="calendar-header">
                <button class="btn btn-secondary calendar-btn-dummy" onclick="toggleShowAllOrders()" id="toggleShowAllBtn2">üëÅÔ∏è Visualizza Tutti</button>
                <button class="btn btn-primary calendar-btn-prev" onclick="previousPeriod()">‚óÄ</button>
                <h4 id="calendarMonthYear" class="calendar-title"></h4>
                <button class="btn btn-primary calendar-btn-next" onclick="nextPeriod()">‚ñ∂</button>
                <button class="btn btn-secondary calendar-btn-toggle" onclick="toggleCalendarView()" id="toggleCalendarBtn">üóìÔ∏è Settimana</button>
            </div>
            <div id="calendarContainer" class="calendar-container">
                <!-- Calendar will be generated here -->
            </div>
        </div>

        <!-- Unified Orders Section -->
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
                <h2 style="display:flex;align-items:center;gap:6px;margin:0;">üìã Ordini <span id="tasksCount" style="font-size:11px;color:#a0a0a0;font-weight:400;"></span></h2>
            </div>
            <div class="orders-grid" id="orderTasksGrid">
                <!-- Orders will appear here -->
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <h2>üìù Nuovo Ordine</h2>
            <form id="orderForm" onsubmit="saveOrder(event)">
                <div class="form-group">
                    <label for="orderClient">Cliente:</label>
                    <select id="orderClient" required onchange="updateClientInfo()">
                        <option value="">-- Seleziona Cliente --</option>
                    </select>
                    <div id="clientHoursInfo" style="margin-top: 8px; font-size: 12px; color: #86efac; display: none;">
                        <!-- Client hours will be displayed here -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="orderProduct">Articolo:</label>
                    <select id="orderProduct" required onchange="updateArticleInfo()">
                        <option value="">-- Seleziona Articolo --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderLotto">Lotto:</label>
                    <input type="text" id="orderLotto" readonly placeholder="Auto-compilato">
                </div>
                <div class="form-group">
                    <label for="orderRitiroConsegna">Ritiro/Consegna:</label>
                    <input type="text" id="orderRitiroConsegna" readonly placeholder="Auto-compilato">
                </div>
                <div class="form-group">
                    <label for="orderPosizione">Posizione Scaffale:</label>
                    <input type="text" id="orderPosizione" readonly placeholder="Auto-compilato">
                </div>
                <div class="form-group">
                    <label for="orderQuantity">Quantit√† (kg):</label>
                    <input type="number" id="orderQuantity" required min="0.1" step="0.1" placeholder="Quantit√† in kg">
                </div>
                <div class="form-group">
                    <label for="orderType">Tipo Ordine:</label>
                    <select id="orderType" required>
                        <option value="consegnato">üì¶ Consegnato</option>
                        <option value="ritira">üè™ Ritira Cliente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderDateTime">Data e Orario Consegna:</label>
                    <input type="datetime-local" id="orderDateTime" required>
                </div>
                <div class="form-group">
                    <label for="orderNotes">Note:</label>
                    <textarea id="orderNotes" rows="3" placeholder="Note aggiuntive..."></textarea>
                </div>
                <!-- Sezione: Assegna a Viaggio o Operatore -->
                <div id="assignmentSection" class="section" style="border-top:1px solid #4d4d4d;margin-top:10px;padding-top:10px;">
                    <div class="form-group">
                        <label for="assignToTrip">üìã Assegna a Viaggio Esistente:</label>
                        <select id="assignToTrip">
                            <option value="">-- Nessuno (crea viaggio nuovo) --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assignToOperator">üë§ Assegna a Operatore:</label>
                        <select id="assignToOperator">
                            <option value="">-- Non assegnato --</option>
                        </select>
                    </div>
                </div>
                <!-- Opzioni per consegna: crea viaggio e assegna task -->
                <div id="deliveryTripOptions" class="section" style="display:none;border-top:1px solid #4d4d4d;margin-top:10px;padding-top:10px;">
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <input type="checkbox" id="createTripNow"> Crea subito un viaggio e il relativo task
                    </label>
                    <div id="tripFields" style="display:none;">
                        <div class="form-row" style="grid-template-columns:1fr 160px;">
                            <div class="form-group">
                                <label for="tripNameInline">Nome Viaggio</label>
                                <input type="text" id="tripNameInline" placeholder="Es: Consegne del ...">
                            </div>
                            <div class="form-group">
                                <label for="tripDateInline">Data Viaggio</label>
                                <input type="date" id="tripDateInline">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tripOperatorInline">Assegna a Operatore (opzionale)</label>
                            <select id="tripOperatorInline">
                                <option value="">-- Non assegnato --</option>
                            </select>
                        </div>
                        <div style="font-size:12px;color:#a0a0a0;">Se selezioni un operatore, il task del viaggio verr√† assegnato direttamente.</div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let orders = [];
        let clienti = [];
        let articoli = [];
        let calendarDisplayMonth = new Date().getMonth();
        let calendarDisplayYear = new Date().getFullYear();
        // Tasks generati dagli ordini
        let orderTasks = [];
        // Operatori / Admin disponibili - caricati dall'API (come in admin-dashboard)
        let allOperators = [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let token = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        const API_URL = 'http://localhost:5000/api';
        function fmtLocalDateTime(d){
            const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0');
            const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0');
            return `${y}-${m}-${da}T${hh}:${mm}`;
        }
        function fmtLocalDate(d){
            const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${da}`;
        }
        
        // Sistema viaggi
        let trips = []; // Array di viaggi: {id, name, date, orderIds: [], sequence: []}
        
        // Calendario
        let calendarViewMode = 'week'; // 'week' o 'month'
        let weekStartDate = new Date();
        weekStartDate.setDate(weekStartDate.getDate() - weekStartDate.getDay()); // Domenica
        
        // Filtro ordini
        let showAllOrders = false; // false = solo oggi, true = tutti
        let selectedDate = null; // Data specifica selezionata dal calendario (null = oggi)
        
        // Log currentUser al caricamento
        console.log('üìã currentUser caricato:', currentUser);
        console.log('üîë Token:', token ? 'presente' : 'assente');

        // Carica operatori e admin dall'API (esattamente come in operators.html)
        async function loadOperators() {
            try {
                // Prova prima con localStorage se disponibile
                const cachedOperators = localStorage.getItem('cachedOperators');
                if (cachedOperators) {
                    try {
                        const cached = JSON.parse(cachedOperators);
                        // Se hanno il campo "role" (nuova cache con admin), usa la cache
                        if (cached.length > 0 && cached[0].role) {
                            // Riordina comunque: admin prima, operatori dopo
                            const admins = cached.filter(op => op.role === 'master').sort((a, b) => a.username.localeCompare(b.username));
                            const operators = cached.filter(op => op.role === 'slave').sort((a, b) => a.username.localeCompare(b.username));
                            allOperators = [...admins, ...operators];
                            console.log('‚úÖ Operatori caricati da cache locale (riordinati):', allOperators);
                            return;
                        } else {
                            // Cache vecchia, elimina e ricarica
                            localStorage.removeItem('cachedOperators');
                            console.log('‚ö†Ô∏è Cache vecchia eliminata, ricarica dall\'API');
                        }
                    } catch (e) {
                        console.warn('Cache corrotta, ricarica dall\'API');
                        localStorage.removeItem('cachedOperators');
                    }
                }
                
                console.log('üîÑ Caricamento operatori e admin dall\'API pubblica...');
                
                // Usa gli endpoint pubblici che NON richiedono autenticazione
                const operatorsResponse = await fetch(`${API_URL}/auth/operators/public`);
                const adminsResponse = await fetch(`${API_URL}/auth/admins/public`);

                console.log('Risposta API - Operators:', operatorsResponse.status, 'Admins:', adminsResponse.status);

                if (operatorsResponse.ok && adminsResponse.ok) {
                    const operators = await operatorsResponse.json();
                    const admins = await adminsResponse.json();
                    console.log('üìã Operatori ricevuti:', operators);
                    console.log('üìã Admin ricevuti:', admins);
                    // Ordina admin alfabeticamente
                    const sortedAdmins = admins.sort((a, b) => a.username.localeCompare(b.username));
                    // Ordina operatori alfabeticamente
                    const sortedOperators = operators.sort((a, b) => a.username.localeCompare(b.username));
                    // Combina: admin prima, poi operatori
                    allOperators = [...sortedAdmins, ...sortedOperators];
                    // Salva in cache
                    localStorage.setItem('cachedOperators', JSON.stringify(allOperators));
                    console.log('‚úÖ Operatori e Admin caricati dall\'API pubblica:', allOperators);
                } else {
                    console.warn('‚ö†Ô∏è Errore API (' + operatorsResponse.status + ', ' + adminsResponse.status + ') - usa default');
                    allOperators = [
                        { id: 1, username: 'Admin Mario', role: 'master' },
                        { id: 2, username: 'Admin Lucia', role: 'master' },
                        { id: 3, username: 'Operatore Paolo', role: 'operator' },
                        { id: 4, username: 'Operatore Sara', role: 'operator' }
                    ];
                }
            } catch (error) {
                console.error('‚ùå Errore caricamento operatori:', error);
                console.warn('Usa operatori di default');
                allOperators = [
                    { id: 1, username: 'Admin Mario', role: 'master' },
                    { id: 2, username: 'Admin Lucia', role: 'master' },
                    { id: 3, username: 'Operatore Paolo', role: 'operator' },
                    { id: 4, username: 'Operatore Sara', role: 'operator' }
                ];
            }
        }

        // Helper per ottenere array di nomi operatori
        function getOperatorNames() {
            return allOperators.map(op => op.username);
        }

        function getOperatorWithIcon(username) {
            const op = allOperators.find(o => o.username === username);
            if (!op) return username;
            const icon = op.role === 'master' ? 'üë®‚Äçüíº' : 'üë∑';
            const suffix = (currentUser.id === op.id) ? ' (per me)' : '';
            return icon + ' ' + username + suffix;
        }

        // Salvataggio / caricamento tasks
        function loadOrderTasks() {
            const stored = localStorage.getItem('orderTasks');
            orderTasks = stored ? JSON.parse(stored) : [];

            // Migrazioni: titoli e struttura ID DB
            try {
                let changed = false;
                // 1) Normalizza titoli a "consegna/ritiro - cliente"
                orderTasks.forEach(t => {
                    const relatedOrder = Array.isArray(orders) ? orders.find(o => o.id === t.orderId) : null;
                    let typeWord = 'consegna';
                    if (relatedOrder && relatedOrder.type) {
                        typeWord = relatedOrder.type === 'consegnato' ? 'consegna' : 'ritiro';
                    } else if (t.title && /ritiro/i.test(t.title)) {
                        typeWord = 'ritiro';
                    }
                    const clientLower = String((relatedOrder && relatedOrder.client) || t.client || '').toLowerCase();
                    const normalized = `${typeWord} - ${clientLower}`;
                    if (t.title !== normalized) {
                        t.title = normalized;
                        changed = true;
                    }
                });
                // 2) Normalizza tracking ID DB (evita duplicati)
                orderTasks.forEach(t => {
                    if (!t.dbIdsByOperator || typeof t.dbIdsByOperator !== 'object') {
                        t.dbIdsByOperator = {};
                        changed = true;
                    }
                    if (t.dbId && Array.isArray(t.assignedTo)) {
                        if (t.assignedTo.length === 0) {
                            if (!t.dbIdUnassigned) {
                                t.dbIdUnassigned = t.dbId;
                            }
                            delete t.dbId;
                            changed = true;
                        } else {
                            const first = t.assignedTo[0];
                            if (!t.dbIdsByOperator[first]) {
                                t.dbIdsByOperator[first] = t.dbId;
                            }
                            delete t.dbId;
                            changed = true;
                        }
                    }
                });
                if (changed) {
                    saveOrderTasks();
                }
            } catch (e) {
                console.warn('Migrazione task fallita:', e);
            }
        }
        function saveOrderTasks() {
            localStorage.setItem('orderTasks', JSON.stringify(orderTasks));
        }

        function generateTaskForOrder(order, assignedOperators = []) {
            // Le CONSEGNE non generano task individuali - solo i VIAGGI generano task
            if (order.type === 'consegnato') {
                console.log('üì¶ Consegna: il task verr√† creato quando aggiungi l\'ordine a un viaggio');
                return;
            }
            
            // Solo per RITIRI: genera task individuale
            // Evita duplicati se gi√† presente
            if (orderTasks.some(t => t.orderId === order.id)) return;
            const cliente = clienti.find(c => c.nome === order.client);
            const title = `ritiro - ${String(order.client || '').toLowerCase()}`;
            
            // Crea task in memoria
            const newTask = {
                id: 'task-' + order.id,
                orderId: order.id,
                title,
                client: order.client,
                product: order.product,
                quantity: order.quantity,
                dateTime: order.dateTime,
                status: 'unassigned',
                assignedTo: [],
                autogenerated: true,
                notes: order.notes || '',
                clienteOrari: cliente ? {
                    apertura: cliente.orario_apertura,
                    chiusura: cliente.orario_chiusura,
                    consegna_inizio: cliente.orario_consegna_inizio,
                    consegna_fine: cliente.orario_consegna_fine
                } : null,
                createdAt: new Date().toISOString(),
                dbIdsByOperator: {},
                dbIdUnassigned: null
            };
            
            orderTasks.push(newTask);
            saveOrderTasks();
            
            // Salva nel DB solo per ritiri (non assegnato - l'admin lo assegner√†)
            if (currentUser?.id && currentUser?.role === 'master') {
                saveTaskToDatabase(newTask, []);
            } else {
                console.warn('‚ö†Ô∏è Non loggato come admin - task solo locale');
            }
        }

        async function saveTaskToDatabase(task, assignedOperators) {
            try {
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                console.log('üîê Token in saveTaskToDatabase:', currentToken ? 'presente (' + currentToken.substring(0, 20) + '...)' : 'NULLO');
                if (!currentToken) {
                    console.warn('‚ö†Ô∏è Non loggato - task salvato solo localmente');
                    return;
                }
                
                // NON assegnare subito - lascialo come "da assegnare" per l'admin
                // Gli operatori suggeriti vanno nella descrizione
                const suggestedOps = assignedOperators.length > 0 ? `\nOperatori suggeriti: ${assignedOperators.join(', ')}` : '';
                
                const response = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        title: task.title,
                        description: `Cliente: ${task.client}\nProdotto: ${task.product}\nQuantit√†: ${task.quantity} kg\nNote: ${task.notes}${suggestedOps}`,
                        scheduledAt: task.dateTime,
                        assignedOperatorId: null,  // SEMPRE null - l'admin assegner√† dopo
                        estimatedMinutes: 60,
                        priority: 'MEDIUM'
                    })
                });
                
                if (response.ok) {
                    const savedTask = await response.json();
                    console.log('‚úÖ Task salvato nel database:', savedTask);
                    // Aggiorna l'id locale con quello del database
                    task.dbId = savedTask.id;
                } else {
                    console.warn('‚ö†Ô∏è Errore salvataggio task nel DB:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Errore:', error);
            }
        }

        // Helpers to sync 'ritiro' tasks to operators in backend so they appear in operator dashboards
        function getOperatorIdByUsername(username) {
            const op = allOperators.find(o => o.username === username);
            return op ? op.id : null;
        }

        async function updateDbTaskAssignedOperator(taskDbId, operatorId) {
            try {
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken || !taskDbId || !operatorId) return;
                await fetch(`${API_URL}/tasks/${taskDbId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ assignedOperatorId: operatorId })
                });
            } catch (e) {
                console.warn('Errore aggiornamento assegnazione task DB:', e);
            }
        }

        async function createDbTaskForOperator(task, operatorId) {
            try {
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken) return null;
                const resp = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        title: task.title,
                        description: `Cliente: ${task.client}\nProdotto: ${task.product}\nQuantit√†: ${task.quantity} kg\nNote: ${task.notes || ''}`,
                        scheduledAt: task.dateTime,
                        assignedOperatorId: operatorId || null,
                        estimatedMinutes: 60,
                        priority: 'MEDIUM'
                    })
                });
                if (resp.ok) {
                    const saved = await resp.json();
                    return saved;
                }
            } catch (e) {
                console.warn('Errore creazione task DB per operatore:', e);
            }
            return null;
        }

        async function deleteDbTask(taskDbId) {
            try {
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken || !taskDbId) return;
                await fetch(`${API_URL}/tasks/${taskDbId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
            } catch (e) {
                console.warn('Errore cancellazione task DB:', e);
            }
        }

        async function deleteBackendEntriesForTask(task) {
            try {
                // Elimina placeholder non assegnato
                if (task.dbIdUnassigned) {
                    await deleteDbTask(task.dbIdUnassigned);
                    task.dbIdUnassigned = null;
                }
                // Elimina mappature per operatore
                if (task.dbIdsByOperator && typeof task.dbIdsByOperator === 'object') {
                    for (const [username, id] of Object.entries(task.dbIdsByOperator)) {
                        if (id) await deleteDbTask(id);
                    }
                    task.dbIdsByOperator = {};
                }
                // Compat: elimina vecchio dbId singolo se presente
                if (task.dbId) {
                    await deleteDbTask(task.dbId);
                    delete task.dbId;
                }
            } catch (e) {
                console.warn('Errore cleanup backend task per ordine:', e);
            }
        }

        async function upsertRitiroTasksForOperators(task, selectedUsernames) {
            try {
                const relatedOrder = orders.find(o => o.id === task.orderId);
                if (!relatedOrder || relatedOrder.type !== 'ritira') return; // solo per ritiro
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken) return; // serve login admin per scrivere nel DB

                // Normalizza struttura di tracking
                if (!task.dbIdsByOperator || typeof task.dbIdsByOperator !== 'object') {
                    task.dbIdsByOperator = {};
                }
                const selected = Array.isArray(selectedUsernames) ? Array.from(new Set(selectedUsernames)) : [];
                const existingUsernames = Object.keys(task.dbIdsByOperator);

                const toId = (username) => getOperatorIdByUsername(username);

                if (selected.length === 0) {
                    // Nessun operatore selezionato: elimina task per-operator e crea/garantisci placeholder non assegnato
                    for (const u of existingUsernames) {
                        const id = task.dbIdsByOperator[u];
                        if (id) await deleteDbTask(id);
                    }
                    task.dbIdsByOperator = {};

                    // migra eventuale vecchio dbId
                    if (task.dbId && !task.dbIdUnassigned) {
                        task.dbIdUnassigned = task.dbId;
                        delete task.dbId;
                    }

                    if (!task.dbIdUnassigned) {
                        const created = await createDbTaskForOperator(task, null);
                        if (created?.id) task.dbIdUnassigned = created.id;
                    }
                    saveOrderTasks();
                    return;
                }

                // Almeno un operatore selezionato
                const firstUsername = selected[0];
                const firstOpId = toId(firstUsername);

                if (!task.dbIdsByOperator[firstUsername]) {
                    if (task.dbIdUnassigned) {
                        await updateDbTaskAssignedOperator(task.dbIdUnassigned, firstOpId);
                        task.dbIdsByOperator[firstUsername] = task.dbIdUnassigned;
                        task.dbIdUnassigned = null;
                    } else if (task.dbId) {
                        await updateDbTaskAssignedOperator(task.dbId, firstOpId);
                        task.dbIdsByOperator[firstUsername] = task.dbId;
                        delete task.dbId;
                    } else {
                        const created = await createDbTaskForOperator(task, firstOpId);
                        if (created?.id) task.dbIdsByOperator[firstUsername] = created.id;
                    }
                }

                // Garantisci task per gli altri operatori
                for (let i = 1; i < selected.length; i++) {
                    const u = selected[i];
                    if (task.dbIdsByOperator[u]) continue;
                    const opId = toId(u);
                    if (!opId) continue;
                    const created = await createDbTaskForOperator(task, opId);
                    if (created?.id) task.dbIdsByOperator[u] = created.id;
                }

                // Rimuovi task per operatori deselezionati
                for (const u of existingUsernames) {
                    if (!selected.includes(u)) {
                        const id = task.dbIdsByOperator[u];
                        if (id) await deleteDbTask(id);
                        delete task.dbIdsByOperator[u];
                    }
                }

                // Elimina eventuale placeholder residuo
                if (task.dbIdUnassigned) {
                    await deleteDbTask(task.dbIdUnassigned);
                    task.dbIdUnassigned = null;
                }

                saveOrderTasks();
            } catch (e) {
                console.warn('Errore upsert ritiro tasks per operatori:', e);
            }
        }

        // Admin-only background sync to ensure 'ritira' orders are visible to admins in backend
        async function syncRitiroOrdersToDb() {
            try {
                if (!currentUser?.id || currentUser?.role !== 'master') return;
                const currentToken = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!currentToken) return;

                // Assicura task locali per tutti gli ordini "ritira"
                orders.filter(o => o.type === 'ritira').forEach(o => {
                    const existing = orderTasks.find(t => t.orderId === o.id);
                    if (!existing) {
                        generateTaskForOrder(o, []);
                    }
                });

                // Allinea ogni task "ritira" nel backend in base all'assegnazione corrente
                for (const t of orderTasks) {
                    const ord = orders.find(o => o.id === t.orderId);
                    if (!ord) continue;
                    if (ord.type === 'ritira') {
                        await upsertRitiroTasksForOperators(t, Array.isArray(t.assignedTo) ? t.assignedTo : []);
                    }
                }
            } catch (e) {
                console.warn('Errore syncRitiroOrdersToDb:', e);
            }
        }

        function renderOrderTasks() {
            const grid = document.getElementById('orderTasksGrid');
            const countSpan = document.getElementById('tasksCount');
            if (!grid) return;
            
            // Filtra ordini in base a showAllOrders o selectedDate
            let ordersToShow = orders;
            if (!showAllOrders) {
                // Usa selectedDate se disponibile, altrimenti oggi
                const filterDate = selectedDate || new Date().toISOString().split('T')[0];
                ordersToShow = orders.filter(order => {
                    if (!order.dateTime) return false;
                    return order.dateTime.startsWith(filterDate);
                });
            }
            
            // Aggiorna contatore
            if (countSpan) {
                if (showAllOrders) {
                    countSpan.textContent = `(${ordersToShow.length} totali)`;
                } else if (selectedDate) {
                    // Formatta la data selezionata
                    const date = new Date(selectedDate + 'T00:00:00');
                    const formatted = date.toLocaleDateString('it-IT', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short'
                    });
                    countSpan.textContent = `(${ordersToShow.length} - ${formatted})`;
                } else {
                    countSpan.textContent = `(${ordersToShow.length} oggi)`;
                }
            }
            
            if (ordersToShow.length === 0) {
                grid.innerHTML = '<p style="color:#808080;grid-column:1/-1;text-align:center;padding:20px;">Nessun ordine ' + (showAllOrders ? '' : 'per oggi') + '</p>';
                return;
            }
            
            // Sort orders by dateTime
            ordersToShow.sort((a, b) => {
                if (!a.dateTime && !b.dateTime) return 0;
                if (!a.dateTime) return 1;
                if (!b.dateTime) return -1;
                return new Date(a.dateTime) - new Date(b.dateTime);
            });
            
            grid.innerHTML = ordersToShow.map(order => {
                const timeOnly = order.dateTime ? new Date(order.dateTime).toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}) : 'N/D';
                const statusLabel = getStatusLabel(order.status);
                const typeLabel = order.type === 'consegnato' ? 'üöö Consegna' : 'üì• Ritiro';
                return `<div class=\"order-card\" style=\"border-left:4px solid #3b82f6;\">\n  <div class=\"order-header\">\n    <div class=\"order-title\" style=\"font-size:20px;color:#7dd3fc;font-weight:700;margin-bottom:4px;\">${order.client}</div>\n    <span style=\"background:#3d3d3d;color:#60a5fa;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;\">${typeLabel}</span>\n  </div>\n  <div class=\"order-details\" style=\"font-size:18px;line-height:1.8;margin-top:12px;\">\n    <p style=\"margin:8px 0;\"><strong style=\"color:#93c5fd;font-size:20px;\">üì¶ Prodotto:</strong> <span style=\"color:#e0e0e0;font-size:20px;font-weight:600;\">${order.product}</span></p>\n    <p style=\"margin:8px 0;\"><strong style=\"color:#93c5fd;font-size:20px;\">üìä Quantit√†:</strong> <span style=\"color:#fcd34d;font-size:22px;font-weight:700;\">${order.quantity} kg</span></p>\n    <p style=\"margin:8px 0;\"><strong style=\"color:#93c5fd;font-size:20px;\">‚è∞ Orario:</strong> <span style=\"color:#86efac;font-size:22px;font-weight:700;\">${timeOnly}</span></p>\n    <p style=\"margin:8px 0;\"><strong style=\"color:#93c5fd;font-size:16px;\">üìç Stato:</strong> <span style=\"color:#a0a0a0;font-size:16px;\">${statusLabel}</span></p>\n  </div>\n  <div class=\"order-actions\" style=\"display:flex;gap:6px;justify-content:flex-end;margin-top:15px;flex-wrap:wrap;\">\n    <button class=\"btn btn-primary\" onclick=\"updateOrderStatus(${order.id}, 'completed')\" style=\"padding:6px 10px;font-size:12px;\">‚úì Completa</button>\n    <button class=\"btn btn-secondary\" onclick=\"openEditOrderModal(${order.id})\" style=\"padding:6px 10px;font-size:12px;\">‚úèÔ∏è Modifica</button>\n    <button class=\"btn btn-danger\" onclick=\"deleteOrder(${order.id})\" style=\"padding:6px 10px;font-size:12px;\">üóëÔ∏è Elimina</button>\n  </div>\n</div>`;
            }).join('');
        }
        
        function toggleShowAllOrders() {
            showAllOrders = !showAllOrders;
            selectedDate = null; // Reset data selezionata
            const btn = document.getElementById('toggleShowAllBtn2');
            if (showAllOrders) {
                btn.textContent = 'üìÖ Solo Oggi';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            } else {
                btn.textContent = 'üëÅÔ∏è Visualizza Tutti';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            }
            renderOrderTasks();
        }

        function openAssignTaskModal(taskId) {
            const modal = document.getElementById('assignTaskModal');
            const list = document.getElementById('operatorsChecklist');
            document.getElementById('assignTaskId').value = taskId;
            list.innerHTML = allOperators.map(op => {
                const task = orderTasks.find(t => t.id === taskId);
                const checked = task && task.assignedTo.includes(op.username) ? 'checked' : '';
                const icon = op.role === 'master' ? 'üë®‚Äçüíº' : 'üë∑';
                const suffix = (currentUser.id === op.id) ? ' (per me)' : '';
                return `<label style=\"display:flex;align-items:center;gap:6px;font-size:12px;margin:4px 0;\"><input type=\"checkbox\" value=\"${op.username}\" ${checked}> <span>${icon} ${op.username}${suffix}</span></label>`;
            }).join('');
            modal.classList.add('active');
        }
        function closeAssignTaskModal() {
            document.getElementById('assignTaskModal').classList.remove('active');
        }
        function assignTaskToOperators(e) {
            e.preventDefault();
            const taskId = document.getElementById('assignTaskId').value;
            const checkboxes = Array.from(document.querySelectorAll('#operatorsChecklist input[type=checkbox]'));
            const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
            const task = orderTasks.find(t => t.id === taskId);
            if (task) {
                task.assignedTo = selected;
                task.status = selected.length > 0 ? 'assigned' : 'unassigned';
                saveOrderTasks();
                renderOrderTasks();
                // Se ritiro, sincronizza nel DB i task assegnati agli operatori
                upsertRitiroTasksForOperators(task, selected);
            }
            closeAssignTaskModal();
        }
        function markTaskCompleted(taskId) {
            const task = orderTasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'completed';
                saveOrderTasks();
                // Sync also the related order status
                const order = orders.find(o => ('task-' + o.id) === taskId || o.id === task.orderId);
                if (order) {
                    order.status = 'completed';
                    saveOrders();
                }
                renderOrderTasks();
                updateStats();
                renderCalendar();
            }
        }

        async function deleteOrderTask(taskId) {
            const task = orderTasks.find(t => t.id === taskId);
            if (task) {
                await deleteBackendEntriesForTask(task);
            }
            orderTasks = orderTasks.filter(t => t.id !== taskId);
            saveOrderTasks();
            // Also delete underlying order if present
            if (task && task.orderId) {
                orders = orders.filter(o => o.id !== task.orderId);
                saveOrders();
            }
            renderOrderTasks();
            updateStats();
            renderCalendar();
        }

        // Analizza CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index]?.trim() || '';
                });
                return obj;
            });
        }

        // Carica file CSV
        async function loadCSVData() {
            try {
                // Carica clienti
                const clientiResponse = await fetch('data/clienti.csv');
                const clientiText = await clientiResponse.text();
                clienti = parseCSV(clientiText);

                // Carica articoli
                const articoliResponse = await fetch('data/articoli.csv');
                const articoliText = await articoliResponse.text();
                articoli = parseCSV(articoliText);

                console.log('Clienti caricati:', clienti.length);
                console.log('Articoli caricati:', articoli.length);
            } catch (error) {
                console.error('Errore caricamento CSV:', error);
            }
        }

        // Carica ordini da localStorage
        function loadOrders() {
            const stored = localStorage.getItem('orders');
            orders = stored ? JSON.parse(stored) : [];
            renderOrders();
            updateStats();
            renderCalendar();
        }

        // Salva ordini in localStorage
        function saveOrders() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        // === GESTIONE VIAGGI ===
        function loadTrips() {
            const stored = localStorage.getItem('trips');
            trips = stored ? JSON.parse(stored) : [];
        }

        function saveTrips() {
            localStorage.setItem('trips', JSON.stringify(trips));
        }

        function createTrip(name, date) {
            const trip = {
                id: Date.now(),
                name: name,
                date: date,
                orderIds: [],
                sequence: [],
                createdAt: new Date().toISOString(),
                assignedOperatorId: null,
                tripTaskId: null
            };
            trips.push(trip);
            saveTrips();
            return trip;
        }

        function addOrderToTrip(tripId, orderId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip && !trip.orderIds.includes(orderId)) {
                trip.orderIds.push(orderId);
                trip.sequence.push(orderId);
                saveTrips();
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    order.tripId = tripId;
                    saveOrders();
                }
                // Sync trip task with backend
                syncTripTask(tripId);
            }
        }

        function removeOrderFromTrip(tripId, orderId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                trip.orderIds = trip.orderIds.filter(id => id !== orderId);
                trip.sequence = trip.sequence.filter(id => id !== orderId);
                saveTrips();
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    delete order.tripId;
                    saveOrders();
                }
                // If no more orders, delete trip task, else update it
                const remaining = trip.orderIds.length;
                if (remaining === 0) {
                    deleteTripTask(tripId);
                } else {
                    syncTripTask(tripId);
                }
            }
        }

        function deleteTrip(tripId) {
            trips = trips.filter(t => t.id !== tripId);
            saveTrips();
            orders.forEach(o => {
                if (o.tripId === tripId) {
                    delete o.tripId;
                }
            });
            saveOrders();
            // Remove backend task too
            deleteTripTask(tripId);
        }

        function reorderTripSequence(tripId, newSequence) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                trip.sequence = newSequence;
                saveTrips();
                // Re-sequencing changes description; update backend task if exists
                syncTripTask(tripId);
            }
        }

        function getTripOrders(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip) return [];
            return trip.sequence.map(orderId => orders.find(o => o.id === orderId)).filter(Boolean);
        }

        function calculateTripTotals(tripId) {
            const tripOrders = getTripOrders(tripId);
            const totals = {};
            tripOrders.forEach(order => {
                if (!totals[order.product]) {
                    totals[order.product] = 0;
                }
                totals[order.product] += parseFloat(order.quantity || 0);
            });
            return totals;
        }

        // === Task Viaggio (un task per viaggio) ===
        function buildTripTaskTitle(trip) {
            const d = trip.date ? new Date(trip.date) : null;
            const dateStr = d ? d.toLocaleDateString('it-IT') : '';
            return `üöö Viaggio: ${trip.name}${dateStr ? ' ‚Ä¢ ' + dateStr : ''}`;
        }

        function buildTripTaskDescription(trip) {
            const tripOrders = getTripOrders(trip.id);
            const totals = calculateTripTotals(trip.id);
            const ordersList = tripOrders.map((o, idx) => `#${idx + 1} ${o.client} ‚Ä¢ ${o.product} ${o.quantity}kg`).join('\n');
            const totalsList = Object.entries(totals).map(([p, q]) => `${p}: ${q.toFixed(1)}kg`).join(', ');
            return `Ordini nel viaggio: ${tripOrders.length}\n\nSequenza:\n${ordersList || '-'}\n\nTotali prodotti: ${totalsList || '-'}`;
        }

        async function syncTripTask(tripId) {
            try {
                const trip = trips.find(t => t.id === tripId);
                if (!trip) return;
                if (!currentUser?.id || currentUser?.role !== 'master') return; // solo admin crea/aggiorna
                const auth = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!auth) return;
                // Crea/aggiorna solo se ci sono ordini
                if (!trip.orderIds || trip.orderIds.length === 0) return;

                const payload = {
                    title: buildTripTaskTitle(trip),
                    description: buildTripTaskDescription(trip),
                    scheduledAt: trip.date || null,
                    assignedOperatorId: trip.assignedOperatorId || null,  // assegna se presente
                    estimatedMinutes: Math.max(60, getTripOrders(trip.id).length * 15),
                    priority: 'HIGH'
                };

                if (trip.tripTaskId) {
                    const resp = await fetch(`${API_URL}/tasks/${trip.tripTaskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${auth}` },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) console.warn('Aggiornamento task viaggio fallito', resp.status);
                } else {
                    const resp = await fetch(`${API_URL}/tasks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${auth}` },
                        body: JSON.stringify(payload)
                    });
                    if (resp.ok) {
                        const saved = await resp.json();
                        trip.tripTaskId = saved.id;
                        saveTrips();
                    } else {
                        console.warn('Creazione task viaggio fallita', resp.status);
                    }
                }
            } catch (e) {
                console.error('Errore syncTripTask:', e);
            }
        }

        async function deleteTripTask(tripId) {
            try {
                const trip = trips.find(t => t.id === tripId);
                if (!trip || !trip.tripTaskId) return;
                if (!currentUser?.id || currentUser?.role !== 'master') return;
                const auth = localStorage.getItem('token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                if (!auth) return;
                const resp = await fetch(`${API_URL}/tasks/${trip.tripTaskId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${auth}` }
                });
                if (resp.status === 204 || resp.ok) {
                    trip.tripTaskId = null;
                    saveTrips();
                }
            } catch (e) {
                console.error('Errore deleteTripTask:', e);
            }
        }

        // Apri modal ordine
        function openOrderModal() {
            document.querySelector('#orderModal h2').textContent = 'üìù Nuovo Ordine';
            document.getElementById('orderForm').dataset.editingId = '';
            
            // Popola dropdown clienti
            const clientSelect = document.getElementById('orderClient');
            clientSelect.innerHTML = '<option value="">-- Seleziona Cliente --</option>' +
                clienti.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');

            // Popola dropdown articoli
            const productSelect = document.getElementById('orderProduct');
            productSelect.innerHTML = '<option value="">-- Seleziona Articolo --</option>' +
                articoli.map(a => `<option value="${a.nome}">${a.codice} - ${a.nome}</option>`).join('');

            document.getElementById('orderModal').classList.add('active');
            document.getElementById('orderForm').reset();

            // Reset e nascondi sezione viaggio inline
            const tripOpts = document.getElementById('deliveryTripOptions');
            const tripFields = document.getElementById('tripFields');
            const createNowCb = document.getElementById('createTripNow');
            const tripNameInline = document.getElementById('tripNameInline');
            const tripDateInline = document.getElementById('tripDateInline');
            const tripOpSelect = document.getElementById('tripOperatorInline');
            if (tripOpSelect) {
                tripOpSelect.innerHTML = '<option value="">-- Non assegnato --</option>' +
                    allOperators.map(op => `<option value="${op.id}">${op.username}</option>`).join('');
            }
            if (tripOpts && tripFields && createNowCb) {
                tripOpts.style.display = 'none';
                tripFields.style.display = 'none';
                createNowCb.checked = false;
            }

            // Aggancia validazione data/ora contro festivi e orari consegna
            const dt = document.getElementById('orderDateTime');
            if (dt) {
                dt.onchange = function(){
                    if (!window.SettingsUtils) return;
                    const val = dt.value;
                    if (!val) return;
                    const d = new Date(val);
                    const clamped = window.SettingsUtils.clampToDeliveryWindows(d);
                    const newVal = fmtLocalDateTime(clamped);
                    if (newVal !== val) {
                        dt.value = newVal;
                        alert('‚ÑπÔ∏è Data/ora adeguata ai giorni/orari di consegna');
                    }
                };
            }

            // Mostra opzioni viaggio se tipo = consegnato
            const typeSel = document.getElementById('orderType');
            if (typeSel) {
                const toggleTripSection = () => {
                    if (!tripOpts) return;
                    if (typeSel.value === 'consegnato') {
                        tripOpts.style.display = '';
                        // Precompila nome e data viaggio in base alla data ordine
                        const dtVal = document.getElementById('orderDateTime').value;
                        if (dtVal && tripDateInline) {
                            const dateOnly = dtVal.split('T')[0];
                            tripDateInline.value = dateOnly;
                        }
                        if (tripNameInline) {
                            const when = tripDateInline && tripDateInline.value ? new Date(tripDateInline.value + 'T00:00:00').toLocaleDateString('it-IT') : 'oggi';
                            tripNameInline.value = `Consegne ${when}`;
                        }
                    } else {
                        tripOpts.style.display = 'none';
                        if (createNowCb) createNowCb.checked = false;
                        if (tripFields) tripFields.style.display = 'none';
                    }
                };
                typeSel.onchange = toggleTripSection;
                toggleTripSection();
            }

            // Mostra/nascondi campi viaggio se spunta la checkbox
            if (createNowCb && tripFields) {
                createNowCb.onchange = () => {
                    tripFields.style.display = createNowCb.checked ? '' : 'none';
                };
            }
        }

        // Apri modal per modificare ordine esistente
        function openEditOrderModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            document.querySelector('#orderModal h2').textContent = '‚úèÔ∏è Modifica Ordine';
            document.getElementById('orderForm').dataset.editingId = orderId;
            
            // Popola dropdown clienti
            const clientSelect = document.getElementById('orderClient');
            clientSelect.innerHTML = '<option value="">-- Seleziona Cliente --</option>' +
                clienti.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
            clientSelect.value = order.client;

            // Popola dropdown articoli
            const productSelect = document.getElementById('orderProduct');
            productSelect.innerHTML = '<option value="">-- Seleziona Articolo --</option>' +
                articoli.map(a => `<option value="${a.nome}">${a.codice} - ${a.nome}</option>`).join('');
            productSelect.value = order.product;

            // Riempi i campi
            document.getElementById('orderLotto').value = order.lotto || '';
            document.getElementById('orderRitiroConsegna').value = order.ritiro_consegna || '';
            document.getElementById('orderPosizione').value = order.posizione || '';
            document.getElementById('orderQuantity').value = order.quantity;
            document.getElementById('orderType').value = order.type;
            document.getElementById('orderDateTime').value = order.dateTime;
            document.getElementById('orderNotes').value = order.notes || '';

            // Popola dropdown viaggio
            const assignToTrip = document.getElementById('assignToTrip');
            assignToTrip.innerHTML = '<option value="">-- Nessuno (crea viaggio nuovo) --</option>';
            if (typeof trips !== 'undefined' && trips && trips.length > 0) {
                assignToTrip.innerHTML += trips.map(t => `<option value="${t.id}">${t.name} (${t.date})</option>`).join('');
            }
            // Imposta il viaggio associato se esiste
            if (typeof trips !== 'undefined' && trips) {
                const tripForOrder = trips.find(t => t.orders && t.orders.includes(orderId));
                if (tripForOrder) {
                    assignToTrip.value = tripForOrder.id;
                } else if (order.assignedTrip) {
                    assignToTrip.value = order.assignedTrip;
                }
            }

            // Popola dropdown operatori
            const assignToOperator = document.getElementById('assignToOperator');
            assignToOperator.innerHTML = '<option value="">-- Non assegnato --</option>';
            if (typeof allOperators !== 'undefined' && allOperators && allOperators.length > 0) {
                assignToOperator.innerHTML += allOperators.map(op => `<option value="${op.id}">${op.name || op.username}</option>`).join('');
            }
            // Imposta l'operatore associato se esiste
            if (order.assignedOperatorId) {
                assignToOperator.value = order.assignedOperatorId;
            }

            updateClientInfo();
            document.getElementById('orderModal').classList.add('active');

            const dt = document.getElementById('orderDateTime');
            if (dt) {
                dt.onchange = function(){
                    if (!window.SettingsUtils) return;
                    const val = dt.value;
                    if (!val) return;
                    const d = new Date(val);
                    const clamped = window.SettingsUtils.clampToDeliveryWindows(d);
                    const newVal = fmtLocalDateTime(clamped);
                    if (newVal !== val) {
                        dt.value = newVal;
                        alert('‚ÑπÔ∏è Data/ora adeguata ai giorni/orari di consegna');
                    }
                };
            }
        }

        // Chiudi modal ordine
        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        // Aggiorna informazioni cliente (orari)
        function updateClientInfo() {
            const selectedClient = document.getElementById('orderClient').value;
            const cliente = clienti.find(c => c.nome === selectedClient);
            const infoDiv = document.getElementById('clientHoursInfo');
            
            if (cliente && cliente.orario_apertura) {
                infoDiv.innerHTML = `
                    <strong>‚è∞ Orari Cliente:</strong><br>
                    Apertura: ${cliente.orario_apertura} - ${cliente.orario_chiusura}<br>
                    Finestra Consegne: ${cliente.orario_consegna_inizio} - ${cliente.orario_consegna_fine}
                `;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Aggiorna informazioni articolo (lotto, ritiro/consegna, posizione)
        function updateArticleInfo() {
            const selectedProduct = document.getElementById('orderProduct').value;
            const article = articoli.find(a => a.nome === selectedProduct);
            
            if (article) {
                document.getElementById('orderLotto').value = article.lotto || '';
                document.getElementById('orderRitiroConsegna').value = article.ritiro_consegna || '';
                document.getElementById('orderPosizione').value = article.posizione_scaffale || '';
            } else {
                document.getElementById('orderLotto').value = '';
                document.getElementById('orderRitiroConsegna').value = '';
                document.getElementById('orderPosizione').value = '';
            }
        }

        // Salva nuovo ordine o modifica esistente
        async function saveOrder(event) {
            event.preventDefault();
            
            const editingId = document.getElementById('orderForm').dataset.editingId;
            
            // Valida/sistema data/ora rispetto a festivi e orari di consegna
            let rawDateTime = document.getElementById('orderDateTime').value;
            if (window.SettingsUtils && rawDateTime) {
                const selectedType = document.getElementById('orderType').value;
                const dateObj = new Date(rawDateTime);
                const clamped = (selectedType === 'ritira')
                    ? window.SettingsUtils.clampToOpeningWindows(dateObj)
                    : window.SettingsUtils.clampToDeliveryWindows(dateObj);
                const fmt = fmtLocalDateTime(clamped);
                if (fmt !== rawDateTime) {
                    rawDateTime = fmt;
                    document.getElementById('orderDateTime').value = fmt;
                    alert('‚ÑπÔ∏è Data/ora adeguata ai giorni/orari aziendali');
                }
            }

            const orderData = {
                client: document.getElementById('orderClient').value,
                product: document.getElementById('orderProduct').value,
                quantity: parseFloat(document.getElementById('orderQuantity').value),
                type: document.getElementById('orderType').value,
                dateTime: rawDateTime,
                status: 'pending',  // Default status for new orders
                lotto: document.getElementById('orderLotto').value,
                ritiro_consegna: document.getElementById('orderRitiroConsegna').value,
                posizione: document.getElementById('orderPosizione').value,
                notes: document.getElementById('orderNotes').value,
                assignedTrip: document.getElementById('assignToTrip').value || null,
                assignedOperatorId: document.getElementById('assignToOperator').value ? parseInt(document.getElementById('assignToOperator').value, 10) : null
            };

            if (editingId) {
                // Modifica ordine esistente
                const order = orders.find(o => o.id == editingId);
                if (order) {
                    // Gestisci cambio assegnazione viaggio
                    const previousTrip = typeof trips !== 'undefined' && trips ? trips.find(t => t.orders && t.orders.includes(editingId)) : null;
                    const newTripId = orderData.assignedTrip ? parseInt(orderData.assignedTrip, 10) : null;
                    
                    if (previousTrip && newTripId !== previousTrip.id) {
                        // Rimuovi da viaggio precedente
                        previousTrip.orders = previousTrip.orders.filter(id => id !== editingId);
                    }
                    
                    if (newTripId && (!previousTrip || previousTrip.id !== newTripId)) {
                        // Aggiungi al nuovo viaggio
                        const newTrip = typeof trips !== 'undefined' && trips ? trips.find(t => t.id === newTripId) : null;
                        if (newTrip) {
                            if (!newTrip.orders) newTrip.orders = [];
                            if (!newTrip.orders.includes(editingId)) {
                                newTrip.orders.push(editingId);
                            }
                            // Se assegnato a operatore, assegna anche il viaggio a quell'operatore
                            if (orderData.assignedOperatorId) {
                                newTrip.assignedOperatorId = orderData.assignedOperatorId;
                            }
                            saveTrips();
                        }
                    }
                    
                    Object.assign(order, orderData);
                    
                    // Aggiorna anche il task associato
                    const task = orderTasks.find(t => t.orderId == editingId);
                    if (task) {
                        // Aggiorna titolo con nuovo formato semplificato
                        task.title = `${orderData.type === 'consegnato' ? 'consegna' : 'ritiro'} - ${String(orderData.client || '').toLowerCase()}`;
                        task.client = orderData.client;
                        task.product = orderData.product;
                        task.quantity = orderData.quantity;
                        task.dateTime = orderData.dateTime;
                        task.notes = orderData.notes;
                        task.assignedOperatorId = orderData.assignedOperatorId;
                        const cliente = clienti.find(c => c.nome === orderData.client);
                        if (cliente) {
                            task.clienteOrari = {
                                apertura: cliente.orario_apertura,
                                chiusura: cliente.orario_chiusura,
                                consegna_inizio: cliente.orario_consegna_inizio,
                                consegna_fine: cliente.orario_consegna_fine
                            };
                        }
                        saveOrderTasks();
                    }
                    console.log('‚úèÔ∏è Ordine modificato:', order.client, order.assignedTrip ? ` (Viaggio: ${order.assignedTrip})` : '', order.assignedOperatorId ? ` (Operatore: ${order.assignedOperatorId})` : '');
                }
            } else {
                // Nuovo ordine
                const order = {
                    id: Date.now(),
                    ...orderData,
                    createdAt: new Date().toISOString()
                };
                orders.push(order);
                // Genera task solo per ritiri (le consegne generano task quando aggiunte a un viaggio)
                if (order.type === 'ritira') {
                    generateTaskForOrder(order, []);
                } else {
                    // Se consegna e richiesto, crea viaggio e assegna task
                    const createTripNow = document.getElementById('createTripNow');
                    if (createTripNow && createTripNow.checked) {
                        const nameEl = document.getElementById('tripNameInline');
                        const dateEl = document.getElementById('tripDateInline');
                        const opEl = document.getElementById('tripOperatorInline');
                        const tripName = (nameEl && nameEl.value.trim()) || `Consegne ${new Date(order.dateTime).toLocaleDateString('it-IT')}`;
                        const tripDate = (dateEl && dateEl.value) || order.dateTime.split('T')[0];
                        const operatorId = opEl && opEl.value ? parseInt(opEl.value, 10) : null;
                        const trip = createTrip(tripName, tripDate);
                        addOrderToTrip(trip.id, order.id);
                        if (operatorId) {
                            const t = trips.find(t => t.id === trip.id);
                            if (t) {
                                t.assignedOperatorId = operatorId;
                                saveTrips();
                            }
                        }
                        // Crea/aggiorna task del viaggio (se admin autenticato)
                        await syncTripTask(trip.id);
                    }
                }
                console.log('üìù Nuovo ordine creato:', order.client, order.type === 'consegnato' ? '(task verr√† creato con il viaggio)' : '(task creato)');
            }

            renderOrderTasks();
            saveOrders();
            renderOrders();
            updateStats();
            renderCalendar();
            closeOrderModal();
        }

        // Elimina ordine
        async function deleteOrder(id) {
            // Elimina eventuale task collegato anche nel backend
            const task = orderTasks.find(t => t.orderId === id);
            if (task) {
                await deleteBackendEntriesForTask(task);
            }
            orders = orders.filter(o => o.id !== id);
            saveOrders();
            // Also remove generated task for this order, if any
            const prevLen = orderTasks.length;
            orderTasks = orderTasks.filter(t => t.orderId !== id);
            if (orderTasks.length !== prevLen) {
                saveOrderTasks();
                renderOrderTasks();
            }
            renderOrders();
            updateStats();
            renderCalendar();
        }

        // Aggiorna stato ordine
        function updateOrderStatus(id, newStatus) {
            const order = orders.find(o => o.id === id);
            if (order) {
                order.status = newStatus;
                saveOrders();
                renderOrders();
                // If marking completed, sync related task status too
                if (newStatus === 'completed') {
                    const task = orderTasks.find(t => t.orderId === id);
                    if (task) {
                        task.status = 'completed';
                        saveOrderTasks();
                        renderOrderTasks();
                    }
                }
                updateStats();
                renderCalendar();
            }
        }

        // Renderizza ordini
        function renderOrders() {
            const grid = document.getElementById('ordersGrid');
            if (!grid) return;
            
            if (orders.length === 0) {
                grid.innerHTML = '<p style="color: #808080; grid-column: 1/-1; text-align: center; padding: 20px;">Nessun ordine presente. Crea il primo ordine!</p>';
                return;
            }

            grid.innerHTML = orders.map(order => {
                const cliente = clienti.find(c => c.nome === order.client);
                const orariInfo = cliente ? `
                    <p><strong>Apertura:</strong> ${cliente.orario_apertura} - ${cliente.orario_chiusura}</p>
                    <p><strong>Finestra Consegne:</strong> ${cliente.orario_consegna_inizio} - ${cliente.orario_consegna_fine}</p>
                ` : '';
                
                return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-title">${order.client}</div>
                        <div class="order-status ${order.status}">${getStatusLabel(order.status)}</div>
                    </div>
                    <div class="order-details">
                        <p><strong>Prodotto:</strong> ${order.product}</p>
                        <p><strong>Quantit√†:</strong> ${order.quantity} kg</p>
                        <p><strong>Tipo:</strong> ${order.type === 'consegnato' ? 'üì¶ Consegnato' : 'üè™ Ritira Cliente'}</p>
                        <p><strong>Data e Orario:</strong> ${order.dateTime ? new Date(order.dateTime).toLocaleString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'N/D'}</p>
                        ${orariInfo}
                        ${order.lotto ? `<p><strong>Lotto:</strong> ${order.lotto}</p>` : ''}
                        ${order.ritiro_consegna ? `<p><strong>Ritiro/Consegna:</strong> ${order.ritiro_consegna}</p>` : ''}
                        ${order.posizione ? `<p><strong>Scaffale:</strong> ${order.posizione}</p>` : ''}
                        ${order.notes ? `<p><strong>Note:</strong> ${order.notes}</p>` : ''}
                    </div>
                    <div class="order-actions">
                        <button class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'completed')">‚úì Completa</button>
                        <button class="btn btn-danger" onclick="deleteOrder(${order.id})">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `}).join('');
        }

        // Ottieni etichetta stato
        function getStatusLabel(status) {
            const labels = {
                'pending': '‚è≥ Sospeso',
                'completed': '‚úì Completato'
            };
            return labels[status] || status;
        }

        // Aggiorna statistiche
        function updateStats() {
            const total = orders.length;
            const pending = orders.filter(o => o.status !== 'completed').length;
            const completed = orders.filter(o => o.status === 'completed').length;

            document.getElementById('totalOrders').textContent = total;
            document.getElementById('pendingOrders').textContent = pending;
            document.getElementById('completedOrders').textContent = completed;
        }

        // Genera 15 ordini casuali per i prossimi 10 giorni
        function generateSampleOrders() {
            if (orders.length > 0) {
                const confirm = window.confirm('Ordini gi√† presenti. Vuoi aggiungere 15 nuovi ordini?');
                if (!confirm) return;
            }

            const statuses = ['pending', 'completed'];
            const types = ['consegnato', 'ritira'];
            
            // Genera ordini raggruppati per giorno per calcolare carico e tempi
            const ordersByDay = {};
            const tempOrders = [];
            
            for (let i = 0; i < 15; i++) {
                const randomClient = clienti[Math.floor(Math.random() * clienti.length)];
                const randomProduct = articoli[Math.floor(Math.random() * articoli.length)];
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                const randomType = types[Math.floor(Math.random() * types.length)];
                const randomQuantity = (Math.random() * 49 + 1).toFixed(1);
                // pick a base day within next 10 days that fits rules by type
                let base = new Date();
                base.setDate(base.getDate() + Math.floor(Math.random() * 11));
                if (window.SettingsUtils) {
                    if (randomType === 'ritira') {
                        base = window.SettingsUtils.nextValidOpeningDateTime(base);
                    } else {
                        base = window.SettingsUtils.nextValidDeliveryDateTime(base);
                    }
                }
                const dateStr = fmtLocalDate(base);

                if (!ordersByDay[dateStr]) {
                    ordersByDay[dateStr] = { deliveries: [], pickups: [] };
                }

                const orderData = {
                    client: randomClient.nome,
                    product: randomProduct.nome,
                    quantity: parseFloat(randomQuantity),
                    status: randomStatus,
                    lotto: randomProduct.lotto,
                    ritiro_consegna: randomProduct.ritiro_consegna,
                    posizione: randomProduct.posizione_scaffale
                };

                if (randomType === 'consegnato') {
                    ordersByDay[dateStr].deliveries.push(orderData);
                } else {
                    ordersByDay[dateStr].pickups.push(orderData);
                }
            }

            // Calcola orari con tempo variabile in base al carico giornaliero
            let orderId = Date.now();
            for (const [date, dayData] of Object.entries(ordersByDay)) {
                // Calcola carico totale del giorno (solo consegne)
                const totalLoad = dayData.deliveries.reduce((sum, o) => sum + o.quantity, 0);
                
                // Calcola tempo per consegna: 15-45 min in base al carico
                // Formula: minuti = 15 + (carico / 1200kg * 30)
                const loadFactor = Math.min(totalLoad / 1200, 1); // Normalizza a 0-1
                const minutesPerDelivery = Math.round(15 + (loadFactor * 30)); // 15-45 minuti
                
                // Start at first valid delivery window start, else 8:00
                let currentTime = 8 * 60; // default
                if (window.SettingsUtils) {
                    const windows = window.SettingsUtils && window.SettingsUtils.load ? (function(){
                        // ensure we use delivery windows here
                        const s = window.SettingsUtils.load();
                        const t = (s.deliveryMorningStart || '08:00');
                        const [hh,mm] = t.split(':').map(x=>parseInt(x,10));
                        return [{ start: (hh||8)*60+(mm||0)}];
                    })() : null;
                    if (windows && windows[0] && windows[0].start) currentTime = windows[0].start;
                }
                
                // Processa consegne con tempi progressivi
                dayData.deliveries.forEach((orderData) => {
                    const hours = Math.floor(currentTime / 60);
                    const minutes = currentTime % 60;
                    const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    
                    orders.push({
                        id: orderId++,
                        ...orderData,
                        type: 'consegnato',
                        dateTime: date + 'T' + timeStr,
                        notes: '',
                        createdAt: new Date().toISOString()
                    });
                    // Le consegne NON generano task - solo i viaggi generano task
                    
                    // Incrementa il tempo per la prossima consegna
                    currentTime += minutesPerDelivery;
                    // If we exceed delivery windows, move to next allowed day first window
                    if (window.SettingsUtils) {
                        const dt = new Date(date + 'T00:00:00');
                        dt.setHours(Math.floor(currentTime/60), currentTime%60, 0, 0);
                        const clamped = window.SettingsUtils.clampToDeliveryWindows(dt);
                        const clampedDateStr = fmtLocalDate(clamped);
                        const clampedTime = clamped.getHours()*60 + clamped.getMinutes();
                        if (clampedDateStr !== date) {
                            // skip remaining deliveries into the next day is complex; keep within same date by resetting to last window end
                            currentTime = clampedTime; // approximate
                        } else {
                            currentTime = clampedTime;
                        }
                    }
                });
                
                // Processa ritiri con orari casuali
                dayData.pickups.forEach((orderData) => {
                    // Prefer random time within opening windows
                    let timeStr = '09:00';
                    if (window.SettingsUtils) {
                        const s = window.SettingsUtils.load();
                        const candidates = [];
                        if (s.openMorningStart && s.openMorningEnd) candidates.push([s.openMorningStart, s.openMorningEnd]);
                        if (s.openAfternoonStart && s.openAfternoonEnd) candidates.push([s.openAfternoonStart, s.openAfternoonEnd]);
                        if (candidates.length>0) {
                            const pick = candidates[Math.floor(Math.random()*candidates.length)];
                            const [sh,sm] = pick[0].split(':').map(n=>parseInt(n,10));
                            const [eh,em] = pick[1].split(':').map(n=>parseInt(n,10));
                            const startMin = (sh||9)*60 + (sm||0);
                            const endMin = (eh||12)*60 + (em||0);
                            const randMin = startMin + Math.floor(Math.random() * Math.max(1, (endMin-startMin-1)));
                            const hh = String(Math.floor(randMin/60)).padStart(2,'0');
                            const mm = String(randMin%60).padStart(2,'0');
                            timeStr = `${hh}:${mm}`;
                        }
                    }
                    
                    orders.push({
                        id: orderId++,
                        ...orderData,
                        type: 'ritira',
                        dateTime: date + 'T' + timeStr,
                        notes: '',
                        createdAt: new Date().toISOString()
                    });
                    // I ritiri generano task individuali
                    generateTaskForOrder(orders[orders.length - 1]);
                });
            }
            
            saveOrders();
            renderOrderTasks();
            renderOrders();
            updateStats();
            renderCalendar();
            alert('‚úÖ 15 ordini generati con successo!');
        }

        // Torna indietro
        function goBack() {
            window.history.back();
        }

        // Renderizza calendario (settimana o mese)
        function renderCalendar() {
            if (calendarViewMode === 'week') {
                renderCalendarWeek();
            } else {
                renderCalendarMonth();
            }
        }
        
        // Renderizza vista settimanale
        function renderCalendarWeek() {
            const container = document.getElementById('calendarContainer');
            const startDate = new Date(weekStartDate);
            
            const dayNames = ['Do', 'Lu', 'Ma', 'Me', 'Gi', 'Ve', 'Sa'];
            
            let html = dayNames.map(day => `<div style="font-weight: bold; text-align: center; padding: 6px; background: #3d3d3d; border: 1px solid #4d4d4d; border-radius: 4px; font-size: 12px; color: #b0b0b0;">${day}</div>`).join('');
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dateStr = String(date.getFullYear()).padStart(4, '0') + '-' + 
                               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(date.getDate()).padStart(2, '0');
                
                const isHoliday = (window.SettingsUtils && window.SettingsUtils.isHolidayDate) ? window.SettingsUtils.isHolidayDate(date) : false;
                const isAllowed = (window.SettingsUtils && window.SettingsUtils.isDeliveryAllowedDate) ? window.SettingsUtils.isDeliveryAllowedDate(date) : (date.getDay() !== 0);
                
                const dayOrders = orders.filter(order => {
                    if (!order.dateTime) return false;
                    return order.dateTime.startsWith(dateStr);
                });
                
                const assignedOrders = dayOrders.filter(order => {
                    const task = orderTasks.find(t => t.orderId === order.id);
                    return task && task.assignedTo.length > 0;
                }).length;
                
                const unassignedOrders = dayOrders.filter(order => {
                    const task = orderTasks.find(t => t.orderId === order.id);
                    return !task || task.assignedTo.length === 0;
                }).length;
                
                const hasOrdersClass = assignedOrders > 0 ? 'has-orders' : '';
                const hasUnassignedClass = unassignedOrders > 0 ? 'has-unassigned-orders' : '';
                const dayColor = (!isAllowed || isHoliday) ? 'color: #ef4444;' : '';
                
                let assignedCountHtml = '';
                let unassignedCountHtml = '';
                if (assignedOrders > 0) {
                    assignedCountHtml = `<div style="position: absolute; bottom: 2px; right: 2px; font-size: 14px; color: #ffffff; font-weight: bold; z-index: 10;">${assignedOrders}</div>`;
                }
                if (unassignedOrders > 0) {
                    unassignedCountHtml = `<div style="position: absolute; bottom: 2px; left: 2px; font-size: 14px; color: #ffffff; font-weight: bold; z-index: 10;">${unassignedOrders}</div>`;
                }
                
                html += `<div class="calendar-day ${hasOrdersClass} ${hasUnassignedClass}" style="cursor: pointer; position: relative; ${dayColor}" onclick="showDayOrdersModal('${dateStr}')"><strong>${date.getDate()}</strong>${assignedCountHtml}${unassignedCountHtml}</div>`;
            }
            
            container.innerHTML = html;
            
            // Calcola numero settimana
            const firstDay = new Date(startDate.getFullYear(), 0, 1);
            const pastDaysOfYear = (startDate - firstDay) / 86400000;
            const weekNumber = Math.ceil((pastDaysOfYear + firstDay.getDay() + 1) / 7);
            document.getElementById('calendarMonthYear').textContent = `Settimana ${weekNumber}`;
        }
        
        // Renderizza vista mensile
        function renderCalendarMonth() {
            const container = document.getElementById('calendarContainer');
            
            const year = calendarDisplayYear;
            const month = calendarDisplayMonth;
            
            // Impostazioni azienda per festivi e giorni consentiti
            const companySettings = (window.SettingsUtils && window.SettingsUtils.load) ? window.SettingsUtils.load() : null;
            
            // Aggiorna il titolo del mese
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                               'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const dayNames = ['Do', 'Lu', 'Ma', 'Me', 'Gi', 'Ve', 'Sa'];
            let html = dayNames.map(day => `<div style="font-weight: bold; text-align: center; padding: 6px; background: #3d3d3d; border: 1px solid #4d4d4d; border-radius: 4px; font-size: 12px; color: #b0b0b0;">${day}</div>`).join('');
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = String(year).padStart(4, '0') + '-' + 
                               String(month + 1).padStart(2, '0') + '-' + 
                               String(day).padStart(2, '0');
                const dayOfWeek = date.getDay();
                const isHoliday = (window.SettingsUtils && window.SettingsUtils.isHolidayDate) ? window.SettingsUtils.isHolidayDate(date) : false;
                const isAllowed = (window.SettingsUtils && window.SettingsUtils.isDeliveryAllowedDate) ? window.SettingsUtils.isDeliveryAllowedDate(date) : (dayOfWeek !== 0);
                
                // Conta ordini con data schedulata
                const dayOrders = orders.filter(order => {
                    if (!order.dateTime) return false;
                    return order.dateTime.startsWith(dateStr);
                });

                // Conta ordini assegnati e da assegnare
                const assignedOrders = dayOrders.filter(order => {
                    const task = orderTasks.find(t => t.orderId === order.id);
                    return task && task.assignedTo.length > 0;
                }).length;
                
                const unassignedOrders = dayOrders.filter(order => {
                    const task = orderTasks.find(t => t.orderId === order.id);
                    return !task || task.assignedTo.length === 0;
                }).length;

                const totalOrders = dayOrders.length;
                const hasOrdersClass = assignedOrders > 0 ? 'has-orders' : '';
                const hasUnassignedClass = unassignedOrders > 0 ? 'has-unassigned-orders' : '';
                const dayColor = (!isAllowed || isHoliday) ? 'color: #ef4444;' : '';

                let assignedCountHtml = '';
                let unassignedCountHtml = '';
                if (assignedOrders > 0) {
                    assignedCountHtml = `<div style="position: absolute; bottom: 2px; right: 2px; font-size: 14px; color: #ffffff; font-weight: bold; z-index: 10;">${assignedOrders}</div>`;
                }
                if (unassignedOrders > 0) {
                    unassignedCountHtml = `<div style="position: absolute; bottom: 2px; left: 2px; font-size: 14px; color: #ffffff; font-weight: bold; z-index: 10;">${unassignedOrders}</div>`;
                }

                html += `<div class="calendar-day ${hasOrdersClass} ${hasUnassignedClass}" style="${dayColor}" onclick="showDayOrdersModal('${dateStr}')"><strong>${day}</strong>${assignedCountHtml}${unassignedCountHtml}</div>`;
            }
            
            container.innerHTML = html;
        }
        
        function previousPeriod() {
            if (calendarViewMode === 'week') {
                weekStartDate.setDate(weekStartDate.getDate() - 7);
            } else {
                calendarDisplayMonth--;
                if (calendarDisplayMonth < 0) {
                    calendarDisplayMonth = 11;
                    calendarDisplayYear--;
                }
            }
            renderCalendar();
        }
        
        function nextPeriod() {
            if (calendarViewMode === 'week') {
                weekStartDate.setDate(weekStartDate.getDate() + 7);
            } else {
                calendarDisplayMonth++;
                if (calendarDisplayMonth > 11) {
                    calendarDisplayMonth = 0;
                    calendarDisplayYear++;
                }
            }
            renderCalendar();
        }
        
        function toggleCalendarView() {
            const btn = document.getElementById('toggleCalendarBtn');
            if (calendarViewMode === 'week') {
                calendarViewMode = 'month';
                btn.textContent = 'üìÖ Mese';
            } else {
                calendarViewMode = 'week';
                btn.textContent = 'üóìÔ∏è Settimana';
                // Sincronizza weekStartDate con il mese corrente
                weekStartDate = new Date(calendarDisplayYear, calendarDisplayMonth, 1);
                weekStartDate.setDate(weekStartDate.getDate() - weekStartDate.getDay());
            }
            renderCalendar();
        }

        // Mostra ordini del giorno (filtra per data selezionata)
        function showDayOrdersModal(dateStr) {
            // Imposta la data selezionata
            selectedDate = dateStr;
            showAllOrders = false;
            
            // Aggiorna pulsante
            const btn = document.getElementById('toggleShowAllBtn2');
            btn.textContent = 'üëÅÔ∏è Visualizza Tutti';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
            
            // Re-render ordini con la nuova data
            renderOrderTasks();
            
            // Scroll alla sezione ordini
            setTimeout(() => {
                document.getElementById('orderTasksGrid').parentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // === UI VIAGGI ===
        let currentTripId = null;

        function openTripsManager() {
            renderTripsManager();
            document.getElementById('tripsManagerModal').classList.add('active');
        }

        function closeTripsManager() {
            document.getElementById('tripsManagerModal').classList.remove('active');
        }

        function renderTripsManager() {
            const container = document.getElementById('tripsManagerList');
            if (trips.length === 0) {
                container.innerHTML = '<p style="color:#808080;text-align:center;padding:20px;">Nessun viaggio creato</p>';
                return;
            }

            container.innerHTML = trips.map(trip => {
                const tripOrders = getTripOrders(trip.id);
                const totals = calculateTripTotals(trip.id);
                const totalsHtml = Object.entries(totals).map(([product, qty]) => 
                    `<span style="background:#1e3a2a;color:#86efac;padding:4px 8px;border-radius:4px;font-size:12px;margin-right:6px;">${product}: ${qty.toFixed(1)}kg</span>`
                ).join('');

                return `
                    <div class="order-card" style="border-left:4px solid #16a34a;margin-bottom:15px;">
                        <div class="order-header">
                            <div class="order-title">${trip.name}</div>
                            <span class="order-status" style="background:#1e3a2a;color:#86efac;">${tripOrders.length} ordini</span>
                        </div>
                        <div class="order-details">
                            <p><strong>üìÖ Data:</strong> ${new Date(trip.date).toLocaleDateString('it-IT')}</p>
                            ${totalsHtml ? `<p><strong>üìä Totali:</strong><br>${totalsHtml}</p>` : ''}
                        </div>
                        <div class="order-actions" style="justify-content:flex-end;gap:8px;margin-top:10px;">
                            <button class="btn btn-primary" onclick="openTripOrders(${trip.id})" style="padding:6px 10px;font-size:12px;">üì¶ Gestisci Ordini</button>
                            <button class="btn btn-danger" onclick="confirmDeleteTrip(${trip.id})" style="padding:6px 10px;font-size:12px;">üóëÔ∏è Elimina</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openCreateTripModal() {
            document.getElementById('createTripForm').reset();
            document.getElementById('tripDate').valueAsDate = new Date();
            document.getElementById('createTripModal').classList.add('active');
        }

        function closeCreateTripModal() {
            document.getElementById('createTripModal').classList.remove('active');
        }

        function saveNewTrip(event) {
            event.preventDefault();
            const name = document.getElementById('tripName').value;
            const date = document.getElementById('tripDate').value;
            createTrip(name, date);
            closeCreateTripModal();
            renderTripsManager();
            alert('‚úÖ Viaggio creato con successo!');
        }

        function confirmDeleteTrip(tripId) {
            if (confirm('Eliminare questo viaggio? Gli ordini non verranno eliminati.')) {
                deleteTrip(tripId);
                renderTripsManager();
                renderOrderTasks();
            }
        }

        function openTripOrders(tripId) {
            currentTripId = tripId;
            const trip = trips.find(t => t.id === tripId);
            if (!trip) return;

            document.getElementById('tripOrdersTitle').textContent = `üì¶ ${trip.name} - Gestione Ordini`;
            renderAvailableOrders(tripId);
            renderTripOrdersList(tripId);
            renderTripTotals(tripId);
            document.getElementById('tripOrdersModal').classList.add('active');
        }

        function closeTripOrdersModal() {
            document.getElementById('tripOrdersModal').classList.remove('active');
            currentTripId = null;
            renderTripsManager();
        }

        function renderAvailableOrders(tripId) {
            const trip = trips.find(t => t.id === tripId);
            const tripDate = trip.date.split('T')[0];
            const available = orders.filter(o => {
                const orderDate = o.dateTime ? o.dateTime.split('T')[0] : null;
                return o.type === 'consegnato' && 
                       orderDate === tripDate && 
                       !o.tripId;
            });

            const container = document.getElementById('availableOrdersList');
            if (available.length === 0) {
                container.innerHTML = '<p style="color:#808080;font-size:12px;">Nessun ordine disponibile per questa data</p>';
                return;
            }

            container.innerHTML = available.map(order => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#2d2d2d;margin-bottom:6px;border-radius:4px;">
                    <div style="font-size:12px;">
                        <strong>${order.client}</strong> - ${order.product} (${order.quantity}kg)
                        <span style="color:#a0a0a0;margin-left:8px;">${new Date(order.dateTime).toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'})}</span>
                    </div>
                    <button class="btn btn-primary" onclick="addOrderToCurrentTrip(${order.id})" style="padding:4px 8px;font-size:11px;">‚ûï Aggiungi</button>
                </div>
            `).join('');
        }

        function renderTripOrdersList(tripId) {
            const tripOrders = getTripOrders(tripId);
            const container = document.getElementById('tripOrdersList');
            
            if (tripOrders.length === 0) {
                container.innerHTML = '<p style="color:#808080;font-size:12px;padding:10px;text-align:center;">Nessun ordine nel viaggio</p>';
                return;
            }

            container.innerHTML = tripOrders.map((order, index) => `
                <div style="display:flex;align-items:center;padding:10px;background:#3d3d3d;margin-bottom:8px;border-radius:4px;border-left:4px solid #16a34a;">
                    <div style="display:flex;flex-direction:column;gap:6px;margin-right:10px;">
                        <button class="btn btn-secondary" onclick="moveOrderUp(${tripId}, ${index})" ${index === 0 ? 'disabled' : ''} style="padding:2px 6px;font-size:10px;">‚ñ≤</button>
                        <button class="btn btn-secondary" onclick="moveOrderDown(${tripId}, ${index})" ${index === tripOrders.length - 1 ? 'disabled' : ''} style="padding:2px 6px;font-size:10px;">‚ñº</button>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:14px;margin-bottom:4px;color:#16a34a;">#${index + 1} - ${order.client}</div>
                        <div style="font-size:12px;color:#a0a0a0;">
                            ${order.product} - ${order.quantity}kg
                            <span style="margin-left:10px;">‚è∞ ${new Date(order.dateTime).toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'})}</span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeOrderFromCurrentTrip(${order.id})" style="padding:4px 8px;font-size:11px;">‚úñ</button>
                </div>
            `).join('');
        }

        function renderTripTotals(tripId) {
            const totals = calculateTripTotals(tripId);
            const container = document.getElementById('tripTotals');
            
            if (Object.keys(totals).length === 0) {
                container.innerHTML = '<p style="color:#808080;font-size:12px;">Nessun prodotto</p>';
                return;
            }

            container.innerHTML = Object.entries(totals).map(([product, qty]) => `
                <div style="display:flex;justify-content:space-between;padding:8px;background:#3d3d3d;margin-bottom:6px;border-radius:4px;">
                    <span style="font-weight:600;color:#e0e0e0;">${product}</span>
                    <span style="color:#86efac;font-weight:700;">${qty.toFixed(1)} kg</span>
                </div>
            `).join('');
        }

        function addOrderToCurrentTrip(orderId) {
            if (!currentTripId) return;
            addOrderToTrip(currentTripId, orderId);
            renderAvailableOrders(currentTripId);
            renderTripOrdersList(currentTripId);
            renderTripTotals(currentTripId);
            renderOrderTasks();
        }

        function removeOrderFromCurrentTrip(orderId) {
            if (!currentTripId) return;
            removeOrderFromTrip(currentTripId, orderId);
            renderAvailableOrders(currentTripId);
            renderTripOrdersList(currentTripId);
            renderTripTotals(currentTripId);
            renderOrderTasks();
        }

        function moveOrderUp(tripId, index) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip || index === 0) return;
            
            const newSequence = [...trip.sequence];
            [newSequence[index], newSequence[index - 1]] = [newSequence[index - 1], newSequence[index]];
            reorderTripSequence(tripId, newSequence);
            renderTripOrdersList(tripId);
        }

        function moveOrderDown(tripId, index) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip || index === trip.sequence.length - 1) return;
            
            const newSequence = [...trip.sequence];
            [newSequence[index], newSequence[index + 1]] = [newSequence[index + 1], newSequence[index]];
            reorderTripSequence(tripId, newSequence);
            renderTripOrdersList(tripId);
        }

        // Inizializza
        window.addEventListener('load', async () => {
                // Display user info
                const token = localStorage.getItem('token');
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const userInfo = document.getElementById('userInfo');
                        if (userInfo && payload.username) {
                            userInfo.textContent = `üë§ ${payload.username}`;
                        }
                    } catch (e) {
                        console.error('Error parsing token:', e);
                    }
                }
            
            // Load fresh company settings from backend
            if (window.SettingsUtils && window.SettingsUtils.loadAsync) {
                await window.SettingsUtils.loadAsync();
            }
            await loadOperators();
            await loadCSVData();
            loadOrders();
            loadOrderTasks();
            loadTrips();
            renderOrderTasks();
            renderCalendar();
            // Admin: assicura che gli ordini 'ritira' siano sincronizzati nel DB e visibili
            await syncRitiroOrdersToDb();
        });
    </script>

    <!-- Modal Assegna Task -->
    <div id="assignTaskModal" class="modal">
        <div class="modal-content" style="max-width:420px;">
            <h2 style="margin-top:0;font-size:16px;">üîß Assegna Task Ordine</h2>
            <form onsubmit="assignTaskToOperators(event)">
                <input type="hidden" id="assignTaskId">
                <div id="operatorsChecklist" style="display:flex;flex-direction:column;margin-bottom:12px;"></div>
                <div class="modal-actions" style="margin-top:10px;">
                    <button type="submit" class="btn btn-primary">üíæ Salva Assegnazione</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAssignTaskModal()">‚ùå Chiudi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestione Viaggi -->
    <div id="tripsManagerModal" class="modal">
        <div class="modal-content" style="max-width:900px;max-height:80vh;overflow-y:auto;">
            <h2>üöö Gestione Viaggi</h2>
            <button class="btn btn-primary" onclick="openCreateTripModal()" style="margin-bottom:15px;">‚ûï Nuovo Viaggio</button>
            <div id="tripsManagerList"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeTripsManager()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal Crea Viaggio -->
    <div id="createTripModal" class="modal">
        <div class="modal-content">
            <h2>‚ûï Nuovo Viaggio</h2>
            <form id="createTripForm" onsubmit="saveNewTrip(event)">
                <div class="form-group">
                    <label for="tripName">Nome Viaggio:</label>
                    <input type="text" id="tripName" required placeholder="Es: Giro Mattina">
                </div>
                <div class="form-group">
                    <label for="tripDate">Data:</label>
                    <input type="date" id="tripDate" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">üíæ Crea</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateTripModal()">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestione Ordini Viaggio -->
    <div id="tripOrdersModal" class="modal">
        <div class="modal-content" style="max-width:800px;max-height:80vh;overflow-y:auto;">
            <h2 id="tripOrdersTitle">üì¶ Gestione Ordini Viaggio</h2>
            <div style="margin:10px 0 18px 0;padding:10px;background:#2d2d2d;border-radius:6px;border:2px solid #3b82f6;">
                <p style="color:#60a5fa;font-size:13px;margin:0;">üí° <strong>Nota:</strong> L'operatore verr√† assegnato dall'admin tramite il task generato dal viaggio nella dashboard principale</p>
            </div>
            <div style="margin-bottom:15px;">
                <h3 style="font-size:16px;margin-bottom:10px;">Ordini Disponibili (consegnati):</h3>
                <div id="availableOrdersList" style="max-height:200px;overflow-y:auto;background:#3d3d3d;padding:10px;border-radius:6px;"></div>
            </div>
            <div style="margin-bottom:15px;">
                <h3 style="font-size:16px;margin-bottom:10px;">Ordini nel Viaggio:</h3>
                <div id="tripOrdersList"></div>
            </div>
            <div style="margin-top:15px;padding:15px;background:#2d2d2d;border-radius:6px;border:2px solid #16a34a;">
                <h3 style="font-size:16px;margin-bottom:10px;color:#16a34a;">üìä Totali Prodotti:</h3>
                <div id="tripTotals"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeTripOrdersModal()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>
</body>
</html>
