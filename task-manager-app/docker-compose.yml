version: '3.8'

services:
  # Servizio principale dell'applicazione
  molino-app:
    build:
      context: ..
      dockerfile: task-manager-app/Dockerfile
    container_name: molino-briganti-task-manager
    ports:
      - "5000:5000"
    environment:
      # Server
      - PORT=5000
      - NODE_ENV=production
      
      # Database - PERCORSO PERSISTENTE SUL NAS
      - DATABASE_URL=file:/data/molino/tasks.db
      
      # JWT
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-this}
      
      # Admin
      - DEFAULT_MASTER_USER=master
      - DEFAULT_MASTER_PASS=masterpass
      
      # Backup - PERCORSI PERSISTENTI SUL NAS
      - BACKUP_DIR=/data/molino/backups
      - NAS_URL=${NAS_URL:-localhost}
      - NAS_PORT=${NAS_PORT:-5001}
      - NAS_PATH=/data/molino/backups
    
    volumes:
      # Database e backups su directory persistente del NAS
      # Cambia /mnt/molino con il percorso effettivo sul tuo NAS
      - /mnt/molino/data:/data/molino:rw
      
      # Server Prisma schema
      - ./server/prisma:/app/server/prisma:ro
    
    depends_on:
      - nas-backup-server
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - molino-network
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Servizio NAS backup - espone API per backup remoti
  nas-backup-server:
    image: node:18-alpine
    container_name: molino-nas-backup-server
    working_dir: /app
    command: >
      sh -c "npm install express cors multer && 
             node -e \"
             const express = require('express');
             const cors = require('cors');
             const fs = require('fs');
             const path = require('path');
             const app = express();
             
             app.use(cors());
             app.use(express.raw({ type: 'application/octet-stream', limit: '1gb' }));
             
             const backupDir = '/data/molino/backups';
             if (!fs.existsSync(backupDir)) fs.mkdirSync(backupDir, { recursive: true });
             
             app.get('/api/backup/list', (req, res) => {
               try {
                 const files = fs.readdirSync(backupDir)
                   .filter(f => f.startsWith('db-backup-') && f.endsWith('.sql'))
                   .sort()
                   .reverse()
                   .slice(0, 20);
                 res.json({ success: true, files });
               } catch (err) {
                 res.status(500).json({ error: err.message });
               }
             });
             
             app.post('/api/backup/upload', (req, res) => {
               const name = req.headers['x-backup-name'];
               if (!name) return res.status(400).json({ error: 'Missing X-Backup-Name header' });
               try {
                 fs.writeFileSync(path.join(backupDir, name), req.body);
                 console.log('‚úÖ Backup received:', name);
                 res.json({ success: true, message: 'Backup uploaded successfully' });
               } catch (err) {
                 console.error('‚ùå Upload error:', err.message);
                 res.status(500).json({ error: err.message });
               }
             });
             
             app.get('/api/backup/download/:name', (req, res) => {
               const name = req.params.name;
               // Previeni path traversal
               if (name.includes('..') || name.includes('/')) {
                 return res.status(400).json({ error: 'Invalid filename' });
               }
               const file = path.join(backupDir, name);
               if (!fs.existsSync(file)) {
                 return res.status(404).json({ error: 'Backup not found' });
               }
               res.download(file);
             });
             
             app.get('/api/backup/status', (req, res) => {
               try {
                 const files = fs.readdirSync(backupDir).filter(f => f.startsWith('db-backup-'));
                 const stats = fs.statSync(backupDir);
                 res.json({
                   success: true,
                   backupsCount: files.length,
                   backupDir: backupDir,
                   latestBackup: files.sort().reverse()[0] || null,
                   timestamp: new Date().toISOString()
                 });
               } catch (err) {
                 res.status(500).json({ error: err.message });
               }
             });
             
             app.listen(5000, () => {
               console.log('‚úÖ NAS Backup Server running on port 5000');
               console.log('üìÅ Backup directory:', backupDir);
             });
             \"
             "
    ports:
      - "5001:5000"
    volumes:
      # Directory persistente del NAS - STESSO PERCORSO DEL CONTAINER PRINCIPALE
      - /mnt/molino/data:/data/molino:rw
    networks:
      - molino-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/api/backup/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  molino-network:
    driver: bridge
